<!doctype html> <html lang="en" class="no-js"> <head> <meta charset="utf-8"> <title>Internationalisation with Phoenix LiveView | Floor and Varnish</title> <meta name="description" content="Change your application locale without a full-page reload or having to write (much) Javascript."> <meta name="author" content="Paul Fioravanti"> <meta property="article:author" content="Paul Fioravanti"> <meta property="og:type" content="article"> <meta property="og:locale" content="en_US"> <meta property="og:site_name" content="Floor and Varnish"> <meta property="og:title" content="Internationalisation with Phoenix LiveView"> <meta property="og:url" content="https://www.paulfioravanti.com/blog/internationalisation-phoenix-liveview/"> <meta property="og:description" content="Change your application locale without a full-page reload or having to write (much) Javascript."> <meta property="og:image" content="https://www.paulfioravanti.com/assets/images/2019-11-03/nareeta-martin-vF1YCoLHMpg-unsplash.jpg"> <meta name="twitter:site" content="@paulfioravanti"> <meta name="twitter:title" content="Internationalisation with Phoenix LiveView"> <meta name="twitter:description" content="Change your application locale without a full-page reload or having to write (much) Javascript."> <meta name="twitter:url" content="https://www.paulfioravanti.com/blog/internationalisation-phoenix-liveview/"> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://www.paulfioravanti.com/assets/images/2019-11-03/nareeta-martin-vF1YCoLHMpg-unsplash.jpg"> <meta name="twitter:creator" content="@paulfioravanti"> <meta property="article:published_time" content="2019-11-03T00:00:00+11:00"> <meta property="article:modified_time" content="2020-11-01T22:00:00+11:00"> <link rel="canonical" href="https://www.paulfioravanti.com/blog/internationalisation-phoenix-liveview/"> <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Paul Fioravanti",
      "url": "https://www.paulfioravanti.com/",
      "sameAs": ["https://twitter.com/paulfioravanti","https://www.linkedin.com/in/paulfioravanti","https://github.com/paulfioravanti","https://stackoverflow.com/users/567863/paul-fioravanti"]
    
  }
</script> <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Floor and Varnish Feed"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <script>document.documentElement.className=document.documentElement.className.replace(/\bno-js\b/g,"")+" js ";</script> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"> <!--[if IE]><style>.greedy-nav .site-title{padding-right:3em}.greedy-nav button{position:absolute;top:0;right:0;height:100%}</style><![endif]--> </head> <body class="layout--single wide"> <nav class="skip-links"> <h2 class="screen-reader-text">Skip links</h2> <ul> <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li> <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li> <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li> </ul> </nav> <!--[if lt IE 9]><div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]--> <div class="masthead"> <div class="masthead__inner-wrap"> <div class="masthead__menu"> <nav id="site-nav" class="greedy-nav"> <a class="site-title" href="/"> Floor and Varnish </a> <ul class="visible-links"><li class="masthead__menu-item"> <a href="/about/">About</a> </li></ul> <button class="search__toggle" type="button"> <span class="visually-hidden">Toggle search</span> <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 15.99 16"> <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path> </svg> </button> <button class="greedy-nav__toggle hidden" type="button"> <span class="visually-hidden">Toggle menu</span> <div class="navicon"></div> </button> <ul class="hidden-links hidden"></ul> </nav> </div> </div> </div> <div class="initial-content"> <div class="page__hero--overlay" style=" background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('/assets/images/2019-11-03/nareeta-martin-vF1YCoLHMpg-unsplash.jpg');"> <div class="wrapper"> <h1 id="page-title" class="page__title" itemprop="headline"> Internationalisation with Phoenix LiveView </h1> <p class="page__lead">Change your application locale without a full-page reload or having to write (much) Javascript. </p> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-calendar-alt" aria-hidden="true"></i> <time datetime="2019-11-03T00:00:00+11:00">November 3, 2019</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-clock" aria-hidden="true"></i> 46 minute read </span> </p> <a href="https://elixirweekly.net/issues/174" style="text-decoration: none;"> <img src="https://img.shields.io/badge/Elixir%20Weekly-%23174-blueviolet.svg" alt="Elixir Weekly #174"> </a> </div> <span class="page__hero-caption">Photo by <a href="https://unsplash.com/@splashabout?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Nareeta Martin</a> on <a href="https://unsplash.com/s/photos/country-flags?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a> </span> </div> <div id="main" role="main"> <div class="sidebar sticky"> <div itemscope itemtype="https://schema.org/Person"> <div class="author__avatar"> <a href="/"> <img src="https://s.gravatar.com/avatar/abda861707b1e78e0fce47ced55f84ee" alt="Paul Fioravanti" itemprop="image"> </a> </div> <div class="author__content"> <a href="/"><h3 class="author__name" itemprop="name">Paul Fioravanti</h3></a> <div class="author__bio" itemprop="description"> <p><img class="emoji" title=":heart:" alt=":heart:" src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png" height="20" width="20"> code / <img class="emoji" title=":heart:" alt=":heart:" src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png" height="20" width="20"> languages <img class="emoji" title=":it:" alt=":it:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f1ee-1f1f9.png" height="20" width="20"> <img class="emoji" title=":jp:" alt=":jp:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f1ef-1f1f5.png" height="20" width="20"> / <img class="emoji" title=":heart:" alt=":heart:" src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png" height="20" width="20"> mech <img class="emoji" title=":keyboard:" alt=":keyboard:" src="https://github.githubassets.com/images/icons/emoji/unicode/2328.png" height="20" width="20"> / Learning stenography</p> </div> </div> <div class="author__urls-wrapper"> <button class="btn btn--inverse">Follow</button> <ul class="author__urls social-icons"> <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place"> <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Sydney, Australia</span> </li> <li> <a href="https://www.paulfioravanti.com" itemprop="url"> <i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span> </a> </li> <li> <a href="mailto:paul@paulfioravanti.com"> <meta itemprop="email" content="paul@paulfioravanti.com"> <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span> </a> </li> <li> <a href="https://twitter.com/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span> </a> </li> <li> <a href="https://www.linkedin.com/in/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span> </a> </li> <li> <a href="https://github.com/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span> </a> </li> <li> <a href="https://stackoverflow.com/users/567863/paul-fioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-stack-overflow" aria-hidden="true"></i><span class="label">Stack Overflow</span> </a> </li> </ul> </div> </div> <div id="bd_embed_signup"> <form action="https://buttondown.email/api/emails/embed-subscribe/paulfioravanti" method="post" target="popupwindow" onsubmit="window.open('https://buttondown.email/paulfioravanti', 'popupwindow')" class="embeddable-buttondown-form"> <label for="bd-email">Get notified of new posts!</label> <input type="email" name="email" id="bd-email" class="email" placeholder="email address"> <input type="hidden" value="1" name="embed"> <div class="clear"> <input type="submit" value="Subscribe" id="bd-embedded-subscribe" class="button"> </div> <p> I send email when I have new content to share. No spam; unsubscribe at any time. <a href="/privacy">Privacy Policy</a> </p> </form> </div> </div> <article class="page" itemscope itemtype="https://schema.org/CreativeWork"> <meta itemprop="headline" content="Internationalisation with Phoenix LiveView"> <meta itemprop="description" content="Change your application locale without a full-page reload or having to write (much) Javascript."> <meta itemprop="datePublished" content="2019-11-03T00:00:00+11:00"> <meta itemprop="dateModified" content="2020-11-01T22:00:00+11:00"> <div class="page__inner-wrap"> <section class="page__content" itemprop="text"> <p>This blog post is the first in a series on the creation of a small <a href="https://en.wikipedia.org/wiki/Internationalization_and_localization#Naming">I18n</a> application using <a href="https://github.com/phoenixframework/phoenix_live_view">Phoenix LiveView</a>, which updates page content based on the language chosen from a dropdown menu:</p> <ol> <li><em>Internationalisation with Phoenix LiveView</em></li> <li><em><a href="https://www.paulfioravanti.com/blog/internationalisation-with-phoenix-live-components/">Internationalisation with Phoenix LiveComponents</a></em></li> <li><em><a href="https://www.paulfioravanti.com/blog/internationalisation-with-phoenix-live-layouts/">Internationalisation with Phoenix Live Layouts</a></em></li> </ol> <p style="text-align: center;"><img src="/assets/images/2019-11-03/i18n-application.gif" alt="I18n Application" title="Internationalisation Application"></p> <p>In a previous blog post, <em><a href="https://www.paulfioravanti.com/blog/internationalisation-with-phoenix-liveview/">Runtime Language Switching in Elm</a></em>, I re-created the <a href="http://tachyons.io/">Tachyons</a> <a href="http://tachyons.io/components/layout/full-screen-centered-title/index.html">Full Screen Centered Title component documentation page</a> in <a href="http://elm-lang.org/">Elm</a>, and added a language dropdown menu to change the page language.</p> <p><img src="/assets/images/2019-11-03/tachyons-elm.gif" alt="Tachyons Elm" title="Animated GIF of Tachyons page implemented in Elm"></p> <p>The page is deployed <a href="https://elm-i18n-example.herokuapp.com/">here</a>, and you can find the code <a href="https://github.com/paulfioravanti/elm-i18n-example">here</a>, but to save a click, the animated <a href="https://en.wikipedia.org/wiki/GIF#Pronunciation_of_GIF">GIF</a> above shows all of its use cases:</p> <ul> <li>Click on the current language, and the menu opens, showing a list of selectable languages</li> <li>Click the current language again, or anywhere else on the page, and the menu closes</li> <li>If you select a different language, the language of the page content and title will change, and the list of selectable languages in the dropdown menu will update</li> <li>Refresh the page, and you will see that your choice of language is remembered</li> </ul> <p>The blog post goes through different methods I used to get internationalisation (<a href="https://en.wikipedia.org/wiki/Internationalization_and_localization#Naming">i18n</a>) working, but, in my opinion, the options in Elm as of this writing are not quite as nice as <a href="https://elixir-lang.org/">Elixir</a>’s <a href="https://www.gnu.org/software/gettext/">gettext</a>-<a href="https://github.com/elixir-gettext/gettext">based API</a>.</p> <p>However, when I have previously implemented language switching for a standard <a href="https://phoenixframework.org/">Phoenix</a> application, compared with frontend-only Elm, needing to make a request back to the server to change the application locale means that a bit more time is needed before the update is visible on screen.</p> <p>Granted, changing application locale is not something a typical user would perform very often, and so, needing a page refresh for it is probably not a pain point for anyone. But, with the advent of <a href="https://github.com/phoenixframework/phoenix_live_view">Phoenix LiveView</a>, I wondered whether I would be able to exactly replicate the snappiness of the Elm example application with Phoenix, just for fun.</p> <p>And so, the rest of this post will focus on porting over/re-creating the Elm application in Phoenix, evolving over four stages:</p> <ol> <li><a href="#client-server">Straight client-server</a></li> <li><a href="#javascript-sprinkles">Augmenting client-server with Javascript “sprinkles”</a></li> <li><a href="#javascript-takeover">Letting Javascript take over</a></li> <li><a href="#liveview">Swapping out Javascript for LiveView</a></li> </ol> <blockquote> <p>The software versions we will use to build out this application are:</p> <ul> <li>Elixir: 1.9.2</li> <li>Erlang: 22.0.7</li> <li>Phoenix: 1.4.10</li> <li>Gettext: 0.7.10</li> <li>LiveView: 0.3.1</li> <li>Node: 12.12.0</li> <li>Tachyons: 4.11.1</li> </ul> </blockquote> <p>Let’s get started!</p> <h2 id="initial-setup">Initial Setup</h2> <h3 id="no-ecto">No Ecto</h3> <p>Generate and install dependencies of a new Phoenix application. We will not be using a database, so pass in the <code class="language-plaintext highlighter-rouge">--no-ecto</code> flag to make sure we do not generate any unneeded <a href="https://github.com/elixir-ecto/ecto">Ecto</a> configuration:</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix phx.new phx_i18n_example --no-ecto
cd phx_i18n_example
mix deps.get
</code></pre></div></div> <h3 id="gettext">Gettext</h3> <p>Next, we will need to tell Gettext about what locales we want to use in the application (in our case English, Italian, and Japanese), and what locale should be the default (English). Add the following lines to your configuration:</p> <p><strong><code class="language-plaintext highlighter-rouge">config/config.exs</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span> <span class="ss">:phx_i18n_example</span><span class="p">,</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Gettext</span><span class="p">,</span>
  <span class="ss">default_locale:</span> <span class="s2">"en"</span><span class="p">,</span>
  <span class="ss">locales:</span> <span class="sx">~w(en it ja)</span>
</code></pre></div></div> <h3 id="tachyons">Tachyons</h3> <p>Since we will use Tachyons for styling, we have to install it and make it available in Phoenix.</p> <p>First, install it with <a href="https://www.npmjs.com/">npm</a>:</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install --save-dev tachyons@4.11.1 --prefix assets
</code></pre></div></div> <p>Then, <code class="language-plaintext highlighter-rouge">import</code> it into Phoenix:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/js/app.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>
<span class="c1">// import css from "../css/app.css"</span>
<span class="c1">// ...</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">phoenix_html</span><span class="dl">"</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">tachyons</span><span class="dl">"</span>
<span class="c1">// ...</span>
</code></pre></div></div> <p>Make sure you also comment out or remove the default Phoenix-generated <code class="language-plaintext highlighter-rouge">import css from "../css/app.css"</code> line since we will not be using those default styles, and we do not want anything in <code class="language-plaintext highlighter-rouge">app.css</code> to overwrite Tachyons styling.</p> <h2 id="client-server">Client-Server</h2> <h3 id="dealing-with-params">Dealing with Params</h3> <p>For this first development step, the goal will be to go as far as we can in building out the main use cases of the application using just Phoenix, and no <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript">Javascript</a>. This means we will have to start using <a href="https://en.wikipedia.org/wiki/Query_string">URL parameters</a> to send information to the server in order to tell it about the desired state of the application.</p> <p>For example, if we want the locale to be Japanese, we could send a <code class="language-plaintext highlighter-rouge">locale</code> URL parameter to tell the application to switch to Japanese:</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:4000/?locale=ja
</code></pre></div></div> <p>Since we are not using Javascript, we will also have to use URL parameters to let the application know if we want to open or close the locale dropdown menu:</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:4000/?show_available_locales=true
http://localhost:4000/?show_available_locales=false
</code></pre></div></div> <p>I think the best way for dealing with these parameters as they come in to the application is to use a <a href="https://github.com/elixir-plug/plug">Plug</a>, so let’s add a <code class="language-plaintext highlighter-rouge">LocalePlug</code> to our <code class="language-plaintext highlighter-rouge">:browser</code> <a href="https://hexdocs.pm/phoenix/routing.html#pipelines">pipeline</a>:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/router.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">PhxI18nExampleWeb</span><span class="p">,</span> <span class="ss">:router</span>
  <span class="n">alias</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LocalePlug</span>

  <span class="n">pipeline</span> <span class="ss">:browser</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">plug</span> <span class="no">LocalePlug</span>
  <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div> <p>We need this <code class="language-plaintext highlighter-rouge">LocalePlug</code> to do the following:</p> <ul> <li>Fetch and set the locale: <ul> <li>First, check the parameters for the locale</li> <li>If it cannot be found in the parameters, check the browser cookies</li> <li>If it cannot be found in the browser cookies, return the default locale</li> <li>Update the global application locale to the retrieved locale value, but only if that locale value is actually different to the global application locale</li> </ul> </li> <li>Determine the dropdown menu state: <ul> <li>If the parameters have a <code class="language-plaintext highlighter-rouge">show_available_locales=true</code> value, indicate that the dropdown should be open</li> <li>If there is any other value for <code class="language-plaintext highlighter-rouge">show_available_locales</code>, including <code class="language-plaintext highlighter-rouge">false</code>, or if <code class="language-plaintext highlighter-rouge">show_available_locales</code> is not present in the params, the dropdown should display as closed</li> </ul> </li> <li>Persist the locale in the cookies <ul> <li>If the locale value is already stored in the cookie, do nothing</li> <li>Otherwise, if the cookie value is different from the locale value, or the cookie value is not present, store the locale value in the cookie</li> </ul> </li> </ul> <p>Let’s see what this looks like in code:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/plugs/locale_plug.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LocalePlug</span> <span class="k">do</span>
  <span class="n">alias</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span>
  <span class="nv">@behaviour</span> <span class="no">Plug</span>

  <span class="nv">@locales</span> <span class="no">Gettext</span><span class="o">.</span><span class="n">known_locales</span><span class="p">(</span><span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Gettext</span><span class="p">)</span>
  <span class="nv">@cookie</span> <span class="s2">"phxi18nexamplelanguage"</span>
  <span class="nv">@ten_days</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>

  <span class="k">defguard</span> <span class="n">known_locale?</span><span class="p">(</span><span class="n">locale</span><span class="p">)</span> <span class="ow">when</span> <span class="n">locale</span> <span class="ow">in</span> <span class="nv">@locales</span>

  <span class="nv">@impl</span> <span class="no">Plug</span>
  <span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">_opts</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">nil</span>

  <span class="nv">@impl</span> <span class="no">Plug</span>
  <span class="k">def</span> <span class="n">call</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_opts</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">locale</span> <span class="o">=</span> <span class="n">fetch_and_set_locale</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

    <span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="n">determine_language_dropdown_state</span><span class="p">()</span>
    <span class="o">|&gt;</span> <span class="n">persist_locale</span><span class="p">(</span><span class="n">locale</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">fetch_and_set_locale</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">case</span> <span class="n">locale_from_params</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="o">||</span> <span class="n">locale_from_cookies</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">nil</span> <span class="o">-&gt;</span>
        <span class="c1"># This will fallback to the default locale set in `config.exs`</span>
        <span class="no">Gettext</span><span class="o">.</span><span class="n">get_locale</span><span class="p">()</span>

      <span class="n">locale</span> <span class="o">-&gt;</span>
        <span class="c1"># Update the global locale only if the `locale` value</span>
        <span class="c1"># is different to it</span>
        <span class="k">if</span> <span class="n">locale</span> <span class="o">!=</span> <span class="no">Gettext</span><span class="o">.</span><span class="n">get_locale</span><span class="p">()</span> <span class="k">do</span>
          <span class="no">Gettext</span><span class="o">.</span><span class="n">put_locale</span><span class="p">(</span><span class="n">locale</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">locale</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">locale_from_params</span><span class="p">(%</span><span class="no">Conn</span><span class="p">{</span><span class="ss">params:</span> <span class="p">%{</span><span class="s2">"locale"</span> <span class="o">=&gt;</span> <span class="n">locale</span><span class="p">}})</span>
       <span class="ow">when</span> <span class="n">known_locale?</span><span class="p">(</span><span class="n">locale</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">locale</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">locale_from_params</span><span class="p">(</span><span class="n">_conn</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">nil</span>

  <span class="k">defp</span> <span class="n">locale_from_cookies</span><span class="p">(%</span><span class="no">Conn</span><span class="p">{</span><span class="ss">cookies:</span> <span class="p">%{</span><span class="nv">@cookie</span> <span class="o">=&gt;</span> <span class="n">locale</span><span class="p">}})</span>
       <span class="ow">when</span> <span class="n">known_locale?</span><span class="p">(</span><span class="n">locale</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">locale</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">locale_from_cookies</span><span class="p">(</span><span class="n">_conn</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">nil</span>

  <span class="k">defp</span> <span class="n">determine_language_dropdown_state</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">show_available_languages</span> <span class="o">=</span>
      <span class="k">case</span> <span class="n">conn</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">"show_available_locales"</span><span class="p">]</span> <span class="k">do</span>
        <span class="s2">"true"</span> <span class="o">-&gt;</span>
          <span class="no">true</span>

        <span class="n">_</span> <span class="o">-&gt;</span>
          <span class="c1"># `false`, `nil`, `blah` etc</span>
          <span class="no">false</span>
      <span class="k">end</span>

    <span class="no">Conn</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="ss">:show_available_locales</span><span class="p">,</span> <span class="n">show_available_languages</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">persist_locale</span><span class="p">(%</span><span class="no">Conn</span><span class="p">{</span><span class="ss">cookies:</span> <span class="p">%{</span><span class="nv">@cookie</span> <span class="o">=&gt;</span> <span class="n">locale</span><span class="p">}}</span> <span class="o">=</span> <span class="n">conn</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># Cookie locale is the same as the current locale, so do nothing and just</span>
    <span class="c1"># return the original `conn`</span>
    <span class="n">conn</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">persist_locale</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Conn</span><span class="o">.</span><span class="n">put_resp_cookie</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="nv">@cookie</span><span class="p">,</span> <span class="n">locale</span><span class="p">,</span> <span class="ss">max_age:</span> <span class="nv">@ten_days</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>A few notes on this Plug file:</p> <ul> <li>We are using <a href="https://hexdocs.pm/gettext/Gettext.html#get_locale/0"><code class="language-plaintext highlighter-rouge">Gettext.get_locale/0</code></a> as the source of truth for the application locale. It “gets the global Gettext locale for the current process”, and since we’re doing a single process client-server implementation, it suits our purposes. There is no need to <code class="language-plaintext highlighter-rouge">assign</code> a separate <code class="language-plaintext highlighter-rouge">locale</code> value in the <code class="language-plaintext highlighter-rouge">conn</code>: whenever we want the application locale, we will ask Gettext to provide it to us</li> <li>We are following Elixir’s rule of thumb and deliberately using <code class="language-plaintext highlighter-rouge">||</code>, and not <code class="language-plaintext highlighter-rouge">or</code>, in <code class="language-plaintext highlighter-rouge">fetch_and_set_locale/1</code>, since the values returned on either side are non-boolean</li> <li>Having the cookie be valid for ten days is completely arbitrary. Feel free to change as you see fit</li> </ul> <h3 id="from-route-to-template">From Route to Template</h3> <p>Now that we have our application state set up, our flow from here towards the view layer is exactly as Phoenix provides out-of-the-box:</p> <p>The root path gets routed to the <code class="language-plaintext highlighter-rouge">PageController</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/router.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">PhxI18nExampleWeb</span><span class="p">,</span> <span class="ss">:router</span>
  <span class="n">alias</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LocalePlug</span>

  <span class="n">pipeline</span> <span class="ss">:browser</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">plug</span> <span class="no">LocalePlug</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="n">scope</span> <span class="s2">"/"</span><span class="p">,</span> <span class="no">PhxI18nExampleWeb</span> <span class="k">do</span>
    <span class="n">pipe_through</span> <span class="ss">:browser</span>
    <span class="n">get</span> <span class="s2">"/"</span><span class="p">,</span> <span class="no">PageController</span><span class="p">,</span> <span class="ss">:index</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Then, the <code class="language-plaintext highlighter-rouge">PageController</code> renders the <code class="language-plaintext highlighter-rouge">index.html</code> template:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/controllers/page_controller.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">PageController</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">PhxI18nExampleWeb</span><span class="p">,</span> <span class="ss">:controller</span>

  <span class="k">def</span> <span class="n">index</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">render</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">"index.html"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>…which we need to change to the following code:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/page/index.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">article</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= article() %&gt;"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= heading_container() %&gt;"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">h1</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= heading() %&gt;"</span><span class="o">&gt;</span>
      <span class="o">&lt;%=</span> <span class="n">gettext</span><span class="p">(</span><span class="s2">"Vertically centering things in css is easy!"</span><span class="p">)</span> <span class="p">%</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">article</span><span class="o">&gt;</span>
</code></pre></div></div> <ul> <li>The Phoenix-generated <code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/gettext.ex</code> file enables us to use a <code class="language-plaintext highlighter-rouge">gettext</code> macro to search for translated strings depending on the Gettext locale setting. We do not have any translations at the moment, so this call will just return the “Vertically centering things in css is easy!” string itself (we will get to generating translations later)</li> <li>All the functions that you see interpolated in the various tag <code class="language-plaintext highlighter-rouge">class</code> attribute values exist to make it easier for us to manage sets of Tachyons utility classes</li> </ul> <h3 id="modules-specifically-for-styling">Modules Specifically for Styling</h3> <p>Functions declared without qualified module names in templates will be attempted to be resolved in the view that renders them, which, in <code class="language-plaintext highlighter-rouge">index.html.eex</code>’s case, as per Phoenix convention, is the <code class="language-plaintext highlighter-rouge">PageView</code>.</p> <p>Since the functions that are being referenced here will all thematically relate to styling, and be quite verbose, I think we should put them inside their own specific “style” modules, and have <code class="language-plaintext highlighter-rouge">PageView</code> delegate to them. This, to me at least, makes the <code class="language-plaintext highlighter-rouge">PageView</code> explicitly say:</p> <blockquote> <p>“I know I am meant to respond to these functions, but their details are not my responsibility, so please go and look in this other module”</p> </blockquote> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/views/page_view.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">PageView</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">PhxI18nExampleWeb</span><span class="p">,</span> <span class="ss">:view</span>
  <span class="n">alias</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">PageStyle</span>

  <span class="k">defdelegate</span> <span class="n">article</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">PageStyle</span>
  <span class="k">defdelegate</span> <span class="n">heading</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">PageStyle</span>
  <span class="k">defdelegate</span> <span class="n">heading_container</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">PageStyle</span>
<span class="k">end</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/views/styles/page_style.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">PageStyle</span> <span class="k">do</span>
  <span class="nv">@article_classes</span> <span class="sx">~w[
    dt
    vh-75
    w-100
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@heading_container_classes</span> <span class="sx">~w[
    dtc
    ph-3 ph4-l
    tc
    v-mid
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@heading_classes</span> <span class="sx">~w[
    f6 f2-m f-subheadline-l
    fw6
    tc
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="k">def</span> <span class="n">article</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@article_classes</span>
  <span class="k">def</span> <span class="n">heading_container</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@heading_container_classes</span>
  <span class="k">def</span> <span class="n">heading</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@heading_classes</span>
<span class="k">end</span>
</code></pre></div></div> <ul> <li>In order to make the Tachyons mnemonics easier to manage, they are in lists contained in module attributes, which get joined into a single string at compile time</li> <li>The attributes are then wrapped in functions so they become a part of the module’s public interface</li> </ul> <p>I think this is a nicer way to deal with CSS utility classes, rather than modify them directly in a template. But, as with any subjective opinion, your mileage may vary.</p> <h3 id="page-layout">Page Layout</h3> <p>Now, every template gets rendered inside of a layout, so let’s look at the main application layout next, and mark where we will make changes from the Phoenix-generated defaults:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/layout/app.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">!DOCTYPE</span> <span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="n">title</span><span class="err">&gt;</span><span class="o">&lt;%=</span> <span class="n">gettext</span><span class="p">(</span><span class="s2">"Multilingualisation in Phoenix"</span><span class="p">)</span> <span class="p">%</span><span class="err">&gt;</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
  <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">body</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= body() %&gt;"</span><span class="o">&gt;</span>
    <span class="o">&lt;%=</span> <span class="n">render</span> <span class="no">LanguageDropdownView</span><span class="p">,</span>
               <span class="s2">"language_dropdown.html"</span><span class="p">,</span>
               <span class="ss">show_available_locales:</span> <span class="nv">@show_available_locales</span> <span class="p">%</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">main</span> <span class="n">role</span><span class="o">=</span><span class="s2">"main"</span><span class="o">&gt;</span>
      <span class="o">&lt;%=</span> <span class="n">render</span> <span class="nv">@view_module</span><span class="p">,</span> <span class="nv">@view_template</span><span class="p">,</span> <span class="n">assigns</span> <span class="p">%</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">main</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
  <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</code></pre></div></div> <p>Like the <code class="language-plaintext highlighter-rouge">index.html.eex</code> template, the <code class="language-plaintext highlighter-rouge">&lt;title&gt;</code> uses the <code class="language-plaintext highlighter-rouge">gettext</code> macro to get its translation, and the <code class="language-plaintext highlighter-rouge">&lt;body&gt;</code> calls out to a <code class="language-plaintext highlighter-rouge">body/0</code> view function in <code class="language-plaintext highlighter-rouge">LayoutView</code> to fetch its Tachyons style classes:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/views/layout_view.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LayoutView</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">PhxI18nExampleWeb</span><span class="p">,</span> <span class="ss">:view</span>
  <span class="n">alias</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="p">{</span><span class="no">LanguageDropdownView</span><span class="p">,</span> <span class="no">LayoutStyle</span><span class="p">}</span>

  <span class="k">defdelegate</span> <span class="n">body</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">LayoutStyle</span>
<span class="k">end</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/views/styles/layout_style.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LayoutStyle</span> <span class="k">do</span>
  <span class="nv">@body_classes</span> <span class="sx">~w[
    bg-dark-pink
    overflow-container
    pt3
    sans-serif
    vh-100
    white
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="k">def</span> <span class="n">body</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@body_classes</span>
<span class="k">end</span>
</code></pre></div></div> <h3 id="language-dropdown-menu">Language Dropdown Menu</h3> <p>Above the <code class="language-plaintext highlighter-rouge">main</code> section of <code class="language-plaintext highlighter-rouge">app.html.eex</code>, within which in this case <code class="language-plaintext highlighter-rouge">index.html.eex</code> is rendered, we render a separate view and template for the locale dropdown, passing in a <code class="language-plaintext highlighter-rouge">@show_available_locales</code> value, available here as a module attribute due to <code class="language-plaintext highlighter-rouge">show_available_locales</code> being <code class="language-plaintext highlighter-rouge">assign</code>ed in the <code class="language-plaintext highlighter-rouge">Plug.Conn</code> in <code class="language-plaintext highlighter-rouge">LocalePlug</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/language_dropdown/language_dropdown.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= dropdown_container() %&gt;"</span><span class="o">&gt;</span>
  <span class="o">&lt;%=</span> <span class="n">render</span> <span class="no">LanguageDropdownView</span><span class="p">,</span>
             <span class="s2">"_current_locale_link.html"</span><span class="p">,</span>
             <span class="ss">show_available_locales:</span> <span class="nv">@show_available_locales</span> <span class="p">%</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">ul</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= dropdown_list(@show_available_locales) %&gt;"</span><span class="o">&gt;</span>
    <span class="o">&lt;%=</span> <span class="n">render_many</span> <span class="n">selectable_locales</span><span class="p">(),</span>
                    <span class="no">LanguageDropdownView</span><span class="p">,</span>
                    <span class="s2">"_locale_link.html"</span><span class="p">,</span>
                    <span class="ss">as:</span> <span class="ss">:locale</span> <span class="p">%</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</code></pre></div></div> <p>Using the same <code class="language-plaintext highlighter-rouge">LanguageDropdownView</code>, we render two partial templates:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">_current_locale_link.html</code>, passing in the <code class="language-plaintext highlighter-rouge">@show_available_locales</code> value we received from <code class="language-plaintext highlighter-rouge">app.html.eex</code> </li> <li> <code class="language-plaintext highlighter-rouge">_locale_link.html</code>, which we are rendering for each of the non-current selectable locales, which we get from the <code class="language-plaintext highlighter-rouge">selectable_locales/0</code> function, using <a href="https://hexdocs.pm/phoenix/Phoenix.View.html#render_many/4"><code class="language-plaintext highlighter-rouge">Phoenix.View.render_many/4</code></a> </li> </ul> <p>Let’s have a look at each of the partial templates:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/language_dropdown/_current_locale_link.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">"?show_available_locales=&lt;%= !@show_available_locales %&gt;"</span>
   <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= current_selection_link() %&gt;"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">p</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= current_selection(@show_available_locales) %&gt;"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">span</span><span class="err">&gt;</span><span class="o">&lt;%=</span> <span class="n">current_locale_string</span><span class="p">()</span> <span class="p">%</span><span class="err">&gt;</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= caret() %&gt;"</span><span class="o">&gt;</span><span class="err">▾</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</code></pre></div></div> <ul> <li>The <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code> tag here links to the opposite value of whatever the passed-in <code class="language-plaintext highlighter-rouge">@show_available_locales</code> value is, so that we can implement a toggle-like action</li> <li>The styling of the dropdown is dependant on the value in <code class="language-plaintext highlighter-rouge">@show_available_locales</code>, which gets passed into the <code class="language-plaintext highlighter-rouge">current_selection/1</code> function</li> </ul> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/language_dropdown/_locale_link.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">"?locale=&lt;%= @locale %&gt;"</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= dropdown_list_item_link() %&gt;"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= dropdown_list_item() %&gt;"</span><span class="o">&gt;</span>
    <span class="o">&lt;%=</span> <span class="n">locale_string</span><span class="p">(</span><span class="nv">@locale</span><span class="p">)</span> <span class="p">%</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</code></pre></div></div> <ul> <li>The <code class="language-plaintext highlighter-rouge">@locale</code> attribute comes from the <code class="language-plaintext highlighter-rouge">as: :locale</code> option used in the <code class="language-plaintext highlighter-rouge">render_many/4</code> function in <code class="language-plaintext highlighter-rouge">language_dropdown.html.eex</code>: each locale from the <code class="language-plaintext highlighter-rouge">selectable_locales/0</code> function (see below) that is passed in to the partial is referenced as <code class="language-plaintext highlighter-rouge">@locale</code> </li> <li>The <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code> tag here links to its own locale as the target locale</li> <li>Displays the humanised version of the locale (eg locale <code class="language-plaintext highlighter-rouge">"en"</code> displays as “English”)</li> </ul> <p>All the functions in the previous two partial templates are contained in the <code class="language-plaintext highlighter-rouge">LanguageDropdownView</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/views/language_dropdown_view.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownView</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">PhxI18nExampleWeb</span><span class="p">,</span> <span class="ss">:view</span>
  <span class="n">alias</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownStyle</span>
  <span class="n">alias</span> <span class="bp">__MODULE__</span><span class="p">,</span> <span class="ss">as:</span> <span class="no">LanguageDropdownView</span>

  <span class="nv">@locales</span> <span class="no">Gettext</span><span class="o">.</span><span class="n">known_locales</span><span class="p">(</span><span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Gettext</span><span class="p">)</span>
  <span class="nv">@locale_strings</span> <span class="p">%{</span>
    <span class="s2">"en"</span> <span class="o">=&gt;</span> <span class="s2">"English"</span><span class="p">,</span>
    <span class="s2">"it"</span> <span class="o">=&gt;</span> <span class="s2">"Italiano"</span><span class="p">,</span>
    <span class="s2">"ja"</span> <span class="o">=&gt;</span> <span class="s2">"日本語"</span>
  <span class="p">}</span>

  <span class="k">defdelegate</span> <span class="n">caret</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>
  <span class="k">defdelegate</span> <span class="n">current_selection</span><span class="p">(</span><span class="n">show_available_locales</span><span class="p">),</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>
  <span class="k">defdelegate</span> <span class="n">current_selection_link</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>
  <span class="k">defdelegate</span> <span class="n">dropdown_container</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>
  <span class="k">defdelegate</span> <span class="n">dropdown_list</span><span class="p">(</span><span class="n">show_available_locales</span><span class="p">),</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>
  <span class="k">defdelegate</span> <span class="n">dropdown_list_item</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>
  <span class="k">defdelegate</span> <span class="n">dropdown_list_item_link</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>

  <span class="k">def</span> <span class="n">locale_string</span><span class="p">(</span><span class="n">locale</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@locale_strings</span><span class="p">[</span><span class="n">locale</span><span class="p">]</span>
  <span class="k">def</span> <span class="n">current_locale_string</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">locale_string</span><span class="p">(</span><span class="no">Gettext</span><span class="o">.</span><span class="n">get_locale</span><span class="p">())</span>
  <span class="k">def</span> <span class="n">selectable_locales</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="no">List</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nv">@locales</span><span class="p">,</span> <span class="no">Gettext</span><span class="o">.</span><span class="n">get_locale</span><span class="p">())</span>
<span class="k">end</span>
</code></pre></div></div> <ul> <li>The Tachyons style-related functions are all delegated off to this view’s style module, <code class="language-plaintext highlighter-rouge">LanguageDropdownStyle</code> </li> <li>The <code class="language-plaintext highlighter-rouge">locale_string/1</code> and <code class="language-plaintext highlighter-rouge">current_locale_string/0</code> functions simply perform a lookup of the <code class="language-plaintext highlighter-rouge">@locale_strings</code> map to get the value to show in the menu: note that these strings are static, and the menu itself is not internationalised at all</li> <li>Notice that the <code class="language-plaintext highlighter-rouge">current_locale_string/0</code> function immediately calls the <code class="language-plaintext highlighter-rouge">locale_string/1</code> function, passing in the result of the <code class="language-plaintext highlighter-rouge">Gettext.get_locale/0</code> function as a parameter: we are always using Gettext as the source of truth for the application locale</li> <li>In the same way, to get the list of selectable locales to populate the locale menu, we are subtracting the current locale from the list of known locales that we configured in <code class="language-plaintext highlighter-rouge">config.exs</code> </li> </ul> <p>The <code class="language-plaintext highlighter-rouge">LanguageDropdownStyle</code> module contains the following:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/views/styles/language_dropdown_style.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownStyle</span> <span class="k">do</span>
  <span class="nv">@caret_classes</span> <span class="sx">~w[
    absolute
    ml2
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@current_selection_classes</span> <span class="sx">~w[
    b--white
    ba
    br2
    pa2
    pointer
    tc
    w4
  ]</span>

  <span class="nv">@current_selection_border_radius_classes</span> <span class="s2">"br--top"</span>

  <span class="nv">@current_selection_link_classes</span> <span class="sx">~w[
    no-underline
    white
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@dropdown_container_classes</span> <span class="sx">~w[
    center
    f3
    flex
    h3
    items-center
    justify-end
    w-90
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@dropdown_list_classes</span> <span class="sx">~w[
    absolute
    b--white
    bb
    bl
    br
    br--bottom
    br2
    items-center
    list
    mt5
    pl0
    pointer
    pr0
    pt1
    tc
    top-0
    w4
  ]</span>

  <span class="nv">@dropdown_show_classes</span> <span class="sx">~w[
    flex
    flex-column
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@dropdown_hide_classes</span> <span class="s2">"dn"</span>

  <span class="nv">@dropdown_list_item_classes</span> <span class="sx">~w[
    hover-bg-white
    hover-dark-pink
    ph1
    pv2
    pt0
    w-100
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@dropdown_list_item_link_classes</span> <span class="sx">~w[
    no-underline
    w-100
    white
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="k">def</span> <span class="n">caret</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@caret_classes</span>

  <span class="k">def</span> <span class="n">current_selection</span><span class="p">(</span><span class="n">show_available_locales</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">display_classes</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">show_available_locales</span> <span class="k">do</span>
        <span class="p">[</span><span class="nv">@current_selection_border_radius_classes</span> <span class="o">|</span> <span class="nv">@current_selection_classes</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="nv">@current_selection_classes</span>
      <span class="k">end</span>

    <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">display_classes</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">current_selection_link</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@current_selection_link_classes</span>

  <span class="k">def</span> <span class="n">dropdown_container</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@dropdown_container_classes</span>

  <span class="k">def</span> <span class="n">dropdown_list</span><span class="p">(</span><span class="n">show_available_locales</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">display_classes</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">show_available_locales</span> <span class="k">do</span>
        <span class="p">[</span><span class="nv">@dropdown_show_classes</span> <span class="o">|</span> <span class="nv">@dropdown_list_classes</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="p">[</span><span class="nv">@dropdown_hide_classes</span> <span class="o">|</span> <span class="nv">@dropdown_list_classes</span><span class="p">]</span>
      <span class="k">end</span>

    <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">display_classes</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">dropdown_list_item</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@dropdown_list_item_classes</span>
  <span class="k">def</span> <span class="n">dropdown_list_item_link</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@dropdown_list_item_link_classes</span>
<span class="k">end</span>
</code></pre></div></div> <p>You can see that things here are quite verbose, and hence extracting these functions out into their own module creates a hard concern barrier between style-related functions, and other utility-like functions that are typically needed in view modules.</p> <h3 id="generate-translations">Generate Translations</h3> <p>Now that we know all of the two places where we need the <code class="language-plaintext highlighter-rouge">gettext</code> macro, we can generate translation placeholders for all of our known locales using the following commands:</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix gettext.extract
mix gettext.merge priv/gettext --locale en
mix gettext.merge priv/gettext --locale it
mix gettext.merge priv/gettext --locale ja
</code></pre></div></div> <p>Now that we have our locale placeholders, let’s put some translations in them! The English locale file can be left as-is:</p> <p><strong><code class="language-plaintext highlighter-rouge">priv/gettext/en/LC_MESSAGES/default.po</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>

<span class="c1">#, elixir-format</span>
<span class="c1">#: lib/phx_i18n_example_web/templates/layout/app.html.eex:7</span>
<span class="n">msgid</span> <span class="s2">"Multilingualisation in Phoenix"</span>
<span class="n">msgstr</span> <span class="s2">""</span>

<span class="c1">#, elixir-format</span>
<span class="c1">#: lib/phx_i18n_example_web/templates/page/index.html.eex:4</span>
<span class="n">msgid</span> <span class="s2">"Vertically centering things in css is easy!"</span>
<span class="n">msgstr</span> <span class="s2">""</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">priv/gettext/it/LC_MESSAGES/default.po</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>

<span class="c1">#, elixir-format</span>
<span class="c1">#: lib/phx_i18n_example_web/templates/layout/app.html.eex:7</span>
<span class="n">msgid</span> <span class="s2">"Multilingualisation in Phoenix"</span>
<span class="n">msgstr</span> <span class="s2">"Multilingualizzazione in Phoenix"</span>

<span class="c1">#, elixir-format</span>
<span class="c1">#: lib/phx_i18n_example_web/templates/page/index.html.eex:4</span>
<span class="n">msgid</span> <span class="s2">"Vertically centering things in css is easy!"</span>
<span class="n">msgstr</span> <span class="s2">"Centrare verticalmente con css è facile!"</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">priv/gettext/ja/LC_MESSAGES/default.po</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>

<span class="c1">#, elixir-format</span>
<span class="c1">#: lib/phx_i18n_example_web/templates/layout/app.html.eex:7</span>
<span class="n">msgid</span> <span class="s2">"Multilingualisation in Phoenix"</span>
<span class="n">msgstr</span> <span class="s2">"Phoenixにおける多言語化"</span>

<span class="c1">#, elixir-format</span>
<span class="c1">#: lib/phx_i18n_example_web/templates/page/index.html.eex:4</span>
<span class="n">msgid</span> <span class="s2">"Vertically centering things in css is easy!"</span>
<span class="n">msgstr</span> <span class="s2">"CSSで垂直センタリングは簡単だよ！"</span>
</code></pre></div></div> <p>And now, when you change your locale, you should see the language change on the page content, as well as the page title!</p> <p><img src="/assets/images/2019-11-03/01-client-server.gif" alt="01-client-server Implementation" title="Client-Server Implementation"></p> <p>You can find the code for this iteration of the application in this post’s <a href="https://github.com/paulfioravanti/phx_i18n_example">companion Github repo</a> on the <a href="https://github.com/paulfioravanti/phx_i18n_example/tree/01-client-server"><code class="language-plaintext highlighter-rouge">01-client-server</code> branch</a>. The branch is also deployed <a href="https://phx-i18n-01-client-server.herokuapp.com/">here</a> in its own environment.</p> <h3 id="client-server-issues">Client-Server Issues</h3> <p>So, we have language switching working, but what is wrong here?</p> <ul> <li>It takes time to open and close the menu, and to change locale, since we are doing a round trip to the server</li> <li>We cannot make the menu close if we click elsewhere on the page, since we cannot use Javascript <a href="https://developer.mozilla.org/en-US/docs/Web/API/GlobalEventHandlers/onclick"><code class="language-plaintext highlighter-rouge">onclick</code></a> handlers. We also cannot make the entire <code class="language-plaintext highlighter-rouge">&lt;body&gt;</code> content a link, since we would have the dropdown links inside that body content link, and <a href="https://developer.mozilla.org/en-US/docs/Web/HTML">HTML</a> <a href="https://www.w3.org/TR/html401/struct/links.html#h-12.2.2">does not do nested links</a>.</li> </ul> <p>Since we are missing a use case from the Elm implementation, let’s compromise and allow some Javascript “sprinkles” into the application.</p> <h2 id="javascript-sprinkles">Javascript Sprinkles</h2> <p>For this next step, aside from introducing some Javascript code, the main functionality of the application will not change very much.</p> <h3 id="add-tag-metadata">Add Tag Metadata</h3> <p>We will need to allow Javascript to target certain page elements in order to manipulate them or perform some other actions, and that will take the form of adding some <code class="language-plaintext highlighter-rouge">id</code>s and <code class="language-plaintext highlighter-rouge">roles</code> to tags. So, let’s open up the following files and make those small changes:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/layout/app.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
  <span class="o">&lt;</span><span class="n">body</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= body() %&gt;"</span> <span class="n">id</span><span class="o">=</span><span class="s2">"body"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
  <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/language_dropdown/language_dropdown.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">ul</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= dropdown_list(@show_available_locales) %&gt;"</span> <span class="n">id</span><span class="o">=</span><span class="s2">"locale_dropdown"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
<span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/language_dropdown/_current_locale_link.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">"?show_available_locales=&lt;%= !@show_available_locales %&gt;"</span>
   <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= current_selection_link() %&gt;"</span>
   <span class="n">id</span><span class="o">=</span><span class="s2">"current_locale_link"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">p</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= current_selection(@show_available_locales) %&gt;"</span> <span class="n">id</span><span class="o">=</span><span class="s2">"current_locale"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
  <span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/language_dropdown/_locale_link.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">"?locale=&lt;%= @locale %&gt;"</span>
   <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= dropdown_list_item_link() %&gt;"</span>
   <span class="n">role</span><span class="o">=</span><span class="s2">"locale_link"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
<span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</code></pre></div></div> <h3 id="add-javascript">Add Javascript</h3> <p>Now, in the main Javascript entry point for a Phoenix application, we are going to add a click-handler to the <code class="language-plaintext highlighter-rouge">&lt;body&gt;</code> that tells the dropdown to hide itself:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/js/app.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>
<span class="c1">// Import local files</span>
<span class="c1">//</span>
<span class="c1">// Local files can be imported directly using relative paths, for example:</span>
<span class="c1">// import socket from "./socket"</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">LocaleDropdown</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./locale_dropdown</span><span class="dl">"</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">body</span><span class="dl">"</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">LocaleDropdown</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div> <p>I prefer Javascript with an interface that looks like it follows an Elixir-like <code class="language-plaintext highlighter-rouge">Module.function()</code> convention. This was able to be done using an Immediately Invoked Function Expression (<a href="https://developer.mozilla.org/en-US/docs/Glossary/IIFE">IIFE</a>; pronounced “iffy”) that returns an <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Working_with_Objects">object</a> containing functions in its values:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/js/locale_dropdown.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="p">{</span> <span class="nx">LocaleDropdown</span> <span class="p">}</span>

<span class="kd">const</span> <span class="nx">LocaleDropdown</span> <span class="o">=</span> <span class="p">((</span><span class="nb">document</span><span class="p">,</span> <span class="nb">window</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">LOCALE_DROPDOWN_CLASSES</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">locale_dropdown</span><span class="dl">"</span><span class="p">).</span><span class="nx">classList</span>
  <span class="kd">const</span> <span class="nx">CURRENT_LOCALE_CLASSES</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">current_locale</span><span class="dl">"</span><span class="p">).</span><span class="nx">classList</span>
  <span class="kd">const</span> <span class="nx">CURRENT_LOCALE_LINK</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">current_locale_link</span><span class="dl">"</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">LOCALE_DROPDOWN_LINKS</span> <span class="o">=</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">[role="locale_link"], #current_locale_link</span><span class="dl">'</span><span class="p">)</span>

  <span class="c1">// REF: https://tachyons.io/docs/table-of-styles/</span>
  <span class="kd">const</span> <span class="nx">TOP_BORDER_RADIUS_ONLY</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">br--top</span><span class="dl">"</span>
  <span class="kd">const</span> <span class="nx">DROPDOWN_VISIBLE_CLASSES</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">flex</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">flex-column</span><span class="dl">"</span><span class="p">]</span>
  <span class="kd">const</span> <span class="nx">DROPDOWN_HIDDEN_CLASS</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">dn</span><span class="dl">"</span>

  <span class="nx">initLocaleDropdownLinks</span><span class="p">()</span>

  <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">({</span>
    <span class="na">hide</span><span class="p">:</span> <span class="nx">hide</span>
  <span class="p">})</span>

  <span class="kd">function</span> <span class="nx">initLocaleDropdownLinks</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">LOCALE_DROPDOWN_LINKS</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">link</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// NOTE: Prevent propagation to the onclick handler for the `body` tag.</span>
      <span class="nx">link</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">event</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">()</span> <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">hide</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isVisible</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">hideLocaleDropdown</span><span class="p">()</span>
      <span class="nx">setCurrentLocaleLinkToOpenDropdownMenu</span><span class="p">()</span>
      <span class="nx">resetCurrentLocaleBottomBorderRadius</span><span class="p">()</span>
      <span class="nx">updateShowAvailableLocalesToHidden</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isVisible</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="nx">DROPDOWN_VISIBLE_CLASSES</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">value</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">LOCALE_DROPDOWN_CLASSES</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">hideLocaleDropdown</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">LOCALE_DROPDOWN_CLASSES</span><span class="p">.</span><span class="nx">remove</span><span class="p">(...</span><span class="nx">DROPDOWN_VISIBLE_CLASSES</span><span class="p">)</span>
    <span class="nx">LOCALE_DROPDOWN_CLASSES</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">DROPDOWN_HIDDEN_CLASS</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">setCurrentLocaleLinkToOpenDropdownMenu</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">CURRENT_LOCALE_LINK</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">href</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/?show_available_locales=true</span><span class="dl">"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">resetCurrentLocaleBottomBorderRadius</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">CURRENT_LOCALE_CLASSES</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">TOP_BORDER_RADIUS_ONLY</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">updateShowAvailableLocalesToHidden</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// NOTE: This is done purely from a UX standpoint: If the locale dropdown is</span>
    <span class="c1">// closed, do not have the search parameter say that it's open.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">?show_available_locales=true</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span><span class="p">(</span>
        <span class="p">{},</span> <span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/?show_available_locales=false</span><span class="dl">"</span>
      <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})(</span><span class="nb">document</span><span class="p">,</span> <span class="nb">window</span><span class="p">)</span>
</code></pre></div></div> <p>Yes, this is a pretty liberal helping of Javascript “sprinkles”, but, we needed it. We won’t go through all the details of this code, but there a few peculiarities worth bringing up briefly:</p> <ul> <li>As the IIFE executes, it “initialises” itself by calling <code class="language-plaintext highlighter-rouge">initLocaleDropdownLinks()</code>. This sets up event handlers to make sure all links in the dropdown menu, including the current locale link, do not have events generated by their clicks inadvertently propagate down to <code class="language-plaintext highlighter-rouge">&lt;body&gt;</code> tag, causing <code class="language-plaintext highlighter-rouge">LocaleDropdown.hide()</code> to also be called</li> <li>The returned <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze">frozen object</a> contains what is essentially the “public interface” for the IIFE: the <code class="language-plaintext highlighter-rouge">hide</code> function, which, as you can see, is called in <code class="language-plaintext highlighter-rouge">app.js</code> </li> <li>The <code class="language-plaintext highlighter-rouge">document</code> and <code class="language-plaintext highlighter-rouge">window</code> do not <em>technically</em> need to be passed into the IIFE as arguments since they are globally available, but I think encapsulation is always a goal worth striving for. It is probably also better to have as many variables as possible resolve locally within the IIFE, rather than have to go out and get global variables every time you want to use them</li> </ul> <p>Now, when you open the dropdown menu, and click anywhere else on the page, the menu closes.</p> <p><img src="/assets/images/2019-11-03/02-js-sprinkles.gif" alt="02-js-sprinkles Implementation" title="Javascript Sprinkles Implementation"></p> <p>You can find the code for this iteration of the application in this post’s <a href="https://github.com/paulfioravanti/phx_i18n_example">companion Github repo</a> on the <a href="https://github.com/paulfioravanti/phx_i18n_example/tree/02-js-sprinkles"><code class="language-plaintext highlighter-rouge">02-js-sprinkles</code> branch</a>. The branch is also deployed <a href="https://phx-i18n-02-js-sprinkles.herokuapp.com/">here</a> in its own environment.</p> <h3 id="javascript-sprinkles-issues">Javascript Sprinkles Issues</h3> <p>We are now technically on-par feature-wise with the Elm implementation, but there are still some lingering issues:</p> <ul> <li>It <em>still</em> takes time to open and close the menu and change the locale</li> <li>Closing the menu via clicking somewhere else on the page is snappier than clicking the current locale, even though their function is the same, which is a bit awkward</li> </ul> <p>You can really feel now that we are perhaps unnecessarily forcing the back end to do things that the front end really wants us to do, so let’s acquiesce to Javascript and let it take over more functionality. Further, let’s get rid of any <em>mandatory</em> state management via URL parameters: like the Elm app, I don’t want to see parameters that I don’t have to.</p> <h2 id="javascript-takeover">Javascript Takeover</h2> <h3 id="remove-language-dropdown-state-parameter">Remove Language Dropdown State Parameter</h3> <p>Dropdown state is currently managed via the <code class="language-plaintext highlighter-rouge">@show_available_locales</code> attribute, which is initially set in the <code class="language-plaintext highlighter-rouge">LocalePlug</code>, and then used throughout the templates and views. So, let’s first purge our plug of this param: open up <code class="language-plaintext highlighter-rouge">locale_plug.ex</code>, and delete the <code class="language-plaintext highlighter-rouge">determine_language_dropdown_state/1</code> function entirely, since we are not determining the language dropdown state in the plug anymore. Then, remove that function call from the <code class="language-plaintext highlighter-rouge">call/2</code> function as follows:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/plugs/locale_plug.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LocalePlug</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="nv">@impl</span> <span class="no">Plug</span>
  <span class="k">def</span> <span class="n">call</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_opts</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">locale</span> <span class="o">=</span> <span class="n">fetch_and_set_locale</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">persist_locale</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div> <p>Great! Now, let’s go and remove any trace of the <code class="language-plaintext highlighter-rouge">@show_available_locales</code> in our templates and views. First, in the layout:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/layout/app.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
<span class="o">&lt;%=</span> <span class="n">render</span> <span class="no">LanguageDropdownView</span><span class="p">,</span> <span class="s2">"language_dropdown.html"</span> <span class="p">%</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
</code></pre></div></div> <p>Then, in the dropdown menu template:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/language_dropdown/language_dropdown.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= dropdown_container() %&gt;"</span><span class="o">&gt;</span>
  <span class="o">&lt;%=</span> <span class="n">render</span> <span class="no">LanguageDropdownView</span><span class="p">,</span> <span class="s2">"_current_locale.html"</span> <span class="p">%</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">ul</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= dropdown_list() %&gt;"</span> <span class="n">id</span><span class="o">=</span><span class="s2">"locale_dropdown"</span><span class="o">&gt;</span>
    <span class="o">&lt;%=</span> <span class="n">render_many</span> <span class="n">selectable_locales</span><span class="p">(),</span>
                    <span class="no">LanguageDropdownView</span><span class="p">,</span>
                    <span class="s2">"_locale_list_item.html"</span><span class="p">,</span>
                    <span class="ss">as:</span> <span class="ss">:locale</span> <span class="p">%</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</code></pre></div></div> <p>Here, you can see that we have renamed the <code class="language-plaintext highlighter-rouge">_current_locale_link.html</code> and <code class="language-plaintext highlighter-rouge">_locale_link.html</code> partials to <code class="language-plaintext highlighter-rouge">_current_locale.html</code> and <code class="language-plaintext highlighter-rouge">_locale_list_item.html</code> respectively, as we will use handlers for click events in them, rather than <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code> links</p> <p>The partials themselves look like the following:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/language_dropdown/_current_locale.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">p</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= current_selection() %&gt;"</span> <span class="n">id</span><span class="o">=</span><span class="s2">"current_locale"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">span</span><span class="err">&gt;</span><span class="o">&lt;%=</span> <span class="n">current_locale_string</span><span class="p">()</span> <span class="p">%</span><span class="err">&gt;</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= caret() %&gt;"</span><span class="o">&gt;</span><span class="err">▾</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/language_dropdown/_locale_list_item.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= dropdown_list_item() %&gt;"</span> <span class="n">id</span><span class="o">=</span><span class="s2">"&lt;%= @locale %&gt;"</span> <span class="n">role</span><span class="o">=</span><span class="s2">"selectable_locale"</span><span class="o">&gt;</span>
  <span class="o">&lt;%=</span> <span class="n">locale_string</span><span class="p">(</span><span class="nv">@locale</span><span class="p">)</span> <span class="p">%</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
</code></pre></div></div> <p>The number of styling-related functions has also decreased as a result of these changes, so we change the view and styling module code accordingly:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/views/language_dropdown_view.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownView</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="k">defdelegate</span> <span class="n">caret</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>
  <span class="k">defdelegate</span> <span class="n">current_selection</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>
  <span class="k">defdelegate</span> <span class="n">dropdown_container</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>
  <span class="k">defdelegate</span> <span class="n">dropdown_list</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>
  <span class="k">defdelegate</span> <span class="n">dropdown_list_item</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/views/styles/language_dropdown_style.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownStyle</span> <span class="k">do</span>
  <span class="nv">@caret_classes</span> <span class="sx">~w[
    absolute
    ml2
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@current_selection_classes</span> <span class="sx">~w[
    b--white
    ba
    br2
    pa2
    pointer
    tc
    w4
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@dropdown_container_classes</span> <span class="sx">~w[
    center
    f3
    flex
    h3
    items-center
    justify-end
    w-90
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="c1"># NOTE: Default visibility is `display: none` (`dn`).</span>
  <span class="nv">@dropdown_list_classes</span> <span class="sx">~w[
    absolute
    b--white
    bb
    bl
    br
    br--bottom
    br2
    dn
    items-center
    list
    mt5
    pl0
    pointer
    pr0
    pt1
    tc
    top-0
    w4
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@dropdown_list_item_classes</span> <span class="sx">~w[
    hover-bg-white
    hover-dark-pink
    ph1
    pv2
    pt0
    w-100
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="k">def</span> <span class="n">caret</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@caret_classes</span>
  <span class="k">def</span> <span class="n">current_selection</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@current_selection_classes</span>
  <span class="k">def</span> <span class="n">dropdown_container</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@dropdown_container_classes</span>
  <span class="k">def</span> <span class="n">dropdown_list</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@dropdown_list_classes</span>
  <span class="k">def</span> <span class="n">dropdown_list_item</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@dropdown_list_item_classes</span>
<span class="k">end</span>
</code></pre></div></div> <h3 id="increase-javascript-responsibility">Increase Javascript Responsibility</h3> <p>Finally, we update the locale dropdown Javascript so that it can:</p> <ul> <li>Open the dropdown, as well as close it</li> <li>Handle click events for each locale in the dropdown list, including the current locale</li> <li>Prompt a locale change by sending an <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX/Getting_Started">AJAX</a> request, and then update the page with the server response</li> </ul> <p><strong><code class="language-plaintext highlighter-rouge">assets/js/locale_dropdown.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="p">{</span> <span class="nx">LocaleDropdown</span> <span class="p">}</span>

<span class="kd">const</span> <span class="nx">LocaleDropdown</span> <span class="o">=</span> <span class="p">((</span><span class="nb">document</span><span class="p">,</span> <span class="nb">window</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">LOCALE_DROPDOWN_CLASSES</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">locale_dropdown</span><span class="dl">"</span><span class="p">).</span><span class="nx">classList</span>
  <span class="kd">const</span> <span class="nx">CURRENT_LOCALE</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">current_locale</span><span class="dl">"</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">SELECTABLE_LOCALES</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="dl">"</span><span class="s2">[role='selectable_locale']</span><span class="dl">"</span><span class="p">)</span>

  <span class="c1">// REF: https://tachyons.io/docs/table-of-styles/</span>
  <span class="kd">const</span> <span class="nx">TOP_BORDER_RADIUS_ONLY</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">br--top</span><span class="dl">"</span>
  <span class="kd">const</span> <span class="nx">DROPDOWN_VISIBLE_CLASSES</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">flex</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">flex-column</span><span class="dl">"</span><span class="p">]</span>
  <span class="kd">const</span> <span class="nx">DROPDOWN_HIDDEN_CLASS</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">dn</span><span class="dl">"</span>

  <span class="nx">initCurrentLocale</span><span class="p">()</span>
  <span class="nx">initSelectableLocales</span><span class="p">()</span>

  <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">({</span>
    <span class="na">hide</span><span class="p">:</span> <span class="nx">hide</span>
  <span class="p">})</span>

  <span class="kd">function</span> <span class="nx">initCurrentLocale</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">currentLocaleClassList</span> <span class="o">=</span> <span class="nx">CURRENT_LOCALE</span><span class="p">.</span><span class="nx">classList</span>
    <span class="nx">CURRENT_LOCALE</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// NOTE: Prevent propagation to the onclick handler for the `body` tag.</span>
      <span class="nx">event</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">()</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isVisible</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">hideLocaleDropdown</span><span class="p">()</span>
        <span class="nx">removeCurrentLocaleBottomBorderRadius</span><span class="p">(</span><span class="nx">currentLocaleClassList</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">showLocaleDropdown</span><span class="p">()</span>
        <span class="nx">addCurrentLocaleBottomBorderRadius</span><span class="p">(</span><span class="nx">currentLocaleClassList</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">initSelectableLocales</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">SELECTABLE_LOCALES</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">locale</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">locale</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">changeLocale</span><span class="p">(</span><span class="nx">locale</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">hide</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">currentLocaleClassList</span> <span class="o">=</span> <span class="nx">CURRENT_LOCALE</span><span class="p">.</span><span class="nx">classList</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isVisible</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">hideLocaleDropdown</span><span class="p">()</span>
      <span class="nx">removeCurrentLocaleBottomBorderRadius</span><span class="p">(</span><span class="nx">currentLocaleClassList</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">changeLocale</span><span class="p">(</span><span class="nx">locale</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Clear params in case the locale was originally set using them.</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span><span class="p">({},</span> <span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">()</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">origin</span> <span class="o">+</span> <span class="s2">`?locale=</span><span class="p">${</span><span class="nx">locale</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">open</span><span class="p">()</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">)</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">isVisible</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="nx">DROPDOWN_VISIBLE_CLASSES</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="nx">value</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">LOCALE_DROPDOWN_CLASSES</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">hideLocaleDropdown</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">LOCALE_DROPDOWN_CLASSES</span><span class="p">.</span><span class="nx">remove</span><span class="p">(...</span><span class="nx">DROPDOWN_VISIBLE_CLASSES</span><span class="p">)</span>
    <span class="nx">LOCALE_DROPDOWN_CLASSES</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">DROPDOWN_HIDDEN_CLASS</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">showLocaleDropdown</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">LOCALE_DROPDOWN_CLASSES</span><span class="p">.</span><span class="nx">add</span><span class="p">(...</span><span class="nx">DROPDOWN_VISIBLE_CLASSES</span><span class="p">)</span>
    <span class="nx">LOCALE_DROPDOWN_CLASSES</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">DROPDOWN_HIDDEN_CLASS</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">removeCurrentLocaleBottomBorderRadius</span><span class="p">(</span><span class="nx">currentLocaleClassList</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">currentLocaleClassList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">TOP_BORDER_RADIUS_ONLY</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">addCurrentLocaleBottomBorderRadius</span><span class="p">(</span><span class="nx">currentLocaleClassList</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">currentLocaleClassList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">TOP_BORDER_RADIUS_ONLY</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">})(</span><span class="nb">document</span><span class="p">,</span> <span class="nb">window</span><span class="p">)</span>
</code></pre></div></div> <p>After applying those changes, you can see that the application is now as snappy as the Elm version.</p> <p><img src="/assets/images/2019-11-03/03-js-takeover.gif" alt="03-js-takeover Implementation" title="Javascript Takeover Implementation"></p> <p>You can find the code for this iteration of the application in this post’s <a href="https://github.com/paulfioravanti/phx_i18n_example">companion Github repo</a> on the <a href="https://github.com/paulfioravanti/phx_i18n_example/tree/03-js-takeover"><code class="language-plaintext highlighter-rouge">03-js-takeover</code> branch</a>. The branch is also deployed <a href="https://phx-i18n-03-js-takeover.herokuapp.com/">here</a> in its own environment.</p> <h3 id="javascript-takeover-issues">Javascript Takeover Issues</h3> <p>In order to fetch translations, the application is still making a call out to the server, so it will never be quite as fast as Elm there, but that’s fine: I would rather not give up using the gettext API for a potential front-end-based solution.</p> <p>But, the issue now is…we have a lot of Javascript <img class="emoji" title=":wink:" alt=":wink:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f609.png" height="20" width="20">! Wouldn’t it be nicer if we could handle all this “front-end” functionality in Elixir-land? Well, let’s see how much LiveView can help us in achieving that goal!</p> <h2 id="liveview">LiveView</h2> <p>It feels like it’s been a long evolution for this application, but we are finally at the main event: leveraging the power of LiveView!</p> <p>Before we begin changing our application logic, we have some new dependencies to add and some configuration ceremony to perform, so let’s do that.</p> <h3 id="installation-and-configuration">Installation and Configuration</h3> <blockquote> <p><strong>NOTE</strong>: The method of installation/configuration below is current as of LiveView 0.3.1, but since LiveView is a rapidly evolving project as of this writing, make sure to check the <a href="https://github.com/phoenixframework/phoenix_live_view/blob/master/README.md">Phoenix LiveView README</a> file for the latest information if you run into any issues.</p> </blockquote> <p>First, we need to install the LiveView hex package, so add the following entries to your mix file:</p> <p><strong><code class="language-plaintext highlighter-rouge">mix.exs</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExample</span><span class="o">.</span><span class="no">MixProject</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
    <span class="p">[</span>
      <span class="c1"># ...</span>
      <span class="p">{</span><span class="ss">:phoenix_live_view</span><span class="p">,</span> <span class="s2">"~&gt; 0.3.0"</span><span class="p">},</span>
      <span class="p">{</span><span class="ss">:floki</span><span class="p">,</span> <span class="s2">"&gt;= 0.0.0"</span><span class="p">,</span> <span class="ss">only:</span> <span class="ss">:test</span><span class="p">}</span>
    <span class="p">]</span>
  <span class="k">end</span>
</code></pre></div></div> <p>Then, run <code class="language-plaintext highlighter-rouge">mix deps.get</code>.</p> <p>Next, we need to add configuration for a signing salt. Generate one by running <code class="language-plaintext highlighter-rouge">mix phx.gen.secret 32</code>, and then add it as follows:</p> <p><strong><code class="language-plaintext highlighter-rouge">config/config.exs</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span> <span class="ss">:phx_i18n_example</span><span class="p">,</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Endpoint</span><span class="p">,</span>
  <span class="c1"># ...</span>
  <span class="ss">live_view:</span> <span class="p">[</span>
    <span class="ss">signing_salt:</span> <span class="s2">"&lt;YOUR_SECRET_SALT&gt;"</span>
  <span class="p">]</span>
</code></pre></div></div> <p>Add the LiveView flash to the browser pipeline:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/router.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="n">pipeline</span> <span class="ss">:browser</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">plug</span> <span class="ss">:fetch_flash</span>
    <span class="n">plug</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">LiveView</span><span class="o">.</span><span class="no">Flash</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div> <p>Add some LiveView configuration to your controllers, views, and router in your web file:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="n">controller</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="kn">import</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">LiveView</span><span class="o">.</span><span class="no">Controller</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">view</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="kn">import</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">LiveView</span><span class="p">,</span>
        <span class="ss">only:</span> <span class="p">[</span>
          <span class="ss">live_render:</span> <span class="mi">2</span><span class="p">,</span>
          <span class="ss">live_render:</span> <span class="mi">3</span><span class="p">,</span>
          <span class="ss">live_link:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="ss">live_link:</span> <span class="mi">2</span>
        <span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">router</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="c1"># ...</span>
      <span class="kn">import</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">LiveView</span><span class="o">.</span><span class="no">Router</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div> <p>Expose a new websocket for LiveView updates:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/endpoint.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Endpoint</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">Endpoint</span><span class="p">,</span> <span class="ss">otp_app:</span> <span class="ss">:phx_i18n_example</span>

  <span class="n">socket</span> <span class="s2">"/live"</span><span class="p">,</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">LiveView</span><span class="o">.</span><span class="no">Socket</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div> <p>Add LiveView to the <a href="https://nodejs.org/en/">Node</a> dependencies:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/package.json</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="dl">"</span><span class="s2">dependencies</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="dl">"</span><span class="s2">phoenix_live_view</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">file:../deps/phoenix_live_view</span><span class="dl">"</span>
  <span class="p">},</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div> <p>Install the dependencies with:</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install --prefix assets
</code></pre></div></div> <p>Finally, enable connecting to a LiveView socket from Javascript:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/js/app.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">Socket</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">phoenix</span><span class="dl">"</span>
<span class="k">import</span> <span class="nx">LiveSocket</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">phoenix_live_view</span><span class="dl">"</span>

<span class="kd">let</span> <span class="nx">liveSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LiveSocket</span><span class="p">(</span><span class="dl">"</span><span class="s2">/live</span><span class="dl">"</span><span class="p">,</span> <span class="nx">Socket</span><span class="p">)</span>
<span class="nx">liveSocket</span><span class="p">.</span><span class="nx">connect</span><span class="p">()</span>
</code></pre></div></div> <p>Okay, configuration ceremony complete! Now, let’s move over to actually changing the application.</p> <h3 id="from-conn-to-session">From Conn to Session</h3> <p>We will start, yet again, with the locale plug, where we find that there are some significant changes from before:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/plugs/locale_plug.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LocalePlug</span> <span class="k">do</span>
  <span class="n">alias</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span>
  <span class="nv">@behaviour</span> <span class="no">Plug</span>

  <span class="nv">@locales</span> <span class="no">Gettext</span><span class="o">.</span><span class="n">known_locales</span><span class="p">(</span><span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Gettext</span><span class="p">)</span>
  <span class="nv">@cookie</span> <span class="s2">"phxi18nexamplelanguage"</span>

  <span class="k">defguard</span> <span class="n">known_locale?</span><span class="p">(</span><span class="n">locale</span><span class="p">)</span> <span class="ow">when</span> <span class="n">locale</span> <span class="ow">in</span> <span class="nv">@locales</span>

  <span class="nv">@impl</span> <span class="no">Plug</span>
  <span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">_opts</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">nil</span>

  <span class="nv">@impl</span> <span class="no">Plug</span>
  <span class="k">def</span> <span class="n">call</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_opts</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">locale</span> <span class="o">=</span> <span class="n">fetch_locale</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

    <span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="no">Conn</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="ss">:locale</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">Conn</span><span class="o">.</span><span class="n">put_session</span><span class="p">(</span><span class="ss">:locale</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">fetch_locale</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">case</span> <span class="n">locale_from_params</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="o">||</span> <span class="n">locale_from_cookies</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">nil</span> <span class="o">-&gt;</span>
        <span class="c1"># NOTE: This will fallback to the default locale set in `config.exs`</span>
        <span class="no">Gettext</span><span class="o">.</span><span class="n">get_locale</span><span class="p">()</span>

      <span class="n">locale</span> <span class="o">-&gt;</span>
        <span class="n">locale</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">locale_from_params</span><span class="p">(%</span><span class="no">Conn</span><span class="p">{</span><span class="ss">params:</span> <span class="p">%{</span><span class="s2">"locale"</span> <span class="o">=&gt;</span> <span class="n">locale</span><span class="p">}})</span>
       <span class="ow">when</span> <span class="n">known_locale?</span><span class="p">(</span><span class="n">locale</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">locale</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">locale_from_params</span><span class="p">(</span><span class="n">_conn</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">nil</span>

  <span class="k">defp</span> <span class="n">locale_from_cookies</span><span class="p">(%</span><span class="no">Conn</span><span class="p">{</span><span class="ss">cookies:</span> <span class="p">%{</span><span class="nv">@cookie</span> <span class="o">=&gt;</span> <span class="n">locale</span><span class="p">}})</span>
       <span class="ow">when</span> <span class="n">known_locale?</span><span class="p">(</span><span class="n">locale</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">locale</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">locale_from_cookies</span><span class="p">(</span><span class="n">_conn</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">nil</span>
<span class="k">end</span>
</code></pre></div></div> <p>A few notes on this file:</p> <ul> <li>In the <code class="language-plaintext highlighter-rouge">fetch_locale/1</code> function, we are still attempting to fetch the locale from values potentially given in the params, or in the cookies. If we cannot find it, we ask gettext to give us the default locale; that part has not changed. However, if we do find the locale, we are simply returning it, without calling <a href="https://hexdocs.pm/gettext/Gettext.html#put_locale/1"><code class="language-plaintext highlighter-rouge">Gettext.put_locale/1</code></a> to set the locale globally, because LiveViews <em>run in their own process</em>. As opposed to before, where the application was essentially <em>single process</em>, the application will now be <em>multi-process</em>, which means that there is no global locale for a LiveView to refer to, even if we do set it: each process can only rely on its own encapsulated state, and hence will need a local reference to a locale</li> <li>This relates directly to why we are using <a href="https://hexdocs.pm/plug/Plug.Conn.html#put_session/3"><code class="language-plaintext highlighter-rouge">Plug.Conn.put_session/3</code></a>: we provide <code class="language-plaintext highlighter-rouge">session</code> data to LiveViews, not <code class="language-plaintext highlighter-rouge">conn</code> data, to initialise their state</li> <li>We are also providing the exact same locale data to the <code class="language-plaintext highlighter-rouge">conn</code> assigns, though. Why store the same data in two different places? Because the layout template the LiveView is rendered in, <code class="language-plaintext highlighter-rouge">app.html.eex</code>, needs it. A layout, or at least the main layout (I have not tested nested layouts), as far as I can gather, can have LiveViews rendered within in it, but <em>cannot itself</em> be a LiveView (this took me far too long to finally figure out)</li> <li>All code related to persisting the locale value in the cookie has been removed since a <a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.Socket.html"><code class="language-plaintext highlighter-rouge">Phoenix.LiveView.Socket</code></a> does not have the ability to directly access or assign values to cookies. So how do we make sure the application can remember our locale choice? Using a Javascript escape hatch called “<a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#module-js-interop-and-client-controlled-dom">hooks</a>” to get at the cookies, which we will see more of later…</li> </ul> <h3 id="goodbye-controller-hello-liveview">Goodbye Controller, Hello LiveView</h3> <p>Now, let’s see about getting a LiveView rendered. First, to the router:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/router.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="n">scope</span> <span class="s2">"/"</span><span class="p">,</span> <span class="no">PhxI18nExampleWeb</span> <span class="k">do</span>
    <span class="n">pipe_through</span> <span class="ss">:browser</span>
    <span class="n">live</span> <span class="s2">"/"</span><span class="p">,</span> <span class="no">PageLive</span><span class="p">,</span> <span class="ss">session:</span> <span class="p">[</span><span class="ss">:locale</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <ul> <li>Rather than routing the root path to the <code class="language-plaintext highlighter-rouge">PageController</code>, we can route directly to a LiveView with <a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.Router.html#live/3"><code class="language-plaintext highlighter-rouge">Phoenix.LiveView.Router.live/3</code></a>. LiveViews are responsible for setting up state within their own process, so they pretty much fulfil the role that a controller would. So, if you would like, you can safely delete the <code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/controllers/page_controller.ex</code> file. (Note that we could have continued to use <code class="language-plaintext highlighter-rouge">PageController</code>, and just converted the <code class="language-plaintext highlighter-rouge">index</code> function’s <a href="https://hexdocs.pm/phoenix/Phoenix.View.html#render/3"><code class="language-plaintext highlighter-rouge">render/3</code></a> to a <a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#live_render/3"><code class="language-plaintext highlighter-rouge">live_render/3</code></a>, but it’s purpose would have only been to manually extract the <code class="language-plaintext highlighter-rouge">locale</code> out of <code class="language-plaintext highlighter-rouge">conn.assigns</code> and assign it to the <code class="language-plaintext highlighter-rouge">session</code>, so I figured going straight to a <code class="language-plaintext highlighter-rouge">live</code> route would feel more “LiveView-y”, if that’s even a thing…)</li> <li>The <code class="language-plaintext highlighter-rouge">session: [:locale]</code> option here indicates that we want to pass the session <code class="language-plaintext highlighter-rouge">locale</code> value we populated in the <code class="language-plaintext highlighter-rouge">LocalePlug</code> to <code class="language-plaintext highlighter-rouge">PageLive</code>, our named LiveView</li> </ul> <p>Speaking of which, let’s create a <code class="language-plaintext highlighter-rouge">PageLive</code> module, which, by what seems like an emerging convention, should be placed in a <code class="language-plaintext highlighter-rouge">live/</code> web directory:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/live/page_live.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">PageLive</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">LiveView</span>
  <span class="n">alias</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">PageView</span>

  <span class="k">def</span> <span class="n">mount</span><span class="p">(%{</span><span class="ss">locale:</span> <span class="n">locale</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">locale:</span> <span class="n">locale</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="n">assigns</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">PageView</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">"index.html"</span><span class="p">,</span> <span class="n">assigns</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>A LiveView has two main callback functions that you must implement:</p> <ul> <li> <a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#c:mount/2"><code class="language-plaintext highlighter-rouge">mount/2</code></a>, where you set up your initial state from session values and assign them to the <code class="language-plaintext highlighter-rouge">socket</code> state</li> <li> <a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#c:render/1"><code class="language-plaintext highlighter-rouge">render/1</code></a>, which is responsible for returning rendered content, which in this case is the <code class="language-plaintext highlighter-rouge">index.html</code> template, passing it the <code class="language-plaintext highlighter-rouge">assigns</code> information, which comes from the <code class="language-plaintext highlighter-rouge">socket</code>. So, in this case, <code class="language-plaintext highlighter-rouge">assigns</code> could contain <code class="language-plaintext highlighter-rouge">%{locale: "en"}</code> if that is what was set in the socket, either from <code class="language-plaintext highlighter-rouge">mount/2</code>, or an event handler, which we will look at later</li> </ul> <p>As for the <code class="language-plaintext highlighter-rouge">index.html</code> template that gets <code class="language-plaintext highlighter-rouge">render</code>ed in the LiveView, it looks fairly similar to before, but we now need to give it a <code class="language-plaintext highlighter-rouge">.leex</code> extension for Live Embedded Elixir:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/page/index.html.leex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;%=</span> <span class="n">with_locale</span><span class="p">(</span><span class="nv">@locale</span><span class="p">,</span> <span class="k">fn</span> <span class="o">-&gt;</span> <span class="p">%</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">article</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= article() %&gt;"</span> <span class="n">phx</span><span class="o">-</span><span class="n">click</span><span class="o">=</span><span class="s2">"hide-dropdown"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= heading_container() %&gt;"</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">h1</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= heading() %&gt;"</span><span class="o">&gt;</span>
        <span class="o">&lt;%=</span> <span class="n">gettext</span><span class="p">(</span><span class="s2">"Vertically centering things in css is easy!"</span><span class="p">)</span> <span class="p">%</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">article</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="p">%</span> <span class="k">end</span><span class="p">)</span> <span class="p">%</span><span class="o">&gt;</span>
</code></pre></div></div> <ul> <li>As mentioned previously, we can no longer rely on <code class="language-plaintext highlighter-rouge">Gettext.get_locale/0</code> to be our global source of truth for the application locale, since each LiveView is its own process. So, we need to specifically provide a locale to every template that needs translating. I initially thought that I could use <code class="language-plaintext highlighter-rouge">Gettext.get_locale/0</code> and <code class="language-plaintext highlighter-rouge">Gettext.put_locale/1</code> within a LiveView to set a global locale <em>within the LiveView process</em>: I tried using them in <code class="language-plaintext highlighter-rouge">mount/2</code>, <code class="language-plaintext highlighter-rouge">render/1</code>, and even within the above template, but I had no luck in getting the string-to-translate to re-evaluate until I used <a href="https://hexdocs.pm/gettext/Gettext.html#with_locale/2"><code class="language-plaintext highlighter-rouge">Gettext.with_locale/2</code></a> with the <code class="language-plaintext highlighter-rouge">@locale</code> that was set in the <code class="language-plaintext highlighter-rouge">socket.assigns</code>. So, please be aware of that potentially time-consuming gotcha, or, if you found a way to use them in LiveView, please let me know!</li> <li>The <code class="language-plaintext highlighter-rouge">&lt;article&gt;</code> tag now has a <code class="language-plaintext highlighter-rouge">phx-click="hide-dropdown"</code> binding on it, which will send <code class="language-plaintext highlighter-rouge">PageLive</code> a <code class="language-plaintext highlighter-rouge">"hide-dropdown"</code> message when it is clicked (remember that clicking outside the dropdown menu while it is open should close the menu). We haven’t put the message-handling code in <code class="language-plaintext highlighter-rouge">PageLive</code> just yet, but we will come back to it</li> </ul> <p>In order to get <code class="language-plaintext highlighter-rouge">with_locale/2</code> available in the template, make sure to update the <code class="language-plaintext highlighter-rouge">PageView</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/views/page_view.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">PageView</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">PhxI18nExampleWeb</span><span class="p">,</span> <span class="ss">:view</span>
  <span class="kn">import</span> <span class="no">Gettext</span><span class="p">,</span> <span class="ss">only:</span> <span class="p">[</span><span class="ss">with_locale:</span> <span class="mi">2</span><span class="p">]</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div> <h3 id="every-liveview-in-its-own-process">Every LiveView in its own Process</h3> <p>In the layout, the standard <code class="language-plaintext highlighter-rouge">&lt;%= render @view_module, @view_template, assigns %&gt;</code> statement renders the <code class="language-plaintext highlighter-rouge">PageLive</code> LiveView, but that is not the only place where we need dynamic functionality. The language dropdown needs to open, close, and change locale, and the page title needs to change when the locale changes.</p> <p>We cannot wrap the entire page in a single LiveView (there’s no equivalent for <code class="language-plaintext highlighter-rouge">document.getElementById("body").onclick</code> for us here), so we are going to need separate LiveViews for the dropdown menu and title, rendered from the layout:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/layout/app.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">!DOCTYPE</span> <span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
    <span class="o">&lt;%=</span> <span class="n">live_render</span> <span class="nv">@conn</span><span class="p">,</span> <span class="no">TitleLive</span><span class="p">,</span> <span class="ss">session:</span> <span class="p">%{</span><span class="ss">locale:</span> <span class="nv">@locale</span><span class="p">}</span> <span class="p">%</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">body</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= body() %&gt;"</span><span class="o">&gt;</span>
    <span class="o">&lt;%=</span> <span class="n">live_render</span> <span class="nv">@conn</span><span class="p">,</span> <span class="no">LanguageDropdownLive</span><span class="p">,</span> <span class="ss">session:</span> <span class="p">%{</span><span class="ss">locale:</span> <span class="nv">@locale</span><span class="p">}</span> <span class="p">%</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">main</span> <span class="n">role</span><span class="o">=</span><span class="s2">"main"</span><span class="o">&gt;</span>
      <span class="o">&lt;%=</span> <span class="n">render</span> <span class="nv">@view_module</span><span class="p">,</span> <span class="nv">@view_template</span><span class="p">,</span> <span class="n">assigns</span> <span class="p">%</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">main</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
  <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</code></pre></div></div> <p>The <a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#live_render/3"><code class="language-plaintext highlighter-rouge">live_render/3</code></a> function “renders a LiveView within an originating plug request or within a parent LiveView”. If we were rendering these LiveViews from another LiveView, we would pass in the parent LiveView’s <code class="language-plaintext highlighter-rouge">@session</code> attribute. But, since the layout is within a plug request, we do not have a session yet, and, therefore, need to create one for the new LiveViews. Hence, we use <code class="language-plaintext highlighter-rouge">@conn</code> as the first argument, and make sure to pass in the <code class="language-plaintext highlighter-rouge">@locale</code> attribute from the conn, that we set up in the <code class="language-plaintext highlighter-rouge">LocalePlug</code> (remember, we set the same locale value in both the <code class="language-plaintext highlighter-rouge">conn</code> and in the <code class="language-plaintext highlighter-rouge">session</code>), into both the <code class="language-plaintext highlighter-rouge">TitleLive</code> and <code class="language-plaintext highlighter-rouge">LanguageDropdownLive</code>’s <code class="language-plaintext highlighter-rouge">session</code>.</p> <p>In order to have <code class="language-plaintext highlighter-rouge">TitleLive</code> aliased properly in the layout template, make sure to make the following minor change to the <code class="language-plaintext highlighter-rouge">LayoutView</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/views/layout_view.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...</span>
<span class="n">alias</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="p">{</span><span class="no">LanguageDropdownLive</span><span class="p">,</span> <span class="no">LayoutStyle</span><span class="p">,</span> <span class="no">TitleLive</span><span class="p">}</span>
</code></pre></div></div> <p>We will get into the details of <code class="language-plaintext highlighter-rouge">TitleLive</code> and <code class="language-plaintext highlighter-rouge">LanguageDropdownLive</code> soon, but an important thing to understand is that we now have 3 LiveViews, each running in their own <em>separate process</em>, which conceptually looks like this:</p> <p><img src="/assets/images/2019-11-03/live-view-summary.jpg" alt="LiveView Summary" title="LiveView Summary"></p> <p>Now, even though each of these LiveViews exist in isolated processes, they still need to be able to <em>talk to each other</em> when certain events occur:</p> <ul> <li>When <code class="language-plaintext highlighter-rouge">LocaleDropdownLive</code> changes the locale, <code class="language-plaintext highlighter-rouge">PageLive</code> and <code class="language-plaintext highlighter-rouge">TitleLive</code> need to know what the locale has been changed to so they can re-render themselves with the correct string for the locale</li> <li>When the current locale is clicked, it needs to look at what the state of the available locales dropdown menu is, open or closed, and toggle it</li> <li>If the dropdown menu is open in <code class="language-plaintext highlighter-rouge">LocaleDropdownLive</code>, and a click occurs either in <code class="language-plaintext highlighter-rouge">PageLive</code> or in <code class="language-plaintext highlighter-rouge">LocaleDropdownLive</code> outside of the dropdown menu, <code class="language-plaintext highlighter-rouge">LocaleDropdownLive</code> needs to know so that it can re-render itself with a closed menu</li> </ul> <p><img src="/assets/images/2019-11-03/live-view-messages.jpg" alt="LiveView Messages" title="Inter-LiveView Messaging"></p> <p>In order to get these LiveViews chatting, we will call on <a href="https://github.com/phoenixframework/phoenix_pubsub">Phoenix PubSub</a> to help us out.</p> <h2 id="liveview-event-handling">LiveView Event Handling</h2> <p>Since we’re already most familiar with <code class="language-plaintext highlighter-rouge">PageLive</code>, let’s code up message handling there first:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/live/page_live.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">PageLive</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">LiveView</span>
  <span class="n">alias</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="p">{</span><span class="no">Endpoint</span><span class="p">,</span> <span class="no">PageView</span><span class="p">}</span>

  <span class="nv">@locale_changes</span> <span class="s2">"locale-changes"</span>
  <span class="nv">@dropdown_changes</span> <span class="s2">"dropdown-changes"</span>

  <span class="k">def</span> <span class="n">mount</span><span class="p">(%{</span><span class="ss">locale:</span> <span class="n">locale</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Endpoint</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="nv">@locale_changes</span><span class="p">)</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">locale:</span> <span class="n">locale</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="n">assigns</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">PageView</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">"index.html"</span><span class="p">,</span> <span class="n">assigns</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="s2">"hide-dropdown"</span><span class="p">,</span> <span class="n">_value</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Endpoint</span><span class="o">.</span><span class="n">broadcast_from</span><span class="p">(</span><span class="n">self</span><span class="p">(),</span> <span class="nv">@dropdown_changes</span><span class="p">,</span> <span class="s2">"hide-dropdown"</span><span class="p">,</span> <span class="p">%{})</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_info</span><span class="p">(%{</span><span class="ss">event:</span> <span class="s2">"change-locale"</span><span class="p">,</span> <span class="ss">payload:</span> <span class="p">%{</span><span class="ss">locale:</span> <span class="n">locale</span><span class="p">}},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:locale</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p><img src="/assets/images/2019-11-03/page-live-events.jpg" alt="PageLive Events" title="PageLive Events"></p> <ul> <li>There are two different types of messages that <code class="language-plaintext highlighter-rouge">PageView</code> has to concern itself with: locale change messages, and dropdown change messages, which we have set up as two different <a href="https://hexdocs.pm/phoenix/channels.html">Phoenix Channel</a> names: <code class="language-plaintext highlighter-rouge">@locale_changes</code> and <code class="language-plaintext highlighter-rouge">@dropdown_changes</code>. Not all LiveViews will need to care about all kinds of messages, which is why we are not using a single channel for all message types</li> <li>When the <code class="language-plaintext highlighter-rouge">PageView</code> <code class="language-plaintext highlighter-rouge">mount</code>s, it calls <a href="https://hexdocs.pm/phoenix/Phoenix.Endpoint.html#c:subscribe/2"><code class="language-plaintext highlighter-rouge">Phoenix.Endpoint.subscribe/2</code></a> to set up a subscription to <code class="language-plaintext highlighter-rouge">@locale_changes</code> messages, since it needs to be told when the locale changes so it can render the correct language string. The message we are looking out for from <code class="language-plaintext highlighter-rouge">@locale_changes</code> is called <code class="language-plaintext highlighter-rouge">"change-locale"</code>, which we handle with <a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#c:handle_info/2"><code class="language-plaintext highlighter-rouge">Phoenix.LiveView.handle_info/2</code></a>. When we get the <code class="language-plaintext highlighter-rouge">"change-locale"</code> message, we extract the <code class="language-plaintext highlighter-rouge">locale</code> from its <code class="language-plaintext highlighter-rouge">payload</code>, and assign it to the <code class="language-plaintext highlighter-rouge">socket</code>. <code class="language-plaintext highlighter-rouge">render/1</code> will then be called automatically, and any necessary template re-rendering will occur</li> <li>The <code class="language-plaintext highlighter-rouge">PageView</code> also needs to listen out for <code class="language-plaintext highlighter-rouge">"hide-dropdown"</code> messages that its own template, <code class="language-plaintext highlighter-rouge">index.html.leex</code> could send to it (remember we set <code class="language-plaintext highlighter-rouge">phx-click="hide-dropdown"</code> on the <code class="language-plaintext highlighter-rouge">&lt;article&gt;</code> tag). When a <code class="language-plaintext highlighter-rouge">"hide-dropdown"</code> message is received by <a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#c:handle_event/3"><code class="language-plaintext highlighter-rouge">Phoenix.LiveView.handle_event/3</code></a>, the <code class="language-plaintext highlighter-rouge">PageView</code> does not need to do anything to itself, but it instead calls <a href="https://hexdocs.pm/phoenix/Phoenix.Endpoint.html#c:broadcast_from/4"><code class="language-plaintext highlighter-rouge">Phoenix.Endpoint.broadcast_from/4</code></a> to send out a broadcast to anything that’s listening on the <code class="language-plaintext highlighter-rouge">@dropdown_changes</code> channel telling it that they should hide their dropdown; you can probably guess what would be listening out for that</li> </ul> <p>Let’s now create a <code class="language-plaintext highlighter-rouge">TitleLive</code> module:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/live/title_live.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">TitleLive</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">LiveView</span>
  <span class="kn">import</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Gettext</span><span class="p">,</span> <span class="ss">only:</span> <span class="p">[</span><span class="ss">gettext:</span> <span class="mi">1</span><span class="p">]</span>
  <span class="kn">import</span> <span class="no">Gettext</span><span class="p">,</span> <span class="ss">only:</span> <span class="p">[</span><span class="ss">with_locale:</span> <span class="mi">2</span><span class="p">]</span>
  <span class="n">alias</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Endpoint</span>

  <span class="nv">@locale_changes</span> <span class="s2">"locale-changes"</span>

  <span class="k">def</span> <span class="n">mount</span><span class="p">(%{</span><span class="ss">locale:</span> <span class="n">locale</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Endpoint</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="nv">@locale_changes</span><span class="p">)</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">locale:</span> <span class="n">locale</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="n">assigns</span><span class="p">)</span> <span class="k">do</span>
    <span class="sx">~L""</span><span class="s2">"
    &lt;%= with_locale(@locale, fn -&gt; %&gt;
      &lt;title&gt;
        &lt;%= gettext("</span><span class="no">Multilingualisation</span> <span class="ow">in</span> <span class="no">Phoenix</span><span class="s2">") %&gt;
      &lt;/title&gt;
    &lt;% end) %&gt;
    """</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_info</span><span class="p">(%{</span><span class="ss">event:</span> <span class="s2">"change-locale"</span><span class="p">,</span> <span class="ss">payload:</span> <span class="p">%{</span><span class="ss">locale:</span> <span class="n">locale</span><span class="p">}},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:locale</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p><img src="/assets/images/2019-11-03/title-live-events.jpg" alt="TitleLive Events" title="TitleLive Events"></p> <ul> <li>As you can see, the <code class="language-plaintext highlighter-rouge">mount/1</code> and <code class="language-plaintext highlighter-rouge">handle_info/2</code> functions are identical to <code class="language-plaintext highlighter-rouge">PageView</code>: they both subscribe to the <code class="language-plaintext highlighter-rouge">@locale_changes</code> channel and specifically handle <code class="language-plaintext highlighter-rouge">"change-locale"</code> messages to change their own locales</li> <li>For <code class="language-plaintext highlighter-rouge">render/1</code>, though, because there is not much code, we will render it inline rather than create a new template just for the <code class="language-plaintext highlighter-rouge">&lt;title&gt;</code> tag</li> <li>When I initially wrote the inline template, I figured that I could get away with leaving the <code class="language-plaintext highlighter-rouge">&lt;title&gt;</code> tag in <code class="language-plaintext highlighter-rouge">app.html.eex</code>, and just render the <code class="language-plaintext highlighter-rouge">gettext</code> macro, since that’s the only thing that changes. However, a LiveView <em>must contain at least one HTML tag</em> in order to render, so just be aware of that gotcha</li> </ul> <p>Let’s now create our last, and busiest, LiveView: <code class="language-plaintext highlighter-rouge">LanguageDropdownLive</code>.</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/live/language_dropdown_live.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownLive</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">LiveView</span>
  <span class="n">alias</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="p">{</span><span class="no">Endpoint</span><span class="p">,</span> <span class="no">LanguageDropdownView</span><span class="p">}</span>

  <span class="nv">@locales</span> <span class="no">Gettext</span><span class="o">.</span><span class="n">known_locales</span><span class="p">(</span><span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Gettext</span><span class="p">)</span>
  <span class="nv">@locale_changes</span> <span class="s2">"locale-changes"</span>
  <span class="nv">@dropdown_changes</span> <span class="s2">"dropdown-changes"</span>

  <span class="k">def</span> <span class="n">mount</span><span class="p">(%{</span><span class="ss">locale:</span> <span class="n">locale</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Endpoint</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="nv">@dropdown_changes</span><span class="p">)</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">init_dropdown_state</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="n">assigns</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">LanguageDropdownView</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">"language_dropdown.html"</span><span class="p">,</span> <span class="n">assigns</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Event handling code will go here...</span>

  <span class="k">defp</span> <span class="n">init_dropdown_state</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">selectable_locales</span> <span class="o">=</span> <span class="no">List</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nv">@locales</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>

    <span class="n">assign</span><span class="p">(</span>
      <span class="n">socket</span><span class="p">,</span>
      <span class="p">%{</span>
        <span class="ss">locale:</span> <span class="n">locale</span><span class="p">,</span>
        <span class="ss">selectable_locales:</span> <span class="n">selectable_locales</span><span class="p">,</span>
        <span class="ss">show_available_locales:</span> <span class="no">false</span>
      <span class="p">}</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>For the time-being, we will leave out any event handling code, and instead gradually add it in as we look through the templates that will fire off the events that <code class="language-plaintext highlighter-rouge">LanguageDropdownLive</code> needs to handle. The major points we need to know about at this stage are:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">LanguageDropdownLive</code> subscribes to the <code class="language-plaintext highlighter-rouge">@dropdown_changes</code> channel, since clicks could occur within itself, outside of the actual dropdown menu, as well as from <code class="language-plaintext highlighter-rouge">PageLive</code>, that would necessitate it to close the dropdown menu</li> <li>We have also set up a <code class="language-plaintext highlighter-rouge">@locale_changes</code> channel, that we will broadcast on to let <code class="language-plaintext highlighter-rouge">PageLive</code> and <code class="language-plaintext highlighter-rouge">TitleLive</code> know about locale changes, and which we will use in an event handler soon</li> <li>On <code class="language-plaintext highlighter-rouge">mount</code>, the <code class="language-plaintext highlighter-rouge">init_dropdown_state/2</code> function is called to…initialise the dropdown state. Note that we have <em>brought back</em> the <code class="language-plaintext highlighter-rouge">show_available_locales</code> attribute that we initially <em>got rid of</em> when we migrated from client-server to Javascript. It is now back to being a part of the overall language dropdown state, and so we need to deal with it here in the LiveView</li> </ul> <h2 id="a-quick-styling-detour">A Quick Styling Detour</h2> <p>The re-emergence of <code class="language-plaintext highlighter-rouge">show_available_locales</code> affects the way we deal with the Tachyons styling, so we will make a quick detour to handle re-writing of the <code class="language-plaintext highlighter-rouge">LanguageDropdownView</code> and <code class="language-plaintext highlighter-rouge">LanguageDropdownStyle</code> files to re-incorporate the <code class="language-plaintext highlighter-rouge">show_available_locales</code> attribute:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/views/language_dropdown_view.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownView</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">PhxI18nExampleWeb</span><span class="p">,</span> <span class="ss">:view</span>
  <span class="n">alias</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownStyle</span>
  <span class="n">alias</span> <span class="bp">__MODULE__</span><span class="p">,</span> <span class="ss">as:</span> <span class="no">LanguageDropdownView</span>

  <span class="nv">@locale_strings</span> <span class="p">%{</span>
    <span class="s2">"en"</span> <span class="o">=&gt;</span> <span class="s2">"English"</span><span class="p">,</span>
    <span class="s2">"it"</span> <span class="o">=&gt;</span> <span class="s2">"Italiano"</span><span class="p">,</span>
    <span class="s2">"ja"</span> <span class="o">=&gt;</span> <span class="s2">"日本語"</span>
  <span class="p">}</span>

  <span class="k">defdelegate</span> <span class="n">caret</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>
  <span class="k">defdelegate</span> <span class="n">current_selection</span><span class="p">(</span><span class="n">show_available_locales</span><span class="p">),</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>
  <span class="k">defdelegate</span> <span class="n">dropdown_container</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>
  <span class="k">defdelegate</span> <span class="n">dropdown_list</span><span class="p">(</span><span class="n">show_available_locales</span><span class="p">),</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>
  <span class="k">defdelegate</span> <span class="n">dropdown_list_item</span><span class="p">,</span> <span class="ss">to:</span> <span class="no">LanguageDropdownStyle</span>

  <span class="k">def</span> <span class="n">locale_string</span><span class="p">(</span><span class="n">locale</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@locale_strings</span><span class="p">[</span><span class="n">locale</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/views/styles/language_dropdown_style.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownStyle</span> <span class="k">do</span>
  <span class="nv">@caret_classes</span> <span class="sx">~w[
    absolute
    ml2
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@current_selection_classes</span> <span class="sx">~w[
    b--white
    ba
    br2
    pa2
    pointer
    tc
    w4
  ]</span>

  <span class="nv">@current_selection_border_radius_classes</span> <span class="s2">"br--top"</span>

  <span class="nv">@current_selection_link_classes</span> <span class="sx">~w[
    no-underline
    white
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@dropdown_container_classes</span> <span class="sx">~w[
    center
    f3
    flex
    h3
    items-center
    justify-end
    w-90
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@dropdown_list_classes</span> <span class="sx">~w[
    absolute
    b--white
    bb
    bl
    br
    br--bottom
    br2
    items-center
    list
    mt5
    pl0
    pointer
    pr0
    pt1
    tc
    top-0
    w4
  ]</span>

  <span class="nv">@dropdown_show_classes</span> <span class="sx">~w[
    flex
    flex-column
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@dropdown_hide_classes</span> <span class="s2">"dn"</span>

  <span class="nv">@dropdown_list_item_classes</span> <span class="sx">~w[
    hover-bg-white
    hover-dark-pink
    ph1
    pv2
    pt0
    w-100
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="nv">@dropdown_list_item_link_classes</span> <span class="sx">~w[
    no-underline
    w-100
    white
  ]</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>

  <span class="k">def</span> <span class="n">caret</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@caret_classes</span>

  <span class="k">def</span> <span class="n">current_selection</span><span class="p">(</span><span class="n">show_available_locales</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">display_classes</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">show_available_locales</span> <span class="k">do</span>
        <span class="p">[</span><span class="nv">@current_selection_border_radius_classes</span> <span class="o">|</span> <span class="nv">@current_selection_classes</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="nv">@current_selection_classes</span>
      <span class="k">end</span>

    <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">display_classes</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">current_selection_link</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@current_selection_link_classes</span>

  <span class="k">def</span> <span class="n">dropdown_container</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@dropdown_container_classes</span>

  <span class="k">def</span> <span class="n">dropdown_list</span><span class="p">(</span><span class="n">show_available_locales</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">display_classes</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">show_available_locales</span> <span class="k">do</span>
        <span class="p">[</span><span class="nv">@dropdown_show_classes</span> <span class="o">|</span> <span class="nv">@dropdown_list_classes</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="p">[</span><span class="nv">@dropdown_hide_classes</span> <span class="o">|</span> <span class="nv">@dropdown_list_classes</span><span class="p">]</span>
      <span class="k">end</span>

    <span class="no">Enum</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">display_classes</span><span class="p">,</span> <span class="s2">" "</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">dropdown_list_item</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@dropdown_list_item_classes</span>
  <span class="k">def</span> <span class="n">dropdown_list_item_link</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="nv">@dropdown_list_item_link_classes</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="language-dropdown-event-handling">Language Dropdown Event Handling</h2> <p>Back to our scheduled event handling programming. Let’s dive straight into the language dropdown template:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/language_dropdown/language_dropdown.html.leex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= dropdown_container() %&gt;"</span> <span class="n">phx</span><span class="o">-</span><span class="n">click</span><span class="o">=</span><span class="s2">"hide"</span><span class="o">&gt;</span>
  <span class="o">&lt;%=</span> <span class="n">render</span> <span class="no">LanguageDropdownView</span><span class="p">,</span>
             <span class="s2">"_current_locale.html"</span><span class="p">,</span>
             <span class="ss">locale:</span> <span class="nv">@locale</span><span class="p">,</span>
             <span class="ss">show_available_locales:</span> <span class="nv">@show_available_locales</span> <span class="p">%</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">ul</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= dropdown_list(@show_available_locales) %&gt;"</span><span class="o">&gt;</span>
    <span class="o">&lt;%=</span> <span class="n">render_many</span> <span class="nv">@selectable_locales</span><span class="p">,</span>
                    <span class="no">LanguageDropdownView</span><span class="p">,</span>
                    <span class="s2">"_locale_list_item.html"</span><span class="p">,</span>
                    <span class="ss">as:</span> <span class="ss">:locale</span> <span class="p">%</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</code></pre></div></div> <ul> <li>As expected, the language dropdown template is now a <code class="language-plaintext highlighter-rouge">.leex</code> file since it is being rendered by a LiveView</li> <li>The full set of dropdown state that was set in the <code class="language-plaintext highlighter-rouge">socket</code> is on display here, with the <code class="language-plaintext highlighter-rouge">@locale</code> and <code class="language-plaintext highlighter-rouge">@show_available_locales</code> attributes now being passed into the <code class="language-plaintext highlighter-rouge">_current_locale.html</code> partial, and <code class="language-plaintext highlighter-rouge">@selectable_locales</code> now being used to determine what locales need to have <code class="language-plaintext highlighter-rouge">_locale_list_items.html</code> partials rendered for them, rather than a <code class="language-plaintext highlighter-rouge">selectable_locales/0</code> view function that we used previously</li> <li>Notice that the partials are being <code class="language-plaintext highlighter-rouge">render</code>-ed “normally”, as in, they are not being <code class="language-plaintext highlighter-rouge">live_render</code>ed. This is because the partials are not meant to be run in a separate process to the parent template and they are essentially “a part” of the parent template itself, and hence are automatically “live rendered”. <a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html#module-nested-liveviews">Nested LiveViews</a> are possible, but that is not what is occurring in this case</li> </ul> <p>We can see the first event that <code class="language-plaintext highlighter-rouge">LanguageDropdownLive</code> needs to handle is a <code class="language-plaintext highlighter-rouge">"hide"</code> event, occurring whenever somewhere in the template that is not the dropdown menu is clicked, so let’s write the function to handle that:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/live/language_dropdown_live.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownLive</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="s2">"hide"</span><span class="p">,</span> <span class="n">_value</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:show_available_locales</span><span class="p">,</span> <span class="no">false</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div> <p><img src="/assets/images/2019-11-03/language-dropdown-live-hide-event.jpg" alt="LanguageDropdownLive Hide Event" title="LanguageDropdownLive Hide Event"></p> <p>Okay, first event handled! Let’s now see what the <code class="language-plaintext highlighter-rouge">_current_locale.html</code> needs us to do:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/language_dropdown/_current_locale.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">p</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= current_selection(@show_available_locales) %&gt;"</span>
   <span class="n">name</span><span class="o">=</span><span class="s2">"current_locale"</span>
   <span class="n">id</span><span class="o">=</span><span class="s2">"&lt;%= @locale %&gt;"</span>
   <span class="n">phx</span><span class="o">-</span><span class="n">click</span><span class="o">=</span><span class="s2">"toggle"</span>
   <span class="n">phx</span><span class="o">-</span><span class="n">hook</span><span class="o">=</span><span class="s2">"currentLocale"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">span</span><span class="err">&gt;</span><span class="o">&lt;%=</span> <span class="n">locale_string</span><span class="p">(</span><span class="nv">@locale</span><span class="p">)</span> <span class="p">%</span><span class="err">&gt;</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= caret() %&gt;"</span><span class="o">&gt;</span><span class="err">▾</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</code></pre></div></div> <p>Compared to before, the <code class="language-plaintext highlighter-rouge">&lt;p&gt;</code> tag now:</p> <ul> <li>has an <code class="language-plaintext highlighter-rouge">id</code> attribute containing the <code class="language-plaintext highlighter-rouge">@locale</code> passed into it from its parent template</li> <li>fires a <code class="language-plaintext highlighter-rouge">"toggle"</code> message when clicked</li> <li>has a binding to a hook named <code class="language-plaintext highlighter-rouge">"currentLocale"</code> </li> </ul> <p>Let’s handle the message first, and then the hook.</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/live/language_dropdown_live.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownLive</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="s2">"toggle"</span><span class="p">,</span> <span class="n">_value</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">%{</span><span class="ss">assigns:</span> <span class="p">%{</span><span class="ss">show_available_locales:</span> <span class="n">show_available_locales</span><span class="p">}}</span> <span class="o">=</span> <span class="n">socket</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:show_available_locales</span><span class="p">,</span> <span class="n">!show_available_locales</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div> <p>To handle the <code class="language-plaintext highlighter-rouge">"toggle"</code> message, we take the current value of the <code class="language-plaintext highlighter-rouge">show_available_locales</code> attribute from the <code class="language-plaintext highlighter-rouge">socket</code>, flip the value, and then re-assign it back to the socket.</p> <p><img src="/assets/images/2019-11-03/language-dropdown-live-toggle-event.jpg" alt="LanguageDropdownLive Toggle Event" title="LanguageDropdownLive Toggle Event"></p> <h2 id="hooks">Hooks</h2> <p>LiveView provides life-cycle callback functions to handle custom client-side Javascript when an element is added, updated, or removed by the server. In our case, we are going to want to use two of those callback functions, <code class="language-plaintext highlighter-rouge">mounted</code> and <code class="language-plaintext highlighter-rouge">updated</code>, for the exact same purpose:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/js/app.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">Socket</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">phoenix</span><span class="dl">"</span>
<span class="k">import</span> <span class="nx">LiveSocket</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">phoenix_live_view</span><span class="dl">"</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Cookie</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./cookie</span><span class="dl">"</span>

<span class="kd">const</span> <span class="nx">Hooks</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">currentLocale</span><span class="p">:</span> <span class="p">{</span>
    <span class="nx">mounted</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">Cookie</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
      <span class="c1">// Clear params in case the locale was originally set using them.</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span><span class="p">({},</span> <span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nx">updated</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">Cookie</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">liveSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LiveSocket</span><span class="p">(</span><span class="dl">"</span><span class="s2">/live</span><span class="dl">"</span><span class="p">,</span> <span class="nx">Socket</span><span class="p">,</span> <span class="p">{</span> <span class="na">hooks</span><span class="p">:</span> <span class="nx">Hooks</span> <span class="p">})</span>
<span class="nx">liveSocket</span><span class="p">.</span><span class="nx">connect</span><span class="p">()</span>
</code></pre></div></div> <ul> <li>In the <code class="language-plaintext highlighter-rouge">mounted()</code> callback, executed when the current locale has been mounted into the DOM (eg when first opening the application or after a page refresh), we are able to access the <code class="language-plaintext highlighter-rouge">&lt;p&gt;</code> tag element from <code class="language-plaintext highlighter-rouge">_current_locale.html.eex</code> itself in by calling <code class="language-plaintext highlighter-rouge">this.el</code>. Since we set an <code class="language-plaintext highlighter-rouge">id</code> attribute on the <code class="language-plaintext highlighter-rouge">&lt;p&gt;</code> tag containing the current locale, we can access it using <code class="language-plaintext highlighter-rouge">this.el.id</code>.</li> <li>Since we have not explicitly disallowed setting the locale by params, but we do not want them to hang around after mounting, we clear them out using <a href="https://developer.mozilla.org/en-US/docs/Web/API/History/replaceState"><code class="language-plaintext highlighter-rouge">History.replaceState</code></a> </li> <li>Since we want to make sure that the locale is stored in cookies on <em>every</em> locale change, which could happen during a mount (application first starts), and an update (locale is selected from the dropdown menu), we set the cookie in the <code class="language-plaintext highlighter-rouge">updated()</code> callback as well</li> <li>Make sure you pass a <code class="language-plaintext highlighter-rouge">{ hooks: Hooks }</code> options object to <code class="language-plaintext highlighter-rouge">LiveSocket</code> in order to initialise the hooks</li> </ul> <p>The Javascript to set the cookie looks like the following:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/js/cookie.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="p">{</span> <span class="nx">Cookie</span> <span class="p">}</span>

<span class="kd">const</span> <span class="nx">Cookie</span> <span class="o">=</span> <span class="p">(</span><span class="nb">document</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">NAME</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">phxi18nexamplelanguage</span><span class="dl">"</span>

  <span class="k">return</span> <span class="p">{</span> <span class="na">set</span><span class="p">:</span> <span class="kd">set</span> <span class="p">}</span>

  <span class="kd">function</span> <span class="kd">set</span><span class="p">(</span><span class="nx">locale</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">NAME</span><span class="p">}</span><span class="s2">=</span><span class="p">${</span><span class="nx">locale</span><span class="p">}</span><span class="s2">; expires=</span><span class="p">${</span><span class="nx">expires</span><span class="p">()}</span><span class="s2">`</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">expires</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">expiry</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="c1">// Set expiry to ten days</span>
    <span class="nx">expiry</span><span class="p">.</span><span class="nx">setDate</span><span class="p">(</span><span class="nx">expiry</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">expiry</span><span class="p">.</span><span class="nx">toGMTString</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">})(</span><span class="nb">document</span><span class="p">)</span>
</code></pre></div></div> <p>For some reason, it took me longer than expected to get the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/cookie"><code class="language-plaintext highlighter-rouge">Document.cookie</code></a> code working properly. Setting the cookie did not seem to work unless its name <em>only</em> contained letters and numbers, and no other characters. Maybe you will have better luck if you decide to re-write any of this code.</p> <h2 id="passing-values-in-bindings">Passing Values in Bindings</h2> <p>Back in Elixir-land, we now need to look at what messages should sent when a locale in the language dropdown menu gets clicked:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/language_dropdown/_locale_list_item.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= dropdown_list_item() %&gt;"</span>
    <span class="n">id</span><span class="o">=</span><span class="s2">"&lt;%= @locale %&gt;"</span>
    <span class="n">role</span><span class="o">=</span><span class="s2">"selectable_locale"</span>
    <span class="n">phx</span><span class="o">-</span><span class="n">click</span><span class="o">=</span><span class="s2">"locale-changed"</span>
    <span class="n">phx</span><span class="o">-</span><span class="n">value</span><span class="o">-</span><span class="n">locale</span><span class="o">=</span><span class="s2">"&lt;%= @locale %&gt;"</span><span class="o">&gt;</span>
  <span class="o">&lt;%=</span> <span class="n">locale_string</span><span class="p">(</span><span class="nv">@locale</span><span class="p">)</span> <span class="p">%</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
</code></pre></div></div> <p>When a locale is clicked, it fires a <code class="language-plaintext highlighter-rouge">"locale-changed"</code> message, and in order to tell the LiveView <em>what</em> the new locale should be, it uses a <code class="language-plaintext highlighter-rouge">phx-value-</code> prefixed attribute called, unsurprisingly, <code class="language-plaintext highlighter-rouge">locale</code>. So, let’s handle this message and parameter in <code class="language-plaintext highlighter-rouge">LanguageDropdownLive</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/live/language_dropdown_live.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownLive</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="s2">"locale-changed"</span><span class="p">,</span> <span class="p">%{</span><span class="s2">"locale"</span> <span class="o">=&gt;</span> <span class="n">locale</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Endpoint</span><span class="o">.</span><span class="n">broadcast_from</span><span class="p">(</span><span class="n">self</span><span class="p">(),</span> <span class="nv">@locale_changes</span><span class="p">,</span> <span class="s2">"change-locale"</span><span class="p">,</span> <span class="p">%{</span><span class="ss">locale:</span> <span class="n">locale</span><span class="p">})</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">init_dropdown_state</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div> <ul> <li>Here, we get told that “the locale has changed” (passive voice), at which point we broadcast out to anything that is listening on the <code class="language-plaintext highlighter-rouge">@locale_changes</code> channel that they should “change their locale” (active voice) to the specified <code class="language-plaintext highlighter-rouge">locale</code> value</li> <li>Then, we re-use the <code class="language-plaintext highlighter-rouge">init_dropdown_state/2</code> function, that we also used in <code class="language-plaintext highlighter-rouge">mount/2</code>, to reset the language dropdown menu to its initial state, and re-render it</li> </ul> <p><img src="/assets/images/2019-11-03/language-dropdown-live-locale-changed-event.jpg" alt="LanguageDropdownLive Locale Changed Event" title="LanguageDropdownLive Locale Changed Event"></p> <p>The final message that <code class="language-plaintext highlighter-rouge">LanguageDropdownLive</code> needs to deal with, is the <code class="language-plaintext highlighter-rouge">"hide-dropdown"</code> message that it would receive when a click is registered on <code class="language-plaintext highlighter-rouge">PageLive</code>. The implementation for this is the same as handling the <code class="language-plaintext highlighter-rouge">"hide"</code> message we did earlier, so let’s just include it in for the final version of the full <code class="language-plaintext highlighter-rouge">LanguageDropdownLive</code> code:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/live/language_dropdown_live.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownLive</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Phoenix</span><span class="o">.</span><span class="no">LiveView</span>
  <span class="n">alias</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="p">{</span><span class="no">Endpoint</span><span class="p">,</span> <span class="no">LanguageDropdownView</span><span class="p">}</span>

  <span class="nv">@locales</span> <span class="no">Gettext</span><span class="o">.</span><span class="n">known_locales</span><span class="p">(</span><span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Gettext</span><span class="p">)</span>
  <span class="nv">@locale_changes</span> <span class="s2">"locale-changes"</span>
  <span class="nv">@dropdown_changes</span> <span class="s2">"dropdown-changes"</span>

  <span class="k">def</span> <span class="n">mount</span><span class="p">(%{</span><span class="ss">locale:</span> <span class="n">locale</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Endpoint</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="nv">@dropdown_changes</span><span class="p">)</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">init_dropdown_state</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">render</span><span class="p">(</span><span class="n">assigns</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">LanguageDropdownView</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">"language_dropdown.html"</span><span class="p">,</span> <span class="n">assigns</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="s2">"hide"</span><span class="p">,</span> <span class="n">_value</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:show_available_locales</span><span class="p">,</span> <span class="no">false</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="s2">"toggle"</span><span class="p">,</span> <span class="n">_value</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">%{</span><span class="ss">assigns:</span> <span class="p">%{</span><span class="ss">show_available_locales:</span> <span class="n">show_available_locales</span><span class="p">}}</span> <span class="o">=</span> <span class="n">socket</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:show_available_locales</span><span class="p">,</span> <span class="n">!show_available_locales</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="s2">"locale-changed"</span><span class="p">,</span> <span class="p">%{</span><span class="s2">"locale"</span> <span class="o">=&gt;</span> <span class="n">locale</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Endpoint</span><span class="o">.</span><span class="n">broadcast_from</span><span class="p">(</span><span class="n">self</span><span class="p">(),</span> <span class="nv">@locale_changes</span><span class="p">,</span> <span class="s2">"change-locale"</span><span class="p">,</span> <span class="p">%{</span>
      <span class="ss">locale:</span> <span class="n">locale</span>
    <span class="p">})</span>

    <span class="n">socket</span> <span class="o">=</span> <span class="n">init_dropdown_state</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_info</span><span class="p">(%{</span><span class="ss">event:</span> <span class="s2">"hide-dropdown"</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:show_available_locales</span><span class="p">,</span> <span class="no">false</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">init_dropdown_state</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">selectable_locales</span> <span class="o">=</span> <span class="no">List</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nv">@locales</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>

    <span class="n">assign</span><span class="p">(</span>
      <span class="n">socket</span><span class="p">,</span>
      <span class="p">%{</span>
        <span class="ss">locale:</span> <span class="n">locale</span><span class="p">,</span>
        <span class="ss">selectable_locales:</span> <span class="n">selectable_locales</span><span class="p">,</span>
        <span class="ss">show_available_locales:</span> <span class="no">false</span>
      <span class="p">}</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>We have now completed our LiveView implementation, and the application’s final form <img class="emoji" title=":tada:" alt=":tada:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f389.png" height="20" width="20">! Open up a browser and give it and try, and hopefully you should see or feel no discernable difference between the Javascript takeover version of the application and the LiveView version.</p> <p>You can find the code for this iteration of the application in this post’s <a href="https://github.com/paulfioravanti/phx_i18n_example">companion Github repo</a> on the <a href="https://github.com/paulfioravanti/phx_i18n_example/tree/04-liveview"><code class="language-plaintext highlighter-rouge">04-liveview</code> branch</a>. The branch is also deployed <a href="https://phx-i18n-04-liveview.herokuapp.com/">here</a> in its own environment.</p> <h2 id="conclusion">Conclusion</h2> <p>So, after all this, was using LiveView to implement locale switching worth it? As a toy application to learn all about and get more of an intuitive feel for LiveView, absolutely! How about a production application? Now that I have spent so much time on this application, chances are the next time I do a LiveView project, development may not take me quite as long, so, maybe! Is it overkill for functionality like locale switching, which will likely be done very rarely? Probably!</p> <p>Regardless of the actual value of this example application, I think that on my next Phoenix project, where possible, I will very likely be reaching for LiveView first before Javascript, and only resort to the Javascript when I hit the limits of what LiveView is able to do, wherever they happen to be.</p> <h2 id="update-18-january-2020">Update (18 January 2020)</h2> <p>It was brought to my attention that the application, as it stands, has a bit of an issue. Open up the application in two separate browsers and see if you can spot it.</p> <p><img src="/assets/images/2019-11-03/pubsub-static-channel-issue.gif" alt="PubSub Static Channel Issue" title="PubSub Static Channel Issue"></p> <p>That’s right: if you change the locale in one browser, then the locale changes for <em>every</em> client that is using the application. If we are using the application at the same time, I really should not be able to control what language you are viewing, and vice versa.</p> <p>Furthermore, the language dropdown menu itself is not aware of what is going on because it is not listening out for locale-change events; it believes that <em>it</em> is the sole source of locale-change events, and not some other parallel-universe language dropdown menu that is reaching across its barrier and pulling the language rug out from underneath it.</p> <p>So, what is the cause of this issue?</p> <h2 id="static-pubsub-channels">Static PubSub Channels</h2> <p>Currently, all the LiveView files are broadcasting and subscribing to exactly the same static channels. For example:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/live/language_dropdown_live.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownLive</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="nv">@locale_changes</span> <span class="s2">"locale-changes"</span>
  <span class="nv">@dropdown_changes</span> <span class="s2">"dropdown-changes"</span>

  <span class="k">def</span> <span class="n">mount</span><span class="p">(%{</span><span class="ss">locale:</span> <span class="n">locale</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Endpoint</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="nv">@dropdown_changes</span><span class="p">)</span>
    <span class="c1"># ...</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="s2">"locale-changed"</span><span class="p">,</span> <span class="p">%{</span><span class="s2">"locale"</span> <span class="o">=&gt;</span> <span class="n">locale</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Endpoint</span><span class="o">.</span><span class="n">broadcast_from</span><span class="p">(</span><span class="n">self</span><span class="p">(),</span> <span class="nv">@locale_changes</span><span class="p">,</span> <span class="s2">"change-locale"</span><span class="p">,</span> <span class="p">%{</span>
      <span class="ss">locale:</span> <span class="n">locale</span>
    <span class="p">})</span>
    <span class="c1"># ..</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">Endpoint.subscribe/1</code> and <code class="language-plaintext highlighter-rouge">Endpoint.broadcast_from/4</code> are using only the static string channel names defined in the <code class="language-plaintext highlighter-rouge">@locale_changes</code> and <code class="language-plaintext highlighter-rouge">@dropdown_changes</code> module attributes. Consequently, all clients are subscribing and broadcasting message changes to the same channel, resulting in all the unexpected state sharing issues.</p> <h2 id="arbitrary-user-ids">Arbitrary User IDs</h2> <p>This kind of behaviour might be desired in some situations, but for this application, we want PubSub actions to be siloed to specific users: channel names should look something like <code class="language-plaintext highlighter-rouge">@locale_changes &lt;&gt; id</code>, where <code class="language-plaintext highlighter-rouge">id</code> is some identifier unique to the browser client or user, so that PubSub messages and updates would only apply for that client/user.</p> <p>In some Phoenix applications, this could take the form of the database ID of a <code class="language-plaintext highlighter-rouge">User</code> or <code class="language-plaintext highlighter-rouge">Account</code>, but for something as trivial as this application, we do not have a concept of “users” or “accounts”.</p> <p>So, in the absence of database-backed users with unique IDs, let’s create the next best thing with the lowest barrier to entry, and arbitrarily assign a unique “<code class="language-plaintext highlighter-rouge">user_id</code>” to each application browser connection. We will need this ID in both the <code class="language-plaintext highlighter-rouge">conn</code> and the <code class="language-plaintext highlighter-rouge">session</code> to make sure all the application LiveViews can utilise it. So, let’s handle the <code class="language-plaintext highlighter-rouge">user_id</code> problem in a similar way to how we handled the <code class="language-plaintext highlighter-rouge">locale</code>: generate it in a Plug.</p> <p>First, tell the router that we will use a <code class="language-plaintext highlighter-rouge">UserIdPlug</code> in the <code class="language-plaintext highlighter-rouge">browser</code> pipeline:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/router.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">PhxI18nExampleWeb</span><span class="p">,</span> <span class="ss">:router</span>
  <span class="n">alias</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="p">{</span><span class="no">LocalePlug</span><span class="p">,</span> <span class="no">UserIdPlug</span><span class="p">}</span>

  <span class="n">pipeline</span> <span class="ss">:browser</span> <span class="k">do</span>
    <span class="c1"># ...</span>
    <span class="n">plug</span> <span class="no">UserIdPlug</span>
    <span class="n">plug</span> <span class="no">LocalePlug</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div> <p>Next define the plug: generate a random ID and assign it to the <code class="language-plaintext highlighter-rouge">conn</code> and the <code class="language-plaintext highlighter-rouge">session</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/plugs/user_id_plug.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">UserIdPlug</span> <span class="k">do</span>
  <span class="n">alias</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span>
  <span class="nv">@behaviour</span> <span class="no">Plug</span>

  <span class="nv">@num_bytes</span> <span class="mi">16</span>

  <span class="nv">@impl</span> <span class="no">Plug</span>
  <span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">_opts</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">nil</span>

  <span class="nv">@impl</span> <span class="no">Plug</span>
  <span class="k">def</span> <span class="n">call</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_opts</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">random_id</span> <span class="o">=</span> <span class="n">generate_random_id</span><span class="p">()</span>

    <span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="no">Conn</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">,</span> <span class="n">random_id</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">Conn</span><span class="o">.</span><span class="n">put_session</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">,</span> <span class="n">random_id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">generate_random_id</span> <span class="k">do</span>
    <span class="nv">@num_bytes</span>
    <span class="o">|&gt;</span> <span class="ss">:crypto</span><span class="o">.</span><span class="n">strong_rand_bytes</span><span class="p">()</span>
    <span class="o">|&gt;</span> <span class="no">Base</span><span class="o">.</span><span class="n">encode64</span><span class="p">()</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Then, provide the <code class="language-plaintext highlighter-rouge">user_id</code> to the LiveView <code class="language-plaintext highlighter-rouge">session</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/router.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="n">scope</span> <span class="s2">"/"</span><span class="p">,</span> <span class="no">PhxI18nExampleWeb</span> <span class="k">do</span>
    <span class="n">pipe_through</span> <span class="ss">:browser</span>
    <span class="n">live</span> <span class="s2">"/"</span><span class="p">,</span> <span class="no">PageLive</span><span class="p">,</span> <span class="ss">session:</span> <span class="p">[</span><span class="ss">:locale</span><span class="p">,</span> <span class="ss">:user_id</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">user_id</code> is now available in <code class="language-plaintext highlighter-rouge">PageLive</code> via the <code class="language-plaintext highlighter-rouge">session</code>, and in the <code class="language-plaintext highlighter-rouge">app.html.eex</code> layout via the <code class="language-plaintext highlighter-rouge">conn</code>, so we can pass it off to <code class="language-plaintext highlighter-rouge">TitleLive</code> and <code class="language-plaintext highlighter-rouge">LanguageDropdownLive</code>. Let’s first make sure that the LiveViews rendered from the layout get given a <code class="language-plaintext highlighter-rouge">user_id</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/templates/layout/app.html.eex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">!DOCTYPE</span> <span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">html</span> <span class="n">lang</span><span class="o">=</span><span class="s2">"en"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
    <span class="o">&lt;%=</span> <span class="n">live_render</span> <span class="nv">@conn</span><span class="p">,</span>
                    <span class="no">TitleLive</span><span class="p">,</span>
                    <span class="ss">session:</span> <span class="p">%{</span><span class="ss">locale:</span> <span class="nv">@locale</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="nv">@user_id</span><span class="p">}</span> <span class="p">%</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
  <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">body</span> <span class="n">class</span><span class="o">=</span><span class="s2">"&lt;%= body() %&gt;"</span><span class="o">&gt;</span>
    <span class="o">&lt;%=</span> <span class="n">live_render</span> <span class="nv">@conn</span><span class="p">,</span>
                    <span class="no">LanguageDropdownLive</span><span class="p">,</span>
                    <span class="ss">session:</span> <span class="p">%{</span><span class="ss">locale:</span> <span class="nv">@locale</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="nv">@user_id</span><span class="p">}</span> <span class="p">%</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">!</span><span class="o">--</span> <span class="o">...</span> <span class="o">--&gt;</span>
  <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</code></pre></div></div> <p>Now, for each LiveView, add the <code class="language-plaintext highlighter-rouge">user_id</code> to the static PubSub channel names, as well as make any other minor adjustments to make everything work:</p> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/live/title_live.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">TitleLive</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="nv">@locale_changes</span> <span class="s2">"locale-changes:"</span>

  <span class="k">def</span> <span class="n">mount</span><span class="p">(%{</span><span class="ss">locale:</span> <span class="n">locale</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user_id</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Endpoint</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="nv">@locale_changes</span> <span class="o">&lt;&gt;</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:locale</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/live/language_dropdown_live.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">LanguageDropdownLive</span> <span class="k">do</span>
  <span class="c1"># ...</span>
  <span class="nv">@locale_changes</span> <span class="s2">"locale-changes:"</span>
  <span class="nv">@dropdown_changes</span> <span class="s2">"dropdown-changes:"</span>

  <span class="k">def</span> <span class="n">mount</span><span class="p">(%{</span><span class="ss">locale:</span> <span class="n">locale</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user_id</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Endpoint</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="nv">@dropdown_changes</span> <span class="o">&lt;&gt;</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">init_state</span><span class="p">(</span><span class="n">locale</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="s2">"locale-changed"</span><span class="p">,</span> <span class="p">%{</span><span class="s2">"locale"</span> <span class="o">=&gt;</span> <span class="n">locale</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Endpoint</span><span class="o">.</span><span class="n">broadcast_from</span><span class="p">(</span>
      <span class="n">self</span><span class="p">(),</span>
      <span class="nv">@locale_changes</span> <span class="o">&lt;&gt;</span> <span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
      <span class="s2">"change-locale"</span><span class="p">,</span>
      <span class="p">%{</span><span class="ss">locale:</span> <span class="n">locale</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">init_dropdown_state</span><span class="p">(</span><span class="n">locale</span><span class="p">)</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">init_state</span><span class="p">(</span><span class="n">locale</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Map</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
      <span class="p">%{</span><span class="ss">user_id:</span> <span class="n">user_id</span><span class="p">},</span>
      <span class="n">init_dropdown_state</span><span class="p">(</span><span class="n">locale</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">init_dropdown_state</span><span class="p">(</span><span class="n">locale</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">selectable_locales</span> <span class="o">=</span> <span class="no">List</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nv">@locales</span><span class="p">,</span> <span class="n">locale</span><span class="p">)</span>

    <span class="p">%{</span>
      <span class="ss">locale:</span> <span class="n">locale</span><span class="p">,</span>
      <span class="ss">selectable_locales:</span> <span class="n">selectable_locales</span><span class="p">,</span>
      <span class="ss">show_available_locales:</span> <span class="no">false</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">lib/phx_i18n_example_web/live/page_live.ex</code></strong></p> <div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">PhxI18nExampleWeb</span><span class="o">.</span><span class="no">PageLive</span> <span class="k">do</span>
  <span class="c1"># ...</span>

  <span class="nv">@locale_changes</span> <span class="s2">"locale-changes:"</span>
  <span class="nv">@dropdown_changes</span> <span class="s2">"dropdown-changes:"</span>

  <span class="k">def</span> <span class="n">mount</span><span class="p">(%{</span><span class="ss">locale:</span> <span class="n">locale</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user_id</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Endpoint</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="nv">@locale_changes</span> <span class="o">&lt;&gt;</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">locale:</span> <span class="n">locale</span><span class="p">,</span> <span class="ss">user_id:</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_event</span><span class="p">(</span><span class="s2">"hide-dropdown"</span><span class="p">,</span> <span class="n">_value</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Endpoint</span><span class="o">.</span><span class="n">broadcast_from</span><span class="p">(</span>
      <span class="n">self</span><span class="p">(),</span>
      <span class="nv">@dropdown_changes</span> <span class="o">&lt;&gt;</span> <span class="n">socket</span><span class="o">.</span><span class="n">assigns</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
      <span class="s2">"hide-dropdown"</span><span class="p">,</span>
      <span class="p">%{}</span>
    <span class="p">)</span>

    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">handle_info</span><span class="p">(%{</span><span class="ss">event:</span> <span class="s2">"change-locale"</span><span class="p">,</span> <span class="ss">payload:</span> <span class="n">payload</span><span class="p">},</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="ss">:locale</span><span class="p">,</span> <span class="n">payload</span><span class="o">.</span><span class="n">locale</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Note that <code class="language-plaintext highlighter-rouge">user_id</code> is deliberately not passed into the <code class="language-plaintext highlighter-rouge">socket</code> in <code class="language-plaintext highlighter-rouge">TitleLive</code>, since it is only ever used in <code class="language-plaintext highlighter-rouge">mount/2</code> when setting up its subscriptions, as opposed to the other LiveViews which need the <code class="language-plaintext highlighter-rouge">user_id</code> when they send out broadcasts.</p> <p>Now, when you use the application with multiple browsers, you should see that it works as expected:</p> <p><img src="/assets/images/2019-11-03/pubsub-static-channel-issue-fixed.gif" alt="PubSub Static Channel Issue Fixed" title="PubSub Static Channel Issue Fixed"></p> <p>You can find the code for this iteration of the application in this post’s <a href="https://github.com/paulfioravanti/phx_i18n_example">companion Github repo</a> on the <a href="https://github.com/paulfioravanti/phx_i18n_example/tree/05-liveview-fix"><code class="language-plaintext highlighter-rouge">05-liveview-fix</code> branch</a>. The branch is also deployed <a href="https://phx-i18n-05-liveview-fix.herokuapp.com/">here</a> in its own environment.</p> <p>Follow the next steps of this application’s journey in <em><a href="https://www.paulfioravanti.com/blog/internationalisation-with-phoenix-live-components/">Internationalisation with Phoenix LiveComponents</a></em>!</p> </section> <footer class="page__meta"> <p class="page__taxonomy"> <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong> <span itemprop="keywords"> <a href="/tags/elixir" class="page__taxonomy-item" rel="tag">elixir</a><span class="sep">, </span> <a href="/tags/i18n" class="page__taxonomy-item" rel="tag">i18n</a><span class="sep">, </span> <a href="/tags/italiano" class="page__taxonomy-item" rel="tag">italiano</a><span class="sep">, </span> <a href="/tags/italian" class="page__taxonomy-item" rel="tag">italian</a><span class="sep">, </span> <a href="/tags/japanese" class="page__taxonomy-item" rel="tag">japanese</a><span class="sep">, </span> <a href="/tags/liveview" class="page__taxonomy-item" rel="tag">liveview</a><span class="sep">, </span> <a href="/tags/phoenix" class="page__taxonomy-item" rel="tag">phoenix</a><span class="sep">, </span> <a href="/tags/%E6%97%A5%E6%9C%AC%E8%AA%9E" class="page__taxonomy-item" rel="tag">日本語</a> </span> </p> <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-11-01">November 1, 2020</time></p> </footer> <section class="page__share"> <a href="https://twitter.com/intent/tweet?via=paulfioravanti&amp;text=Internationalisation+with+Phoenix+LiveView%20https%3A%2F%2Fwww.paulfioravanti.com%2Fblog%2Finternationalisation-phoenix-liveview%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.paulfioravanti.com%2Fblog%2Finternationalisation-phoenix-liveview%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.paulfioravanti.com%2Fblog%2Finternationalisation-phoenix-liveview%2F&amp;title=Internationalisation%20with%20Phoenix%20LiveView" class="btn btn--reddit" title=" Reddit"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i><span> Reddit</span></a> <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fwww.paulfioravanti.com%2Fblog%2Finternationalisation-phoenix-liveview%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a> </section> <nav class="pagination"> <a href="/blog/resume-code/" class="pagination--pager" title="Resume as Code ">Previous</a> <a href="/blog/employee-sans-office/" class="pagination--pager" title="Employee Sans Office ">Next</a> </nav> </div> <div class="page__comments"> <h4 class="page__comments-title">Comments</h4> <section id="disqus_thread"></section> </div> </article> <div class="page__related"> <h4 class="page__related-title">You May Also Enjoy</h4> <div class="grid__wrapper"> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2020-11-22/abi-schreider-yb16pT5F_jE-unsplash.jpg" alt="two green ceramic cups with chocolate bar on top"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/jlpt-study-guide/" rel="permalink">My JLPT N1 Study Guide </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2020-11-22T23:05:00+11:00">November 22, 2020</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 10 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Level N1 of The Japanese Language Proficiency Test is a tough nut to crack, but these study methods got me over the line. </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2020-07-25/all-i-want-is-a-timestamp.png" alt="Marty McFly from Back to the Future exclaiming that all he wants is a Pepsi."> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/google-sheets-timestamp/" rel="permalink">All I want is a Timestamp </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2020-07-25T17:35:00+10:00">July 25, 2020</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 8 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Google Sheets can insert the current date and time in your spreadsheet, if you know where to look. </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2020-06-10/stenotype.jpg" alt="Stenotype advertisement by La Salle Extension University in 'Lady's Circle magazine's November 1965 issue"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/completed-typey-type/" rel="permalink">I Completed Typey Type </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2020-06-10T21:00:00+10:00">June 10, 2020</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 8 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">So, am I a stenographer now, or what? </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2020-02-03/kyle-glenn-nXt5HtLmlgE-unsplash.jpg" alt="desk globe on table"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/internationalisation-phoenix-live-layouts/" rel="permalink">Internationalisation with Phoenix Live Layouts </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2020-02-03T17:00:00+11:00">February 3, 2020</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 9 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Phoenix layouts are now live-powered, giving LiveViews more flexibility and control over a template’s surrounding content. </p> </article> </div> </div> </div> </div> </div> <div class="search-content"> <div class="search-content__inner-wrap"> <form class="search-content__form" onkeydown="return event.key != 'Enter';"> <label class="sr-only" for="search"> Enter your search term... </label> <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..."> </form> <div id="results" class="results"></div> </div> </div> <div id="footer" class="page__footer"> <footer> <div class="page__footer-follow"> <ul class="social-icons"> <li> <a href="/privacy"> <i class="fas fa-user-shield"></i> Privacy Policy </a> </li> <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li> </ul> </div> <div class="page__footer-copyright">© 2020 Paul Fioravanti. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div> </footer> </div> <script src="/assets/js/main.min.js"></script> <script src="/assets/js/lunr/lunr.min.js"></script> <script src="/assets/js/lunr/lunr-store.js"></script> <script src="/assets/js/lunr/lunr-en.js"></script> <script>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-109270947-1"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}();</script> <script>var disqus_config=function(){this.page.url="https://www.paulfioravanti.com/blog/internationalisation-phoenix-liveview/",this.page.identifier="/blog/internationalisation-phoenix-liveview"};!function(){var i=document,t=i.createElement("script");t.src="https://paulfioravanti.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(i.head||i.body).appendChild(t)}();</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript> </body> </html>