<!doctype html> <html lang="en" class="no-js"> <head> <meta charset="utf-8"> <title>The Curious Incident of the Shadow in the Run-Time | Floor and Varnish</title> <meta name="description" content="Coding in Ruby is full of sweetness and light, but where there is light, shadows are cast. "> <meta name="author" content="Paul Fioravanti"> <meta property="og:type" content="article"> <meta property="og:locale" content="en_US"> <meta property="og:site_name" content="Floor and Varnish"> <meta property="og:title" content="The Curious Incident of the Shadow in the Run-Time"> <meta property="og:url" content="https://paulfioravanti.com/blog/2018/08/20/the-curious-incident-of-the-shadow-in-the-run-time/"> <meta property="og:description" content="Coding in Ruby is full of sweetness and light, but where there is light, shadows are cast. "> <meta property="og:image" content="https://paulfioravanti.com/assets/images/2018-08-20/matthew-ansley-254316-unsplash.jpg"> <meta name="twitter:site" content="@paulfioravanti"> <meta name="twitter:title" content="The Curious Incident of the Shadow in the Run-Time"> <meta name="twitter:description" content="Coding in Ruby is full of sweetness and light, but where there is light, shadows are cast. "> <meta name="twitter:url" content="https://paulfioravanti.com/blog/2018/08/20/the-curious-incident-of-the-shadow-in-the-run-time/"> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://paulfioravanti.com/assets/images/2018-08-20/matthew-ansley-254316-unsplash.jpg"> <meta name="twitter:creator" content="@paulfioravanti"> <meta property="article:published_time" content="2018-08-20T17:00:00+10:00"> <meta property="article:modified_time" content="2019-04-15T13:45:00+10:00"> <link rel="canonical" href="https://paulfioravanti.com/blog/2018/08/20/the-curious-incident-of-the-shadow-in-the-run-time/"> <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Paul Fioravanti",
      "url": "https://paulfioravanti.com/"
    
  }
</script> <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Floor and Varnish Feed"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <script>document.documentElement.className=document.documentElement.className.replace(/\bno-js\b/g,"")+" js ";</script> <link rel="stylesheet" href="/assets/css/main.css"> <!--[if IE]><style>.greedy-nav .site-title{padding-right:3em}.greedy-nav button{position:absolute;top:0;right:0;height:100%}</style><![endif]--> </head> <body class="layout--single wide"> <nav class="skip-links"> <h2 class="screen-reader-text">Skip links</h2> <ul> <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li> <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li> <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li> </ul> </nav> <!--[if lt IE 9]><div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]--> <div class="masthead"> <div class="masthead__inner-wrap"> <div class="masthead__menu"> <nav id="site-nav" class="greedy-nav"> <a class="site-title" href="/"> Floor and Varnish </a> <ul class="visible-links"></ul> <button class="greedy-nav__toggle hidden" type="button"> <span class="visually-hidden">Toggle menu</span> <div class="navicon"></div> </button> <ul class="hidden-links hidden"></ul> </nav> </div> </div> </div> <div class="initial-content"> <div class="page__hero--overlay" style=" background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('/assets/images/2018-08-20/matthew-ansley-254316-unsplash.jpg');"> <div class="wrapper"> <h1 id="page-title" class="page__title" itemprop="headline"> The Curious Incident of the Shadow in the Run-Time </h1> <p class="page__lead">Coding in Ruby is full of sweetness and light, but where there is light, shadows are cast. </p> <p class="page__meta"> <i class="fa fa-calendar-alt" aria-hidden="true"></i> <time datetime="2018-08-20T17:00:00+10:00"> August 20, 2018 </time> &nbsp; <i class="far fa-clock" aria-hidden="true"></i> 11 minute read </p> <a href="https://rubyweekly.com/issues/413" style="text-decoration: none;"> <img src="https://img.shields.io/badge/Ruby%20Weekly-%23413-red.svg" alt="Ruby Weekly #413"/> </a> </div> <span class="page__hero-caption">Photo by <a href="https://unsplash.com/photos/6AQxBtaIYOk?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Matthew Ansley</a> on <a href="https://unsplash.com/search/photos/shadow?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a> </span> </div> <div id="main" role="main"> <div class="sidebar sticky"> <div itemscope itemtype="https://schema.org/Person"> <div class="author__avatar"> <a href="/"> <img src="https://s.gravatar.com/avatar/abda861707b1e78e0fce47ced55f84ee" alt="Paul Fioravanti" itemprop="image"> </a> </div> <div class="author__content"> <a href=""><h3 class="author__name" itemprop="name">Paul Fioravanti</h3></a> <div class="author__bio" itemprop="description"> <p>Coder, linguist, mechanical keyboard enthusiast.</p> </div> </div> <div class="author__urls-wrapper"> <button class="btn btn--inverse">Follow</button> <ul class="author__urls social-icons"> <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place"> <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Sydney, Australia</span> </li> <li> <a href="https://paulfioravanti.com" itemprop="url"> <i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span> </a> </li> <li> <a href="mailto:paul.fioravanti@gmail.com"> <meta itemprop="email" content="paul.fioravanti@gmail.com"/> <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span> </a> </li> <li> <a href="https://twitter.com/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span> </a> </li> <li> <a href="https://www.linkedin.com/in/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span> </a> </li> <li> <a href="https://github.com/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span> </a> </li> <li> <a href="https://stackoverflow.com/users/567863/paul-fioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-stack-overflow" aria-hidden="true"></i><span class="label">Stack Overflow</span> </a> </li> </ul> </div> </div> </div> <article class="page" itemscope itemtype="https://schema.org/CreativeWork"> <meta itemprop="headline" content="The Curious Incident of the Shadow in the Run-Time"> <meta itemprop="description" content="Coding in Ruby is full of sweetness and light, but where there is light, shadows are cast."> <meta itemprop="datePublished" content="2018-08-20T17:00:00+10:00"> <meta itemprop="dateModified" content="2019-04-15T13:45:00+10:00"> <div class="page__inner-wrap"> <section class="page__content" itemprop="text"> <p>Coding in <a href="https://www.ruby-lang.org/en/">Ruby</a> is full of sweetness and light, but where there is light, shadows are cast. So, let’s get out our torches and see if we can illuminate our way through these darker corners of the language.</p> <h2 id="variable-shadowing">Variable Shadowing</h2> <p>The use of shadowing in a codebase usually refers to <a href="https://en.wikipedia.org/wiki/Variable_shadowing">variable shadowing</a>. A basic example of this in Ruby would be:</p> <p><strong><code class="language-plaintext highlighter-rouge">variable_shadowing.rb</code></strong></p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span> <span class="o">=</span> <span class="mi">42</span>
<span class="mi">3</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">"x is </span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
</code></pre></div></div> <p>Notice that there are two variables named “<code class="language-plaintext highlighter-rouge">x</code>”: the outer variable, and the block variable. Is this an actual problem, though? Let’s try running it:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ruby variable_shadowing.rb
x is 0
x is 1
x is 2
</code></pre></div></div> <p>The output looks reasonable. The call to <code class="language-plaintext highlighter-rouge">puts</code> is inside a block, so it outputs the <code class="language-plaintext highlighter-rouge">x</code> value that is local to that block: it would definitely be surprising if <code class="language-plaintext highlighter-rouge">puts</code> prioritised values that are outside of its local scope, and output “<code class="language-plaintext highlighter-rouge">x is 42</code>” three times.</p> <p>So, does Ruby really care that we are writing our code like this as long as we are getting the output we expect? To answer that, let’s try running the program again, but this time with warnings enabled:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ruby <span class="nt">-w</span> variable_shadowing.rb
variable_shadowing.rb:2: warning: shadowing outer <span class="nb">local </span>variable - x
variable_shadowing.rb:1: warning: assigned but unused variable - x
x is 0
x is 1
x is 2
</code></pre></div></div> <p>It looks like Ruby <em>does</em> care: about both the shadowing, as well as declaring an unused variable (not enough to raise an error, but enough to make you feel that perhaps <a href="https://en.wikipedia.org/wiki/Yukihiro_Matsumoto">Matz</a> is very mildly frowning at you). But why, though? Well, one reason could be that what if we wanted to change our program to have <code class="language-plaintext highlighter-rouge">puts</code> output both the block variable <em>and</em> the outer variable?</p> <p><strong><code class="language-plaintext highlighter-rouge">variable_shadowing.rb</code></strong></p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span> <span class="o">=</span> <span class="mi">42</span>
<span class="mi">3</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">"Local x is </span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2"> and outer x is </span><span class="si">#{</span><span class="s1">'What goes here??'</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
</code></pre></div></div> <p>Since we already have a local variable named <code class="language-plaintext highlighter-rouge">x</code>, there is no way to access some other variable, also called <code class="language-plaintext highlighter-rouge">x</code>, that is outside the local scope. In order to get this to work, we would have to change the name of one of the variables:</p> <p><strong><code class="language-plaintext highlighter-rouge">variable_shadowing.rb</code></strong></p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">y</span> <span class="o">=</span> <span class="mi">42</span>
<span class="mi">3</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">"x is </span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2"> and y is </span><span class="si">#{</span><span class="n">y</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
</code></pre></div></div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ruby <span class="nt">-w</span> variable_shadowing.rb
x is 0 and y is 42
x is 1 and y is 42
x is 2 and y is 42
</code></pre></div></div> <p>This is why variable shadowing in Ruby is generally considered <a href="https://bugs.ruby-lang.org/issues/12490#note-2">“a bad habit and should be discouraged”</a>. Aside from Ruby warnings, <a href="https://github.com/rubocop-hq/rubocop">Rubocop</a> has a <a href="https://rubocop.readthedocs.io/en/latest/cops_lint/#lintshadowingouterlocalvariable"><code class="language-plaintext highlighter-rouge">ShadowingOuterLocalVariable</code> cop</a> (which mimics Ruby’s warning), so there are ways to enable your tools to help you keep the shadows at bay.</p> <p>However, there is another kind of shadowy figure lurking at the peripheries of the Ruby language, aside from the variable-on-variable kind, that Ruby tooling does not warn you about. You are probably unlikely to come across it in the wilds of production code, but it is worth knowing about since it can make for some interesting/confusing behaviour.</p> <h2 id="instance-method-shadowing">Instance Method Shadowing</h2> <figure> <img src="/assets/images/2018-08-20/samuel-zeller-15925-unsplash.jpg" alt="Samuel Zeller Image" title="grayscale photography of cages"/> <figcaption> Photo by Samuel Zeller on <a href="https://unsplash.com/search/photos/shadow?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a> </figcaption> </figure> <p>The <a href="https://docs.ruby-lang.org/en/2.5.0/syntax/assignment_rdoc.html#label-Local+Variables+and+Methods">Local Variables and Methods Assignment</a> section of <a href="https://docs.ruby-lang.org/en/2.5.0/syntax_rdoc.html">Ruby’s syntax documentation</a> says that:</p> <blockquote> <p>In Ruby, local variable names and method names are nearly identical. If you have not assigned to one of these ambiguous names, Ruby will assume you wish to call a method. Once you have assigned to the name, Ruby will assume you wish to reference a local variable.</p> <p>The local variable is created when the parser encounters the assignment, not when the assignment occurs.</p> </blockquote> <p>Ruby parses code line by line from top to bottom during run time. So, the understood meaning of one of the “names” mentioned above can <em>change</em> as the parser moves down the file: what was originally considered a method call, can become a reference to a local variable.</p> <p>Let’s illustrate this using a completely contrived example:</p> <p><strong><code class="language-plaintext highlighter-rouge">person.rb</code></strong></p> <div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span>
  <span class="nb">attr_accessor</span> <span class="ss">:name</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">say_name</span>
    <span class="k">if</span> <span class="nb">name</span><span class="p">.</span><span class="nf">nil?</span>
      <span class="nb">name</span> <span class="o">=</span> <span class="s2">"Unknown"</span>
    <span class="k">end</span>

    <span class="nb">puts</span> <span class="s2">"My name is </span><span class="si">#{</span><span class="nb">name</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Given what we now know of local variable and method assignment, I would expect the following to happen when we attempt to get a <code class="language-plaintext highlighter-rouge">Person</code> to say its name:</p> <ul> <li>In the <code class="language-plaintext highlighter-rouge">#say_name</code> instance method, the first occurrence of <code class="language-plaintext highlighter-rouge">name</code>, seen in the <code class="language-plaintext highlighter-rouge">if name.nil?</code> statement, would refer to the <code class="language-plaintext highlighter-rouge">#name</code> instance method provided by <code class="language-plaintext highlighter-rouge">attr_accessor</code></li> <li>When the Ruby parser sees the <code class="language-plaintext highlighter-rouge">name = "Unknown"</code> assignment line, it will, from that point on, consider any reference to <code class="language-plaintext highlighter-rouge">name</code> <em>after</em> the assignment to refer to a local variable called <code class="language-plaintext highlighter-rouge">name</code>, and not the instance method <code class="language-plaintext highlighter-rouge">#name</code></li> <li>Therefore, even if an object of <code class="language-plaintext highlighter-rouge">Person</code> had a <code class="language-plaintext highlighter-rouge">@name</code> assigned to it on initialisation (eg <code class="language-plaintext highlighter-rouge">Person.new("Paul")</code>), the <code class="language-plaintext highlighter-rouge">name</code> referenced in the final line of the <code class="language-plaintext highlighter-rouge">#say_name</code> method (<code class="language-plaintext highlighter-rouge">name.inspect</code>) would have a value of <code class="language-plaintext highlighter-rouge">nil</code>. This is because at the point of <code class="language-plaintext highlighter-rouge">name.inspect</code>, even though <code class="language-plaintext highlighter-rouge">name.nil?</code> would have failed, and therefore the <code class="language-plaintext highlighter-rouge">name = "Unknown"</code> local variable assignment would not actually be made, the parser <em>still sees</em> that <code class="language-plaintext highlighter-rouge">name</code> should now refer to a local variable, which has not been assigned to, and so is <code class="language-plaintext highlighter-rouge">nil</code>.</li> </ul> <p>Let’s open up an IRB console and test these assumptions.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>irb
irb<span class="o">(</span>main<span class="o">)</span>:001:0&gt; require <span class="s2">"./person.rb"</span>
<span class="nb">true
</span>irb<span class="o">(</span>main<span class="o">)</span>:002:0&gt; Person.new<span class="o">(</span><span class="s2">"Paul"</span><span class="o">)</span>.say_name
My name is nil
nil
</code></pre></div></div> <p>Looks like the first assumption is confirmed:</p> <ul> <li>the instance method check of <code class="language-plaintext highlighter-rouge">name.nil?</code> fails</li> <li>a <code class="language-plaintext highlighter-rouge">name</code> local variable is not assigned</li> <li><code class="language-plaintext highlighter-rouge">name.inspect</code> is checking the value of a local variable and not an instance method</li> <li><code class="language-plaintext highlighter-rouge">name</code> is therefore <code class="language-plaintext highlighter-rouge">nil</code></li> </ul> <p>Now, what happens when we initialise a <code class="language-plaintext highlighter-rouge">Person</code> object without a name:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>irb<span class="o">(</span>main<span class="o">)</span>:003:0&gt; Person.new.say_name
My name is <span class="s2">"Unknown"</span>
nil
</code></pre></div></div> <ul> <li><code class="language-plaintext highlighter-rouge">name.nil?</code> succeeds</li> <li><code class="language-plaintext highlighter-rouge">name</code> local variable is assigned to <code class="language-plaintext highlighter-rouge">"Unknown"</code></li> <li><code class="language-plaintext highlighter-rouge">"Unknown"</code> is that value that gets output.</li> </ul> <p>Great! I mean, kind of weird, but okay! Now, how about we dive a bit deeper and see if we can observe how the referencing of <code class="language-plaintext highlighter-rouge">name</code> changes as the Ruby parser reads through the code.</p> <h2 id="schrodingers-variable">Schrodinger’s Variable</h2> <figure> <img src="/assets/images/2018-08-20/joao-silas-72563-unsplash.jpg" alt="João Silas Image" title="person holding magnifying glass"/> <figcaption> Photo by João Silas on <a href="https://unsplash.com/search/photos/magnifying-glass?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a> </figcaption> </figure> <p>We will use the <a href="https://github.com/pry/pry">Pry</a> debugger to see if we can follow <code class="language-plaintext highlighter-rouge">name</code>’s journey from instance method to local variable. After you</p> <ul> <li>run <code class="language-plaintext highlighter-rouge">gem install pry</code></li> <li>add <code class="language-plaintext highlighter-rouge">require "pry"</code> at the top of <code class="language-plaintext highlighter-rouge">person.rb</code></li> <li>add a <code class="language-plaintext highlighter-rouge">binding.pry</code> breakpoint at the beginning of the <code class="language-plaintext highlighter-rouge">#say_name</code> method</li> </ul> <p>open up another IRB console and let’s take a peek at what is going on.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>irb
irb<span class="o">(</span>main<span class="o">)</span>:001:0&gt; require <span class="s2">"./person.rb"</span>
<span class="nb">true
</span>irb<span class="o">(</span>main<span class="o">)</span>:002:0&gt; Person.new<span class="o">(</span><span class="s2">"Paul"</span><span class="o">)</span>.say_name

From: /person.rb @ line 13 Person#say_name:

    10: def say_name
    11:   binding.pry
    12:
 <span class="o">=&gt;</span> 13:   <span class="k">if </span>name.nil?
    14:     name <span class="o">=</span> <span class="s2">"Unknown"</span>
    15:   end
    16:
    17:   puts <span class="s2">"My name is #{name.inspect}"</span>
    18: end

<span class="o">[</span>1] pry<span class="o">(</span><span class="c">#&lt;Person&gt;)&gt;</span>
</code></pre></div></div> <p>Right, we now have a breakpoint at the point where <code class="language-plaintext highlighter-rouge">name.nil?</code> gets checked. At this point, we have not reached the <code class="language-plaintext highlighter-rouge">name</code> variable assignment, so <code class="language-plaintext highlighter-rouge">name</code> should refer to the instance method, and have a value of <code class="language-plaintext highlighter-rouge">"Paul"</code>. Let’s check:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>irb<span class="o">(</span>main<span class="o">)</span>:002:0&gt; Person.new<span class="o">(</span><span class="s2">"Paul"</span><span class="o">)</span>.say_name

From: /person.rb @ line 13 Person#say_name:

    10: def say_name
    11:   binding.pry
    12:
 <span class="o">=&gt;</span> 13:   <span class="k">if </span>name.nil?
    14:     name <span class="o">=</span> <span class="s2">"Unknown"</span>
    15:   end
    16:
    17:   puts <span class="s2">"My name is #{name.inspect}"</span>
    18: end

<span class="o">[</span>1] pry<span class="o">(</span><span class="c">#&lt;Person&gt;)&gt; name</span>
nil
<span class="o">[</span>2] pry<span class="o">(</span><span class="c">#&lt;Person&gt;)&gt;</span>
</code></pre></div></div> <p>Err, what? How does <code class="language-plaintext highlighter-rouge">name</code> have a value of <code class="language-plaintext highlighter-rouge">nil</code> if we have not reached the variable assignment statement yet? What is <code class="language-plaintext highlighter-rouge">name</code> referring to? Is this some weird Pry thing? So many questions…</p> <p>Well, regardless of having our expectations flipped, let’s follow this through to the end. Since we now have <code class="language-plaintext highlighter-rouge">nil</code>, I would expect that our next stop will be at line 14, where <code class="language-plaintext highlighter-rouge">"Unknown"</code> <em>does</em> get assigned to <code class="language-plaintext highlighter-rouge">name</code>. Let’s get Pry go to the next execution statement:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>1] pry<span class="o">(</span><span class="c">#&lt;Person&gt;)&gt; name</span>
nil
<span class="o">[</span>2] pry<span class="o">(</span><span class="c">#&lt;Person&gt;)&gt; next</span>

From: /person.rb @ line 17 Person#say_name:

    10: def say_name
    11:   binding.pry
    12:
    13:   <span class="k">if </span>name.nil?
    14:     name <span class="o">=</span> <span class="s2">"Unknown"</span>
    15:   end
    16:
 <span class="o">=&gt;</span> 17:   puts <span class="s2">"My name is #{name.inspect}"</span>
    18: end

<span class="o">[</span>2] pry<span class="o">(</span><span class="c">#&lt;Person&gt;)&gt;</span>
</code></pre></div></div> <p>It…skipped directly to the bottom, and it would seem that the assignment did not happen. Let’s see if that is the case, and what gets output:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>From: /person.rb @ line 17 Person#say_name:

    10: def say_name
    11:   binding.pry
    12:
    13:   <span class="k">if </span>name.nil?
    14:     name <span class="o">=</span> <span class="s2">"Unknown"</span>
    15:   end
    16:
 <span class="o">=&gt;</span> 17:   puts <span class="s2">"My name is #{name.inspect}"</span>
    18: end

<span class="o">[</span>2] pry<span class="o">(</span><span class="c">#&lt;Person&gt;)&gt; name</span>
nil
<span class="o">[</span>3] pry<span class="o">(</span><span class="c">#&lt;Person&gt;)&gt; exit</span>
My name is nil
nil
irb<span class="o">(</span>main<span class="o">)</span>:003:0&gt;
</code></pre></div></div> <p>This is all quite confusing. We got the expected result from running <code class="language-plaintext highlighter-rouge">Person.new("Paul").say_name</code>, but, on the way, did we encounter some kind of spooky quantum Ruby that ended up changing the value of <code class="language-plaintext highlighter-rouge">name</code> just because we observed it? Well, before we start handing ourselves honorary doctorates in quantum computing, let’s call on the old traditional Ruby debugger, <code class="language-plaintext highlighter-rouge">puts</code>, to see if we can get an impartial view of what the value of <code class="language-plaintext highlighter-rouge">name</code> is before the <code class="language-plaintext highlighter-rouge">name.nil?</code> check:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>irb
irb<span class="o">(</span>main<span class="o">)</span>:001:0&gt; require <span class="s2">"./person"</span>
<span class="nb">true
</span>irb<span class="o">(</span>main<span class="o">)</span>:002:0&gt; Person.new<span class="o">(</span><span class="s2">"Paul"</span><span class="o">)</span>.say_name

From: /person.rb @ line 13 Person#say_name:

    10: def say_name
    11:   binding.pry
    12:
 <span class="o">=&gt;</span> 13:   puts name.inspect
    14:   <span class="k">if </span>name.nil?
    15:     name <span class="o">=</span> <span class="s2">"Unknown"</span>
    16:   end
    17:
    18:   puts <span class="s2">"My name is #{name.inspect}"</span>
    19: end
</code></pre></div></div> <p>Now, let’s compare what value we get for <code class="language-plaintext highlighter-rouge">name</code> when using Pry, versus the value we get inside the code with <code class="language-plaintext highlighter-rouge">puts</code>:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>1] pry<span class="o">(</span><span class="c">#&lt;Person&gt;)&gt; name</span>
nil
<span class="o">[</span>2] pry<span class="o">(</span><span class="c">#&lt;Person&gt;)&gt; next</span>
<span class="s2">"Paul"</span>

From: /person.rb @ line 14 Person#say_name:

    10: def say_name
    11:   binding.pry
    12:
    13:   puts name.inspect
 <span class="o">=&gt;</span> 14:   <span class="k">if </span>name.nil?
    15:     name <span class="o">=</span> <span class="s2">"Unknown"</span>
    16:   end
    17:
    18:   puts <span class="s2">"My name is #{name.inspect}"</span>
    19: end

<span class="o">[</span>2] pry<span class="o">(</span><span class="c">#&lt;Person&gt;)&gt;</span>
</code></pre></div></div> <p>Running <code class="language-plaintext highlighter-rouge">next</code> executes the <code class="language-plaintext highlighter-rouge">puts name.inspect</code> code, which gives us <code class="language-plaintext highlighter-rouge">"Paul"</code>, the value we expect, but Pry still says that <code class="language-plaintext highlighter-rouge">name</code> is <code class="language-plaintext highlighter-rouge">nil</code>. How can the same variable have two values? It can’t, so there must be something else at play here. What version of <code class="language-plaintext highlighter-rouge">name</code> exactly <em>are</em> Pry and <code class="language-plaintext highlighter-rouge">puts</code> seeing when the code is being stepped through? Well, there is one more Ruby tool that can help us find that out: the <a href="https://docs.ruby-lang.org/en/2.5.0/syntax/miscellaneous_rdoc.html#label-defined-3F"><code class="language-plaintext highlighter-rouge">defined?</code></a> keyword, which returns a string describing its argument.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>irb
irb<span class="o">(</span>main<span class="o">)</span>:001:0&gt; require <span class="s2">"./person"</span>
<span class="nb">true
</span>irb<span class="o">(</span>main<span class="o">)</span>:002:0&gt; Person.new<span class="o">(</span><span class="s2">"Paul"</span><span class="o">)</span>.say_name

From: /person.rb @ line 13 Person#say_name:

    10: def say_name
    11:   binding.pry
    12:
 <span class="o">=&gt;</span> 13:   puts defined?<span class="o">(</span>name<span class="o">)</span>.inspect
    14:   <span class="k">if </span>name.nil?
    15:     name <span class="o">=</span> <span class="s2">"Unknown"</span>
    16:   end
    17:
    18:   puts <span class="s2">"My name is #{name.inspect}"</span>
    19: end
</code></pre></div></div> <p>Okay, first, let’s see what what the Ruby code considers <code class="language-plaintext highlighter-rouge">name</code> to be:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>From: /person.rb @ line 13 Person#say_name:

    10: def say_name
    11:   binding.pry
    12:
 <span class="o">=&gt;</span> 13:   puts defined?<span class="o">(</span>name<span class="o">)</span>.inspect
    14:   <span class="k">if </span>name.nil?
    15:     name <span class="o">=</span> <span class="s2">"Unknown"</span>
    16:   end
    17:
    18:   puts <span class="s2">"My name is #{name.inspect}"</span>
    19: end

<span class="o">[</span>1] pry<span class="o">(</span><span class="c">#&lt;Person&gt;)&gt; next</span>
<span class="s2">"method"</span>
</code></pre></div></div> <p>Ruby says <code class="language-plaintext highlighter-rouge">name</code> is a method! That gels with what we would expect. So what about Pry…?</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>From: /person.rb @ line 13 Person#say_name:

    10: def say_name
    11:   binding.pry
    12:
 <span class="o">=&gt;</span> 13:   puts defined?<span class="o">(</span>name<span class="o">)</span>.inspect
    14:   <span class="k">if </span>name.nil?
    15:     name <span class="o">=</span> <span class="s2">"Unknown"</span>
    16:   end
    17:
    18:   puts <span class="s2">"My name is #{name.inspect}"</span>
    19: end

<span class="o">[</span>1] pry<span class="o">(</span><span class="c">#&lt;Person&gt;)&gt; defined?(name)</span>
<span class="s2">"local-variable"</span>
</code></pre></div></div> <p>Pry sees <code class="language-plaintext highlighter-rouge">name</code> as a local variable! How can this be if we have not reached the assignment statement yet? Can Pry see into the future? Well, Pry itself can’t, and what is happening is not <em>really</em> seeing into the future.</p> <h2 id="not-even-slightly-elementary-my-dear-ruby">Not even slightly elementary, my dear Ruby</h2> <p>The key to this mystery is the <code class="language-plaintext highlighter-rouge">binding</code> part of the <code class="language-plaintext highlighter-rouge">binding.pry</code> statement. Ruby’s <a href="https://ruby-doc.org/core-2.5.1/Binding.html">Binding</a> “encapsulates the execution context at some particular place in the code”, which, in our case, is the entirety of the <code class="language-plaintext highlighter-rouge">#say_name</code> method.</p> <p>When we step through the code with <code class="language-plaintext highlighter-rouge">binding.pry</code>, at the point of the <code class="language-plaintext highlighter-rouge">name.nil?</code> statement, the Ruby parser sees <code class="language-plaintext highlighter-rouge">name</code> as referring to a method, since it knows nothing about any assignment statements yet. Pry, on the other hand, thanks to the <code class="language-plaintext highlighter-rouge">binding</code> effectively “rushing ahead to read the rest of the method” so it can create its execution context, knows all about the local variable assignments that could happen. Hence, we can now see the discrepancies in the results between running <code class="language-plaintext highlighter-rouge">puts</code> inline and using Pry in this case.</p> <p>How can you avoid falling into these kinds of pits of potential confusion? Well, just don’t shadow, really. Leaving aside the quality issues of the example code (it is meant to illustrative of the problem and not exemplary Ruby code after all), to get expected results, there are enough ways it could be changed to fulfil different objectives like:</p> <ul> <li> <p>Specifically assign to the person’s <code class="language-plaintext highlighter-rouge">name</code> attribute if they were not given one:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">say_name</span>
  <span class="k">if</span> <span class="nb">name</span><span class="p">.</span><span class="nf">nil?</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"Unknown"</span>
  <span class="k">end</span>
  <span class="nb">puts</span> <span class="s2">"My name is </span><span class="si">#{</span><span class="nb">name</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div> </div> </li> <li> <p>Output a display name without assigning a <code class="language-plaintext highlighter-rouge">name</code> attribute if one was not originally given.<br/></p> <ul> <li> <p>Using <code class="language-plaintext highlighter-rouge">self</code> to refer to the <code class="language-plaintext highlighter-rouge">name</code> property:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">say_name</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">name</span> <span class="o">||</span> <span class="s2">"Unknown"</span>
  <span class="nb">puts</span> <span class="s2">"My name is </span><span class="si">#{</span><span class="nb">name</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div> </div> </li> <li> <p>Using parentheses:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">say_name</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="nb">name</span><span class="p">()</span> <span class="o">||</span> <span class="s2">"Unknown"</span>
  <span class="nb">puts</span> <span class="s2">"My name is </span><span class="si">#{</span><span class="nb">name</span><span class="p">.</span><span class="nf">inspect</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div> </div> </li> </ul> </li> </ul> <p>So, be kind to your future self and your team mates, and re-consider shadowing in your code. If you ever do find yourself needing to, though, be sure to leave a comment explaining why.</p> <h3 id="other-resources">Other Resources</h3> <ul> <li><a href="https://stackoverflow.com/questions/46597191/behaviours-of-a-ruby-local-variable-shadowing-an-instance-method">Behaviours of a Ruby local variable shadowing an instance method</a> - A Stack Overflow question I asked regarding this kind of shadowing and that eventually led to the creation of this blog post.</li> <li><a href="https://stackoverflow.com/questions/6259314/what-does-shadowing-mean-in-ruby">What does “shadowing” mean in Ruby?</a> - A good Stack Overflow question outlining variable shadowing in Ruby.</li> <li><a href="https://thomasleecopeland.com/2017/04/20/shadowing-bug-in-the-wild.html">A Ruby shadowing bug in the wild</a> - The blog post that originally got me scratching the surface of Ruby shadowing.</li> </ul> </section> <footer class="page__meta"> <p class="page__taxonomy"> <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong> <span itemprop="keywords"> <a href="/tags/ruby" class="page__taxonomy-item" rel="tag">ruby</a><span class="sep">, </span> <a href="/tags/shadowing" class="page__taxonomy-item" rel="tag">shadowing</a> </span> </p> <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-04-15">April 15, 2019</time></p> </footer> <section class="page__share"> <a href="https://twitter.com/intent/tweet?via=paulfioravanti&text=The+Curious+Incident+of+the+Shadow+in+the+Run-Time%20https%3A%2F%2Fpaulfioravanti.com%2Fblog%2F2018%2F08%2F20%2Fthe-curious-incident-of-the-shadow-in-the-run-time%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fpaulfioravanti.com%2Fblog%2F2018%2F08%2F20%2Fthe-curious-incident-of-the-shadow-in-the-run-time%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fpaulfioravanti.com%2Fblog%2F2018%2F08%2F20%2Fthe-curious-incident-of-the-shadow-in-the-run-time%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a> </section> <nav class="pagination"> <a href="/blog/2018/07/31/escape-the-defaults-and-control-your-keyboard-with-qmk/" class="pagination--pager" title="Escape the defaults and Control your keyboard with QMK ">Previous</a> <a href="/blog/2018/10/18/starting-stenography-with-an-ergodox/" class="pagination--pager" title="Starting Stenography with an Ergodox ">Next</a> </nav> </div> <div class="page__comments"> <h4 class="page__comments-title">Comments</h4> <section id="disqus_thread"></section> </div> </article> <div class="page__related"> <h4 class="page__related-title">You May Also Enjoy</h4> <div class="grid__wrapper"> <div class="grid__item"> <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2020-02-03/kyle-glenn-nXt5HtLmlgE-unsplash.jpg" alt="desk globe on table"> </div> <h2 class="archive__item-title" itemprop="headline"> <a href="/blog/2020/02/03/internationalisation-with-phoenix-live-layouts/" rel="permalink">Internationalisation with Phoenix Live Layouts </a> </h2> <p class="page__meta"> <i class="fa fa-calendar-alt" aria-hidden="true"></i> <time datetime="2020-02-03T17:00:00+11:00"> Feb 03, 2020 </time> &nbsp; <i class="far fa-clock" aria-hidden="true"></i> 9 minute read </p> <p class="archive__item-excerpt" itemprop="description">Phoenix layouts are now live-powered, giving LiveViews more flexibility and control over a template’s surrounding content. </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2020-01-27/jason-leung-jCBzW_Q_UGI-unsplash.jpg" alt="photo of assorted-color nation flags on wall during daytime"> </div> <h2 class="archive__item-title" itemprop="headline"> <a href="/blog/2020/01/27/internationalisation-with-phoenix-live-components/" rel="permalink">Internationalisation with Phoenix LiveComponents </a> </h2> <p class="page__meta"> <i class="fa fa-calendar-alt" aria-hidden="true"></i> <time datetime="2020-01-27T10:00:00+11:00"> Jan 27, 2020 </time> &nbsp; <i class="far fa-clock" aria-hidden="true"></i> 17 minute read </p> <p class="archive__item-excerpt" itemprop="description">Draw the responsibility demarcation lines between your LiveView-managed state, markup, and events with LiveComponents. </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2020-01-08/allie-smith-vuWCq1bXZy0-unsplash.jpg" alt="cup of coffee on laptop"> </div> <h2 class="archive__item-title" itemprop="headline"> <a href="/blog/2020/01/08/employee-sans-office/" rel="permalink">Employee Sans Office </a> </h2> <p class="page__meta"> <i class="fa fa-calendar-alt" aria-hidden="true"></i> <time datetime="2020-01-08T16:45:00+11:00"> Jan 08, 2020 </time> &nbsp; <i class="far fa-clock" aria-hidden="true"></i> 4 minute read </p> <p class="archive__item-excerpt" itemprop="description">Small thoughts on remote working. </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2019-11-03/nareeta-martin-vF1YCoLHMpg-unsplash.jpg" alt="multicolored buntings on pathway"> </div> <h2 class="archive__item-title" itemprop="headline"> <a href="/blog/2019/11/03/internationalisation-with-phoenix-liveview/" rel="permalink">Internationalisation with Phoenix LiveView </a> </h2> <p class="page__meta"> <i class="fa fa-calendar-alt" aria-hidden="true"></i> <time datetime="2019-11-03T00:00:00+11:00"> Nov 03, 2019 </time> &nbsp; <i class="far fa-clock" aria-hidden="true"></i> 47 minute read </p> <p class="archive__item-excerpt" itemprop="description">Change your application locale without a full-page reload or having to write (much) Javascript. </p> </article> </div> </div> </div> </div> </div> <div id="footer" class="page__footer"> <footer> <div class="page__footer-follow"> <ul class="social-icons"> <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li> </ul> </div> <div class="page__footer-copyright">&copy; 2020 Paul Fioravanti. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div> </footer> </div> <script src="/assets/js/main.min.js"></script> <script src="https://kit.fontawesome.com/4eee35f757.js"></script> <script>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-109270947-1"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}();</script> <script>var disqus_config=function(){this.page.url="https://paulfioravanti.com/blog/2018/08/20/the-curious-incident-of-the-shadow-in-the-run-time/",this.page.identifier="/blog/2018/08/20/the-curious-incident-of-the-shadow-in-the-run-time"};!function(){var t=document,e=t.createElement("script");e.src="https://paulfioravanti.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}();</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </body> </html>