<!doctype html> <html lang="en" class="no-js"> <head> <meta charset="utf-8"> <title>Graph-driven Refactoring in Elm | Floor and Varnish</title> <meta name="description" content="Visually explore package and module dependencies in an Elm project to help architect your app."> <meta name="author" content="Paul Fioravanti"> <meta property="article:author" content="Paul Fioravanti"> <meta property="og:type" content="article"> <meta property="og:locale" content="en_US"> <meta property="og:site_name" content="Floor and Varnish"> <meta property="og:title" content="Graph-driven Refactoring in Elm"> <meta property="og:url" content="https://www.paulfioravanti.com/blog/graph-driven-refactoring-elm/"> <meta property="og:description" content="Visually explore package and module dependencies in an Elm project to help architect your app."> <meta property="og:image" content="https://www.paulfioravanti.com/assets/images/2018-03-17/REST-branch-Messages-pre-refactor.png"> <meta name="twitter:site" content="@paulfioravanti"> <meta name="twitter:title" content="Graph-driven Refactoring in Elm"> <meta name="twitter:description" content="Visually explore package and module dependencies in an Elm project to help architect your app."> <meta name="twitter:url" content="https://www.paulfioravanti.com/blog/graph-driven-refactoring-elm/"> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://www.paulfioravanti.com/assets/images/2018-03-17/REST-branch-Messages-pre-refactor.png"> <meta name="twitter:creator" content="@paulfioravanti"> <meta property="article:published_time" content="2018-03-17T12:15:00+11:00"> <meta property="article:modified_time" content="2023-07-24T15:53:00+10:00"> <link rel="canonical" href="https://www.paulfioravanti.com/blog/graph-driven-refactoring-elm/"> <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Paul Fioravanti",
      "url": "https://www.paulfioravanti.com/",
      "sameAs": ["https://twitter.com/paulfioravanti","https://www.linkedin.com/in/paulfioravanti","https://github.com/paulfioravanti","https://stackoverflow.com/users/567863/paul-fioravanti"]
    
  }
</script> <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Floor and Varnish Feed"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <script>document.documentElement.className=document.documentElement.className.replace(/\bno-js\b/g,"")+" js ";</script> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"> <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript> </head> <body class="layout--single wide"> <nav class="skip-links"> <ul> <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li> <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li> <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li> </ul> </nav> <!--[if lt IE 9]><div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]--> <div class="masthead"> <div class="masthead__inner-wrap"> <div class="masthead__menu"> <nav id="site-nav" class="greedy-nav"> <a class="site-title" href="/"> Floor and Varnish </a> <ul class="visible-links"><li class="masthead__menu-item"> <a href="/about/">About</a> </li></ul> <button class="search__toggle" type="button"> <span class="visually-hidden">Toggle search</span> <i class="fas fa-search"></i> </button> <button class="greedy-nav__toggle hidden" type="button"> <span class="visually-hidden">Toggle menu</span> <div class="navicon"></div> </button> <ul class="hidden-links hidden"></ul> </nav> </div> </div> </div> <div class="initial-content"> <div class="page__hero--overlay" style=" background-image: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), url('/assets/images/2018-03-17/REST-branch-Messages-pre-refactor.png');"> <div class="wrapper"> <h1 id="page-title" class="page__title" itemprop="headline"> Graph-driven Refactoring in Elm </h1> <p class="page__lead">Visually explore package and module dependencies in an Elm project to help architect your app. </p> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-calendar-alt" aria-hidden="true"></i> <time datetime="2018-03-17T12:15:00+11:00">March 17, 2018</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-clock" aria-hidden="true"></i> 11 minute read </span> </p> </div> </div> <div id="main" role="main"> <div class="sidebar sticky"> <div itemscope itemtype="https://schema.org/Person"> <div class="author__avatar"> <a href="/"> <img src="https://s.gravatar.com/avatar/abda861707b1e78e0fce47ced55f84ee" alt="Paul Fioravanti" itemprop="image"> </a> </div> <div class="author__content"> <a href="/"><h3 class="author__name" itemprop="name">Paul Fioravanti</h3></a> <div class="author__bio" itemprop="description"> <p><img class="emoji" title=":heart:" alt=":heart:" src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png" height="20" width="20"> code / <img class="emoji" title=":heart:" alt=":heart:" src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png" height="20" width="20"> languages <img class="emoji" title=":it:" alt=":it:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f1ee-1f1f9.png" height="20" width="20"> <img class="emoji" title=":jp:" alt=":jp:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f1ef-1f1f5.png" height="20" width="20"> / <img class="emoji" title=":heart:" alt=":heart:" src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png" height="20" width="20"> mech <img class="emoji" title=":keyboard:" alt=":keyboard:" src="https://github.githubassets.com/images/icons/emoji/unicode/2328.png" height="20" width="20"> / Learning stenography</p> </div> </div> <div class="author__urls-wrapper"> <button class="btn btn--inverse">Follow</button> <ul class="author__urls social-icons"> <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place"> <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Sydney, Australia</span> </li> <li> <a href="https://www.paulfioravanti.com" itemprop="url"> <i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span> </a> </li> <li> <a href="mailto:paul@paulfioravanti.com"> <meta itemprop="email" content="paul@paulfioravanti.com"> <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span> </a> </li> <li> <a href="https://keybase.io/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fas fa-fw fa-key" aria-hidden="true"></i><span class="label">Keybase</span> </a> </li> <li> <a href="https://twitter.com/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span> </a> </li> <li> <a href="https://www.linkedin.com/in/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span> </a> </li> <li> <a href="https://instagram.com/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-instagram" aria-hidden="true"></i><span class="label">Instagram</span> </a> </li> <li> <a href="https://github.com/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span> </a> </li> <li> <a href="https://stackoverflow.com/users/567863/paul-fioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-stack-overflow" aria-hidden="true"></i><span class="label">Stack Overflow</span> </a> </li> <li> <a href="https://www.youtube.com/@paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-youtube" aria-hidden="true"></i><span class="label">YouTube</span> </a> </li> <li> <a href="https://www.strava.com/athletes/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer me"> <i class="fab fa-strava" aria-hidden="true"></i> Strava </a> </li> </ul> </div> </div> <div id="bd_embed_signup"> <form action="https://buttondown.email/api/emails/embed-subscribe/paulfioravanti" method="post" target="popupwindow" onsubmit="window.open('https://buttondown.email/paulfioravanti', 'popupwindow')" class="embeddable-buttondown-form"> <label for="bd-email">Get notified of new posts!</label> <input type="email" name="email" id="bd-email" class="email" placeholder="email address"> <input type="hidden" value="1" name="embed"> <div class="clear"> <input type="submit" value="Subscribe" id="bd-embedded-subscribe" class="button"> </div> <p> I send email when I have new content to share. No spam; unsubscribe at any time. <a href="/privacy">Privacy Policy</a> </p> </form> </div> </div> <article class="page" itemscope itemtype="https://schema.org/CreativeWork"> <meta itemprop="headline" content="Graph-driven Refactoring in Elm"> <meta itemprop="description" content="Visually explore package and module dependencies in an Elm project to help architect your app."> <meta itemprop="datePublished" content="2018-03-17T12:15:00+11:00"> <meta itemprop="dateModified" content="2023-07-24T15:53:00+10:00"> <div class="page__inner-wrap"> <section class="page__content" itemprop="text"> <p>After completing the “<a href="https://bigardone.dev/blog/2017/02/02/phoenix-and-elm-a-real-use-case-pt-1">Phoenix and Elm, a real use case</a>” tutorial by <a href="https://twitter.com/bigardone">Ricardo García Vega</a>, I went back and refactored parts of the codebase in order to help me really understand it, and get everything straight in my head (I wrote about this in <a href="https://www.paulfioravanti.com/blog/migrating-a-phoenix-and-elm-app-from-rest-to-graphql/">Migrating a Phoenix and Elm app from REST to GraphQL</a>, and you can see the results in <a href="https://github.com/paulfioravanti/phoenix-and-elm">my repository</a> versus <a href="https://github.com/bigardone/phoenix-and-elm">the original</a>).</p> <h2 id="architecting-in-the-dark">Architecting in the Dark</h2> <p>I could not seem to find any generally-accepted ways to architect Elm code in the same way as I would architect Elixir/Phoenix or Ruby/Rails code, so I just let my instincts guide the code architecture direction, which currently lean towards small(er) modules and functions.</p> <p>So, I thought it would be a good idea to break out code from big Elm files into individual smaller files located under conceptual concerns directories. For example, I extracted application code that looked like it was mostly concerned with a <code class="language-plaintext highlighter-rouge">Contact</code> out into a structure like this:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Contact/
  Commands.elm
  Decoder.elm
  Messages.elm
  Model.elm
  Update.elm
  View.elm
</code></pre></div></div> <p>Messages to update a <code class="language-plaintext highlighter-rouge">Contact</code> would be wrapped in a top level <code class="language-plaintext highlighter-rouge">Msg</code> type called <code class="language-plaintext highlighter-rouge">ContactMsg</code>, and when that came through the main <code class="language-plaintext highlighter-rouge">update</code> function, handling of the update would be immediately delegated out to <code class="language-plaintext highlighter-rouge">Contact.Update</code>.</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Update.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Update</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">update</span><span class="o">,</span> <span class="o">...</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">(</span><span class="kt">ContactMsg</span><span class="o">,</span> <span class="o">...</span><span class="p">))</span>
<span class="k">import</span> <span class="kt">Model</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Model</span><span class="o">,</span> <span class="o">...</span><span class="p">)</span>
<span class="c1">-- ...</span>

<span class="n">update</span> <span class="p">:</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">msg</span> <span class="n">model</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">of</span>
        <span class="kt">ContactMsg</span> <span class="n">msg</span> <span class="o">-&gt;</span>
            <span class="kt">Contact</span><span class="o">.</span><span class="kt">Update</span><span class="o">.</span><span class="n">update</span> <span class="n">msg</span> <span class="n">model</span>

<span class="c1">-- ...</span>
</code></pre></div></div> <p>The nested message inside a <code class="language-plaintext highlighter-rouge">ContactMsg</code>, is completely opaque to <code class="language-plaintext highlighter-rouge">Update</code>, and it was only <code class="language-plaintext highlighter-rouge">Contact.Update</code> that knew what should happen when, in this case, a <code class="language-plaintext highlighter-rouge">FetchContact</code> message is received:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Contact/Update.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">Update</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">update</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">ContactMsg</span><span class="p">(</span><span class="kt">FetchContact</span><span class="p">))</span>
<span class="k">import</span> <span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Model</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Model</span><span class="o">,</span> <span class="kt">RemoteData</span><span class="p">(</span><span class="kt">Failure</span><span class="o">,</span> <span class="kt">Success</span><span class="p">))</span>


<span class="n">update</span> <span class="p">:</span> <span class="kt">ContactMsg</span> <span class="o">-&gt;</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">msg</span> <span class="n">model</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">of</span>
        <span class="kt">FetchContact</span> <span class="p">(</span><span class="kt">Ok</span> <span class="n">response</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="p">(</span> <span class="p">{</span> <span class="n">model</span> <span class="o">|</span> <span class="n">contact</span> <span class="o">=</span> <span class="kt">Success</span> <span class="n">response</span> <span class="p">}</span><span class="o">,</span> <span class="kt">Cmd</span><span class="o">.</span><span class="n">none</span> <span class="p">)</span>

        <span class="kt">FetchContact</span> <span class="p">(</span><span class="kt">Err</span> <span class="n">error</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="p">(</span> <span class="p">{</span> <span class="n">model</span> <span class="o">|</span> <span class="n">contact</span> <span class="o">=</span> <span class="kt">Failure</span> <span class="s">"</span><span class="s2">Contact not found"</span> <span class="p">}</span><span class="o">,</span> <span class="kt">Cmd</span><span class="o">.</span><span class="n">none</span> <span class="p">)</span>
</code></pre></div></div> <p>This sort of thing seemed like a good pattern to me in the absence of any others, but there was no way I could really tell if it was <em>actually</em> any good, or if there would be any issues, performance or otherwise, related to coding Elm in this way.</p> <h2 id="graphing-dependencies">Graphing Dependencies</h2> <p>Until, that is, I was introduced to <a href="https://github.com/justinmimbs/elm-module-graph">elm-module-graph</a>, which enables you to visually explore package and module dependencies in an Elm project. It helped me understand that:</p> <ul> <li>My code was not really properly separated out into the concerns I thought it was.</li> <li>I had the Elm equivalent of a <a href="https://en.wikipedia.org/wiki/God_object">God object</a>-in-the-making: a module that too many <em>other</em> modules had knowledge about. These modules, given enough other modules that have it as a dependency, can lead to longer Elm compile times every time a change is made on them.</li> </ul> <h3 id="create-graph-file">Create Graph File</h3> <p>Here is how I generated the needed <code class="language-plaintext highlighter-rouge">module-graph.json</code> for the <a href="https://github.com/paulfioravanti/phoenix-and-elm">Address Book app</a> (adapt the commands as necessary for your own project, and make sure you have <a href="https://www.python.org/downloads/">Python</a> installed):</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>assets/elm
wget https://raw.githubusercontent.com/justinmimbs/elm-module-graph/master/elm-module-graph.py
<span class="nb">chmod </span>744 elm-module-graph.py
./elm-module-graph.py src/Main.elm
</code></pre></div></div> <h3 id="display-graph">Display Graph</h3> <p>Next, navigate to <a href="https://justinmimbs.github.io/elm-module-graph/">https://justinmimbs.github.io/elm-module-graph/</a> and upload the generated <code class="language-plaintext highlighter-rouge">module-graph.json</code> file, and you will see something like this:</p> <p><img src="/assets/images/2018-03-17/REST-branch-default-modules.png" alt="REST branch default modules" title="REST branch default modules" class="img-responsive"></p> <p>The default graph display includes modules from external libraries, so let’s hide them (by toggling the display of the external packages at the top) so that we can focus on the application code:</p> <p><img src="/assets/images/2018-03-17/REST-branch-only-project-modules.png" alt="REST branch only project modules" title="REST branch only project modules" class="img-responsive"></p> <h2 id="find-long-bars">Find Long Bars</h2> <p>If a module has a long bar with attached lines in the graph, that means that it is imported by many modules. Here, it is clear that the <code class="language-plaintext highlighter-rouge">Messages</code> module, displayed right in the middle of the graph, has the longest bar, so let’s take a clearer look at its dependencies by clicking on it:</p> <p><img src="/assets/images/2018-03-17/REST-branch-Messages-pre-refactor.png" alt="REST branch Messages pre-refactor" title="REST branch Messages pre-refactor" class="img-responsive"></p> <ul> <li>The modules in <span style="color: red">red</span> are the modules that <code class="language-plaintext highlighter-rouge">Messages</code> imports into itself. These are not the relationships we need to worry about.</li> <li>The modules in <span style="color: blue">blue</span> are the modules that import <code class="language-plaintext highlighter-rouge">Messages</code> into themselves. Here, we can see that a great many “child” modules like <code class="language-plaintext highlighter-rouge">Contact.Update</code>, have knowledge about “parent” <code class="language-plaintext highlighter-rouge">Messages</code>, but <code class="language-plaintext highlighter-rouge">Contact.Update</code> should <em>really</em> only know about the type of message it deals with directly, the <code class="language-plaintext highlighter-rouge">ContactMsg</code>, and leave knowledge about (and handling of) <code class="language-plaintext highlighter-rouge">Msg</code> type messages to the <code class="language-plaintext highlighter-rouge">Messages</code> module.</li> </ul> <p>We have some leaking of encapsulation within the concerns, so, let’s see what can be done to fix them, with the initial goal of not having any modules under the <code class="language-plaintext highlighter-rouge">Contact</code> concern import the <code class="language-plaintext highlighter-rouge">Messages</code> module. The starting point for this refactor will be the <a href="https://github.com/paulfioravanti/phoenix-and-elm"><code class="language-plaintext highlighter-rouge">rest</code> branch of the Address App</a>, so if you’re following along at home, clone the repo and let’s get refactoring!</p> <blockquote> <p>If you get stuck while refactoring at any step of the way, have a look at the <a href="https://github.com/paulfioravanti/phoenix-and-elm/tree/rest-refactor"><code class="language-plaintext highlighter-rouge">rest-refactor</code> branch of the Address App</a> for guidance.</p> </blockquote> <h2 id="initial-preparation">Initial Preparation</h2> <h3 id="extract-remotedata-into-its-own-module">Extract RemoteData into its own Module</h3> <p>Currently, the <code class="language-plaintext highlighter-rouge">RemoteData</code> type is contained in the top-level <code class="language-plaintext highlighter-rouge">Model</code> module. Since <code class="language-plaintext highlighter-rouge">Contact</code> concern modules needs to know about <code class="language-plaintext highlighter-rouge">RemoteData</code>, but not <code class="language-plaintext highlighter-rouge">Model</code> (they should only need to know about <code class="language-plaintext highlighter-rouge">Contact.Model</code>), let’s remove <code class="language-plaintext highlighter-rouge">RemoteData</code> out from <code class="language-plaintext highlighter-rouge">Model</code> and into its own top level module:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/RemoteData.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">RemoteData</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">RemoteData</span><span class="p">(</span><span class="o">..</span><span class="p">))</span>


<span class="k">type</span> <span class="kt">RemoteData</span> <span class="n">e</span> <span class="n">a</span>
    <span class="o">=</span> <span class="kt">Failure</span> <span class="n">e</span>
    <span class="o">|</span> <span class="kt">NotRequested</span>
    <span class="o">|</span> <span class="kt">Requesting</span>
    <span class="o">|</span> <span class="kt">Success</span> <span class="n">a</span>
</code></pre></div></div> <p>The Elm compiler should let you know the modules in which you need to change <code class="language-plaintext highlighter-rouge">RemoteData</code> references to this new one, but most of the edits will consist of changing references like:</p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="kt">Model</span>
    <span class="k">exposing</span>
        <span class="p">(</span> <span class="kt">Model</span>
        <span class="o">,</span> <span class="kt">RemoteData</span><span class="p">(</span><span class="kt">NotRequested</span><span class="o">,</span> <span class="kt">Requesting</span><span class="o">,</span> <span class="kt">Failure</span><span class="o">,</span> <span class="kt">Success</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></div> <p>to something like:</p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="kt">Model</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Model</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">RemoteData</span>
    <span class="k">exposing</span>
        <span class="p">(</span> <span class="kt">RemoteData</span><span class="p">(</span><span class="kt">NotRequested</span><span class="o">,</span> <span class="kt">Requesting</span><span class="o">,</span> <span class="kt">Failure</span><span class="o">,</span> <span class="kt">Success</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></div> <h3 id="create-routing-concern">Create Routing Concern</h3> <p>In <code class="language-plaintext highlighter-rouge">Contact.View</code>, there is the following line:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Contact/View.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">(</span><span class="kt">NavigateTo</span><span class="p">))</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">NavigateTo</code> is a message that is sent in <code class="language-plaintext highlighter-rouge">onClick</code> link attributes in HTML inside multiple view files. When this message is handled in <code class="language-plaintext highlighter-rouge">Update</code>, it only runs a command to navigate to a new URL, and does not return a new model:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Update.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Update</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">update</span><span class="o">,</span> <span class="o">...</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Navigation</span>
<span class="k">import</span> <span class="kt">Routing</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Route</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<span class="c1">-- ...</span>

<span class="n">update</span> <span class="p">:</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">msg</span> <span class="n">model</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">of</span>
        <span class="c1">-- ...</span>

        <span class="kt">NavigateTo</span> <span class="n">route</span> <span class="o">-&gt;</span>
            <span class="p">(</span> <span class="n">model</span><span class="o">,</span> <span class="kt">Navigation</span><span class="o">.</span><span class="n">newUrl</span> <span class="p">(</span><span class="kt">Routing</span><span class="o">.</span><span class="n">toPath</span> <span class="n">route</span><span class="p">)</span> <span class="p">)</span>
<span class="c1">-- ...</span>
</code></pre></div></div> <p>So, in order to de-couple <code class="language-plaintext highlighter-rouge">Contact.View</code> from <code class="language-plaintext highlighter-rouge">Messages</code>, it looks like a new extraction of a <code class="language-plaintext highlighter-rouge">Routing</code> concern will be in order, so let’s start with defining messages and update handling for <code class="language-plaintext highlighter-rouge">Routing</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Routing/Messages.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Routing</span><span class="o">.</span><span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">RoutingMsg</span><span class="p">(</span><span class="o">..</span><span class="p">))</span>

<span class="k">import</span> <span class="kt">Routing</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Route</span><span class="p">)</span>


<span class="k">type</span> <span class="kt">RoutingMsg</span>
    <span class="o">=</span> <span class="kt">NavigateTo</span> <span class="kt">Route</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Routing/Update.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Routing</span><span class="o">.</span><span class="kt">Update</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">update</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Navigation</span>
<span class="k">import</span> <span class="kt">Routing</span>
<span class="k">import</span> <span class="kt">Routing</span><span class="o">.</span><span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">RoutingMsg</span><span class="p">(</span><span class="kt">NavigateTo</span><span class="p">))</span>


<span class="n">update</span> <span class="p">:</span> <span class="kt">RoutingMsg</span> <span class="o">-&gt;</span> <span class="kt">Cmd</span> <span class="n">msg</span>
<span class="n">update</span> <span class="n">msg</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">of</span>
        <span class="kt">NavigateTo</span> <span class="n">route</span> <span class="o">-&gt;</span>
            <span class="kt">Navigation</span><span class="o">.</span><span class="n">newUrl</span> <span class="p">(</span><span class="kt">Routing</span><span class="o">.</span><span class="n">toPath</span> <span class="n">route</span><span class="p">)</span>
</code></pre></div></div> <p>We will also need to allow for a <code class="language-plaintext highlighter-rouge">RoutingMsg</code> to be handled by the top-level <code class="language-plaintext highlighter-rouge">Messages</code> module, so let’s add that (while removing <code class="language-plaintext highlighter-rouge">NavigateTo</code> from <code class="language-plaintext highlighter-rouge">Messages</code>), and fix <code class="language-plaintext highlighter-rouge">Update</code> so it can handle these new <code class="language-plaintext highlighter-rouge">RoutingMsg</code> messages:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Messages.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">(</span><span class="o">..</span><span class="p">))</span>

<span class="k">import</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">ContactMsg</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">ContactList</span><span class="o">.</span><span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">ContactListMsg</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Navigation</span>
<span class="k">import</span> <span class="kt">Routing</span><span class="o">.</span><span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">RoutingMsg</span><span class="p">)</span>


<span class="k">type</span> <span class="kt">Msg</span>
    <span class="o">=</span> <span class="kt">ContactMsg</span> <span class="kt">ContactMsg</span>
    <span class="o">|</span> <span class="kt">ContactListMsg</span> <span class="kt">ContactListMsg</span>
    <span class="o">|</span> <span class="kt">RoutingMsg</span> <span class="kt">RoutingMsg</span>
    <span class="o">|</span> <span class="kt">UpdateSearchQuery</span> <span class="kt">String</span>
    <span class="o">|</span> <span class="kt">UrlChange</span> <span class="kt">Navigation</span><span class="o">.</span><span class="kt">Location</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Update.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Update</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">update</span><span class="o">,</span> <span class="o">...</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Routing</span><span class="o">.</span><span class="kt">Update</span>
<span class="c1">-- ...</span>


<span class="n">update</span> <span class="p">:</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">msg</span> <span class="n">model</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">of</span>
        <span class="c1">-- ...</span>

        <span class="kt">RoutingMsg</span> <span class="n">msg</span> <span class="o">-&gt;</span>
            <span class="p">(</span> <span class="n">model</span><span class="o">,</span> <span class="kt">Routing</span><span class="o">.</span><span class="kt">Update</span><span class="o">.</span><span class="n">update</span> <span class="n">msg</span> <span class="p">)</span>
<span class="c1">-- ...</span>
</code></pre></div></div> <h2 id="use-routingmsg-in-contact-views">Use RoutingMsg in Contact Views</h2> <p>Once this is done, we will start focusing on <code class="language-plaintext highlighter-rouge">Contact</code>-related modules. You will find that a number of different view files have been affected by the creation of the <code class="language-plaintext highlighter-rouge">RoutingMsg</code>, so some references and type signatures will need to change.</p> <p>The Elm compiler should let you know about which modules need to have their <code class="language-plaintext highlighter-rouge">NavigateTo</code> references changed, but most of the edits will consist of changing references like:</p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">(</span><span class="kt">NavigateTo</span><span class="p">))</span>
</code></pre></div></div> <p>to something like:</p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">(</span><span class="kt">RoutingMsg</span><span class="p">))</span>
</code></pre></div></div> <p>or (depending on the file):</p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="kt">Routing</span><span class="o">.</span><span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">RoutingMsg</span><span class="p">(</span><span class="kt">NavigateTo</span><span class="p">))</span>
</code></pre></div></div> <p>as well as changing function declarations to return a <code class="language-plaintext highlighter-rouge">RoutingMsg</code>, rather than a <code class="language-plaintext highlighter-rouge">Msg</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Contact/View.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- ...</span>

<span class="k">import</span> <span class="kt">Routing</span><span class="o">.</span><span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">RoutingMsg</span><span class="p">(</span><span class="kt">NavigateTo</span><span class="p">))</span>
<span class="c1">-- ...</span>

<span class="n">view</span> <span class="p">:</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="kt">Html</span> <span class="kt">RoutingMsg</span>
<span class="c1">-- ...</span>

<span class="n">showView</span> <span class="p">:</span> <span class="kt">Contact</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">String</span><span class="o">,</span> <span class="kt">Html</span> <span class="kt">RoutingMsg</span> <span class="p">)</span>
<span class="c1">-- ...</span>

<span class="c1">-- etc etc change Msg to RoutingMsg for all the functions in this file ...</span>
</code></pre></div></div> <p>Again, the Elm compiler will guide you on where the references need to be changed.</p> <p>Next, there will be some messages across multiple concerns that will need to be <code class="language-plaintext highlighter-rouge">Html.map</code>ped into <code class="language-plaintext highlighter-rouge">RoutingMsg</code> messages:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/ContactList/View.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">ContactList</span><span class="o">.</span><span class="kt">View</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">view</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">(</span><span class="kt">RoutingMsg</span><span class="o">,</span> <span class="o">...</span><span class="p">))</span>
<span class="c1">-- ...</span>

<span class="n">contactsList</span> <span class="p">:</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="kt">ContactList</span> <span class="o">-&gt;</span> <span class="kt">Html</span> <span class="kt">Msg</span>
<span class="n">contactsList</span> <span class="n">model</span> <span class="n">page</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">totalEntries</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
        <span class="n">page</span><span class="o">.</span><span class="n">entries</span>
            <span class="o">|&gt;</span> <span class="kt">List</span><span class="o">.</span><span class="n">map</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">View</span><span class="o">.</span><span class="n">showView</span>
            <span class="o">|&gt;</span> <span class="kt">Keyed</span><span class="o">.</span><span class="n">node</span> <span class="s">"</span><span class="s2">div"</span> <span class="p">[</span> <span class="n">class</span> <span class="s">"</span><span class="s2">cards-wrapper"</span> <span class="p">]</span>
            <span class="o">|&gt;</span> <span class="kt">Html</span><span class="o">.</span><span class="n">map</span> <span class="kt">RoutingMsg</span>
    <span class="k">else</span>
      <span class="c1">-- ...</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/View.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">View</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">view</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">(</span><span class="kt">RoutingMsg</span><span class="p">))</span>
<span class="c1">-- ...</span>


<span class="n">page</span> <span class="p">:</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="kt">Html</span> <span class="kt">Msg</span>
<span class="n">page</span> <span class="n">model</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">model</span><span class="o">.</span><span class="n">route</span> <span class="k">of</span>
        <span class="c1">-- ...</span>

        <span class="kt">ShowContactRoute</span> <span class="n">id</span> <span class="o">-&gt;</span>
            <span class="n">model</span>
                <span class="o">|&gt;</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">View</span><span class="o">.</span><span class="n">view</span>
                <span class="o">|&gt;</span> <span class="kt">Html</span><span class="o">.</span><span class="n">map</span> <span class="kt">RoutingMsg</span>

        <span class="kt">NotFoundRoute</span> <span class="o">-&gt;</span>
            <span class="kt">Shared</span><span class="o">.</span><span class="kt">View</span><span class="o">.</span><span class="n">warningMessage</span>
                <span class="s">"</span><span class="s2">fa fa-meh-o fa-stack-2x"</span>
                <span class="s">"</span><span class="s2">Page not found"</span>
                <span class="p">(</span><span class="kt">Html</span><span class="o">.</span><span class="n">map</span> <span class="kt">RoutingMsg</span> <span class="kt">Shared</span><span class="o">.</span><span class="kt">View</span><span class="o">.</span><span class="n">backToHomeLink</span><span class="p">)</span>
</code></pre></div></div> <p>One final minor view-related change is in the signature for <code class="language-plaintext highlighter-rouge">Shared.View.warningMessage</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Shared/View.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">warningMessage</span> <span class="p">:</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Html</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="kt">Html</span> <span class="n">msg</span>
<span class="n">warningMessage</span> <span class="n">iconClasses</span> <span class="n">message</span> <span class="n">content</span> <span class="o">=</span>
    <span class="n">div</span> <span class="p">[</span> <span class="n">class</span> <span class="s">"</span><span class="s2">warning"</span> <span class="p">]</span>
        <span class="p">[</span> <span class="n">span</span> <span class="p">[</span> <span class="n">class</span> <span class="s">"</span><span class="s2">fa-stack"</span> <span class="p">]</span>
            <span class="p">[</span> <span class="n">i</span> <span class="p">[</span> <span class="n">class</span> <span class="n">iconClasses</span> <span class="p">]</span> <span class="p">[]</span> <span class="p">]</span>
        <span class="o">,</span> <span class="n">h4</span> <span class="p">[]</span>
            <span class="p">[</span> <span class="n">text</span> <span class="n">message</span> <span class="p">]</span>
        <span class="o">,</span> <span class="n">content</span>
        <span class="p">]</span>
</code></pre></div></div> <p>The change is ever-so-subtle: <code class="language-plaintext highlighter-rouge">Html Msg</code> to <code class="language-plaintext highlighter-rouge">Html msg</code>. This function is used in both <code class="language-plaintext highlighter-rouge">Contact</code> and <code class="language-plaintext highlighter-rouge">ContactList</code> views, and the message wrapped inside the <code class="language-plaintext highlighter-rouge">Html</code> could be a <code class="language-plaintext highlighter-rouge">ContactMsg</code> or a <code class="language-plaintext highlighter-rouge">Msg</code> type. Since the type of message is not consequential for the rendering of the warning message, we make the type signature ambivalent to the type of message provided and then returned back.</p> <p>And that should take care of View-related code, so on to <code class="language-plaintext highlighter-rouge">Contact.Update</code>!</p> <h2 id="hide-model-from-contactupdate">Hide Model from Contact.Update</h2> <p>Currently, in <code class="language-plaintext highlighter-rouge">Update</code>, we’re passing the whole <code class="language-plaintext highlighter-rouge">Model</code> off to <code class="language-plaintext highlighter-rouge">Contact.Update</code> when we receive a <code class="language-plaintext highlighter-rouge">ContactMsg</code>, and <code class="language-plaintext highlighter-rouge">Contact.Update.update</code> returns back a <code class="language-plaintext highlighter-rouge">(Model, Cmd Msg)</code>.</p> <p>However, <code class="language-plaintext highlighter-rouge">Contact.Update</code> should only be concerned with returning a new <code class="language-plaintext highlighter-rouge">Contact</code>: it does not need to know about the rest of the <code class="language-plaintext highlighter-rouge">Model</code>. Also, <code class="language-plaintext highlighter-rouge">Contact.Update</code> should only know how to return messages of its own type: <code class="language-plaintext highlighter-rouge">ContactMsg</code>. So, we want:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">Contact.Update.update</code> to return back a <code class="language-plaintext highlighter-rouge">(Contact, Cmd ContactMsg)</code> </li> <li>Have the <code class="language-plaintext highlighter-rouge">Update</code> module return a model with the new <code class="language-plaintext highlighter-rouge">Contact</code> </li> <li>Have the <code class="language-plaintext highlighter-rouge">Update</code> module convert the <code class="language-plaintext highlighter-rouge">ContactMsg</code> into a <code class="language-plaintext highlighter-rouge">Msg</code>.</li> </ul> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Update.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Update</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">update</span><span class="o">,</span> <span class="o">...</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">(</span><span class="kt">ContactMsg</span><span class="o">,</span> <span class="o">...</span><span class="p">))</span>
<span class="k">import</span> <span class="kt">Model</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Model</span><span class="o">,</span> <span class="o">...</span><span class="p">)</span>
<span class="c1">-- ...</span>

<span class="n">update</span> <span class="p">:</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">msg</span> <span class="n">model</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">of</span>
        <span class="kt">ContactMsg</span> <span class="n">msg</span> <span class="o">-&gt;</span>
            <span class="k">let</span>
                <span class="p">(</span> <span class="n">contact</span><span class="o">,</span> <span class="n">cmd</span> <span class="p">)</span> <span class="o">=</span>
                    <span class="kt">Contact</span><span class="o">.</span><span class="kt">Update</span><span class="o">.</span><span class="n">update</span> <span class="n">msg</span>
            <span class="k">in</span>
                <span class="p">(</span> <span class="p">{</span> <span class="n">model</span> <span class="o">|</span> <span class="n">contact</span> <span class="o">=</span> <span class="n">contact</span> <span class="p">}</span><span class="o">,</span> <span class="kt">Cmd</span><span class="o">.</span><span class="n">map</span> <span class="kt">ContactMsg</span> <span class="n">cmd</span> <span class="p">)</span>

<span class="c1">-- ...</span>
</code></pre></div></div> <p>Now that <code class="language-plaintext highlighter-rouge">Contact.Update.update</code> doesn’t receive a <code class="language-plaintext highlighter-rouge">Model</code> any more, let’s change it so that it returns the <code class="language-plaintext highlighter-rouge">(Contact, Cmd ContactMsg)</code> that <code class="language-plaintext highlighter-rouge">Update</code> now wants:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Contact/Update.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">Update</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">update</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">ContactMsg</span><span class="p">(</span><span class="kt">FetchContact</span><span class="p">))</span>
<span class="k">import</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">Model</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Contact</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">RemoteData</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">RemoteData</span><span class="o">,</span> <span class="kt">RemoteData</span><span class="p">(</span><span class="kt">Failure</span><span class="o">,</span> <span class="kt">Success</span><span class="p">))</span>


<span class="n">update</span> <span class="p">:</span> <span class="kt">ContactMsg</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">RemoteData</span> <span class="kt">String</span> <span class="kt">Contact</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">ContactMsg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">msg</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">of</span>
        <span class="kt">FetchContact</span> <span class="p">(</span><span class="kt">Ok</span> <span class="n">response</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="p">(</span> <span class="kt">Success</span> <span class="n">response</span><span class="o">,</span> <span class="kt">Cmd</span><span class="o">.</span><span class="n">none</span> <span class="p">)</span>

        <span class="kt">FetchContact</span> <span class="p">(</span><span class="kt">Err</span> <span class="n">error</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="p">(</span> <span class="kt">Failure</span> <span class="s">"</span><span class="s2">Contact not found"</span><span class="o">,</span> <span class="kt">Cmd</span><span class="o">.</span><span class="n">none</span> <span class="p">)</span>
</code></pre></div></div> <h2 id="contactcommands-should-return-contactmsgs">Contact.Commands should return ContactMsgs</h2> <p>Currently, the <code class="language-plaintext highlighter-rouge">Contact.Commands.fetchContact</code> function returns a top-level <code class="language-plaintext highlighter-rouge">Cmd Msg</code> type. What we want to do is have it instead return a <code class="language-plaintext highlighter-rouge">Cmd ContactMsg</code>, and have the caller of the function (in this case <code class="language-plaintext highlighter-rouge">Update.urlUpdate</code>) be responsible for <code class="language-plaintext highlighter-rouge">Cmd.map</code>ping the <code class="language-plaintext highlighter-rouge">ContactMsg</code> to a <code class="language-plaintext highlighter-rouge">Msg</code>.</p> <p>So, this is what we currently have:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Contact/Commands.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">Commands</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">fetchContact</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Commands</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">contactsApiUrl</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">Decoder</span> <span class="k">as</span> <span class="kt">Decoder</span>
<span class="k">import</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">ContactMsg</span><span class="p">(</span><span class="kt">FetchContact</span><span class="p">))</span>
<span class="k">import</span> <span class="kt">Http</span>
<span class="k">import</span> <span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">(</span><span class="kt">ContactMsg</span><span class="p">))</span>


<span class="n">fetchContact</span> <span class="p">:</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Cmd</span> <span class="kt">Msg</span>
<span class="n">fetchContact</span> <span class="n">id</span> <span class="o">=</span>
    <span class="k">let</span>
        <span class="n">apiUrl</span> <span class="o">=</span>
            <span class="n">contactsApiUrl</span> <span class="o">++</span> <span class="s">"</span><span class="s2">/"</span> <span class="o">++</span> <span class="n">toString</span> <span class="n">id</span>
    <span class="k">in</span>
        <span class="kt">Decoder</span><span class="o">.</span><span class="n">decoder</span>
            <span class="o">|&gt;</span> <span class="kt">Http</span><span class="o">.</span><span class="n">get</span> <span class="n">apiUrl</span>
            <span class="o">|&gt;</span> <span class="kt">Http</span><span class="o">.</span><span class="n">send</span> <span class="kt">FetchContact</span>
            <span class="o">|&gt;</span> <span class="kt">Cmd</span><span class="o">.</span><span class="n">map</span> <span class="kt">ContactMsg</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Update.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Update</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">update</span><span class="o">,</span> <span class="n">urlUpdate</span><span class="p">)</span>

<span class="c1">-- ...</span>

<span class="n">urlUpdate</span> <span class="p">:</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="n">urlUpdate</span> <span class="n">model</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">model</span><span class="o">.</span><span class="n">route</span> <span class="k">of</span>
        <span class="c1">-- ...</span>

        <span class="kt">ShowContactRoute</span> <span class="n">id</span> <span class="o">-&gt;</span>
            <span class="p">(</span> <span class="p">{</span> <span class="n">model</span> <span class="o">|</span> <span class="n">contact</span> <span class="o">=</span> <span class="kt">Requesting</span> <span class="p">}</span>
            <span class="o">,</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">Commands</span><span class="o">.</span><span class="n">fetchContact</span> <span class="n">id</span>
            <span class="p">)</span>

<span class="c1">-- ...</span>
</code></pre></div></div> <p>And this is what we need to change the files to:</p> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Contact/Commands.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">Commands</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">fetchContact</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Commands</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">contactsApiUrl</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">Decoder</span> <span class="k">as</span> <span class="kt">Decoder</span>
<span class="k">import</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">Messages</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">ContactMsg</span><span class="p">(</span><span class="kt">FetchContact</span><span class="p">))</span>
<span class="k">import</span> <span class="kt">Http</span>


<span class="n">fetchContact</span> <span class="p">:</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Cmd</span> <span class="kt">ContactMsg</span>
<span class="n">fetchContact</span> <span class="n">id</span> <span class="o">=</span>
    <span class="k">let</span>
        <span class="n">apiUrl</span> <span class="o">=</span>
            <span class="n">contactsApiUrl</span> <span class="o">++</span> <span class="s">"</span><span class="s2">/"</span> <span class="o">++</span> <span class="n">toString</span> <span class="n">id</span>
    <span class="k">in</span>
        <span class="kt">Decoder</span><span class="o">.</span><span class="n">decoder</span>
            <span class="o">|&gt;</span> <span class="kt">Http</span><span class="o">.</span><span class="n">get</span> <span class="n">apiUrl</span>
            <span class="o">|&gt;</span> <span class="kt">Http</span><span class="o">.</span><span class="n">send</span> <span class="kt">FetchContact</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">assets/elm/src/Update.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Update</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">update</span><span class="o">,</span> <span class="n">urlUpdate</span><span class="p">)</span>

<span class="c1">-- ...</span>

<span class="n">urlUpdate</span> <span class="p">:</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="n">urlUpdate</span> <span class="n">model</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">model</span><span class="o">.</span><span class="n">route</span> <span class="k">of</span>
        <span class="c1">-- ...</span>

        <span class="kt">ShowContactRoute</span> <span class="n">id</span> <span class="o">-&gt;</span>
            <span class="p">(</span> <span class="p">{</span> <span class="n">model</span> <span class="o">|</span> <span class="n">contact</span> <span class="o">=</span> <span class="kt">Requesting</span> <span class="p">}</span>
            <span class="o">,</span> <span class="n">id</span>
                <span class="o">|&gt;</span> <span class="kt">Contact</span><span class="o">.</span><span class="kt">Commands</span><span class="o">.</span><span class="n">fetchContact</span>
                <span class="o">|&gt;</span> <span class="kt">Cmd</span><span class="o">.</span><span class="n">map</span> <span class="kt">ContactMsg</span>

<span class="c1">-- ...</span>
</code></pre></div></div> <p>Phew! We’ve made quite a lot of changes across multiple files, so let’s see if it paid off!</p> <blockquote> <p>Having compilation problems? Compare what you’ve written with code in the <a href="https://github.com/paulfioravanti/phoenix-and-elm/tree/rest-refactor"><code class="language-plaintext highlighter-rouge">rest-refactor</code> branch of the Address App</a> and see if they match up.</p> </blockquote> <p>Re-generate the <code class="language-plaintext highlighter-rouge">module-graph.json</code> file (<code class="language-plaintext highlighter-rouge">./elm-module-graph.py src/Main.elm</code>), and re-upload it to <a href="https://justinmimbs.github.io/elm-module-graph/">https://justinmimbs.github.io/elm-module-graph/</a> and let’s see what the graph says:</p> <p><img src="/assets/images/2018-03-17/REST-branch-Messages-Contact-refactored.png" alt="REST branch Messages Contact refactored" title="REST branch Messages Contact refactored" class="img-responsive"></p> <p>Awesome! Modules in the <code class="language-plaintext highlighter-rouge">Contact</code> concern now have no direct dependencies with the top level <code class="language-plaintext highlighter-rouge">Messages</code> module!</p> <p>I have attempted to take this even further by removing <code class="language-plaintext highlighter-rouge">ContactList</code> dependencies in the <code class="language-plaintext highlighter-rouge">Messages</code> module, and you can see the results of that in the <a href="https://github.com/paulfioravanti/phoenix-and-elm/tree/rest-refactor"><code class="language-plaintext highlighter-rouge">rest-refactor</code> branch of the Address App</a> if you are interested. Suffice to say, the graph now looks like:</p> <p><img src="/assets/images/2018-03-17/REST-branch-Messages-post-refactor.png" alt="REST branch Messages post-refactor" title="REST branch Messages post-refactor" class="img-responsive"></p> <p>Not bad! With further refactoring and re-architecting, maybe I could remove <code class="language-plaintext highlighter-rouge">ContactList.View</code> from this list, but I’m done fighting with types for now <img class="emoji" title=":sweat_smile:" alt=":sweat_smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png" height="20" width="20"></p> <h2 id="conclusion">Conclusion</h2> <p>I found that using <a href="https://github.com/justinmimbs/elm-module-graph">elm-module-graph</a> was helpful in getting a high level overview of my Elm application, determining where potential compilation bottlenecks could appear, and deciding how to structure modules.</p> <p>Is the way I architected and then refactored the application presented here a “good” way to do it? At this stage, I do not know. I am very happy to be shown to be wrong about this, but for now, this way of doing things (less massive files; more smaller functions in smaller modules under concern directories) <em>feels</em> right to me, especially since I do not know of any “official” guidance on this.</p> <p>Regardless, on your next Elm project, give generating a graph for it a try for some easy-to-digest information about its dependencies!</p> </section> <footer class="page__meta"> <p class="page__taxonomy"> <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong> <span itemprop="keywords"> <a href="/tags/architecture" class="page__taxonomy-item" rel="tag">architecture</a><span class="sep">, </span> <a href="/tags/elm" class="page__taxonomy-item" rel="tag">elm</a><span class="sep">, </span> <a href="/tags/graphs" class="page__taxonomy-item" rel="tag">graphs</a><span class="sep">, </span> <a href="/tags/refactoring" class="page__taxonomy-item" rel="tag">refactoring</a> </span> </p> <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-07-24">July 24, 2023</time></p> </footer> <section class="page__share"> <h4 class="page__share-title">Share on</h4> <a href="https://twitter.com/intent/tweet?via=paulfioravanti&amp;text=Graph-driven+Refactoring+in+Elm%20https%3A%2F%2Fwww.paulfioravanti.com%2Fblog%2Fgraph-driven-refactoring-elm%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.paulfioravanti.com%2Fblog%2Fgraph-driven-refactoring-elm%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.paulfioravanti.com%2Fblog%2Fgraph-driven-refactoring-elm%2F&amp;title=Graph-driven%20Refactoring%20in%20Elm" class="btn btn--reddit" title="Share on Reddit"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i><span> Reddit</span></a> <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fwww.paulfioravanti.com%2Fblog%2Fgraph-driven-refactoring-elm%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a> </section> <nav class="pagination"> <a href="/blog/migrate-phoenix-elm-app-rest-graphql/" class="pagination--pager" title="Migrating a Phoenix and Elm app from REST to GraphQL ">Previous</a> <a href="/blog/runtime-language-switching-elm/" class="pagination--pager" title="Runtime Language Switching in Elm ">Next</a> </nav> </div> <div class="page__comments"> <h4 class="page__comments-title">Leave a comment</h4> <section id="disqus_thread"></section> </div> </article> <div class="page__related"> <h4 class="page__related-title">You may also enjoy</h4> <div class="grid__wrapper"> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2024-02-04/doc-brown-cable-connect.jpg" alt="Doc Brown from the movie Back to the Future connecting a plug and socket"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/creating-plover-plugins-python/" rel="permalink">Creating Plover Plugins with Python </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2024-02-04T21:35:00+11:00">February 4, 2024</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 44 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Level up your steno chording with the power of Python! Hook into Plover plugins, and discover a world beyond keystrokes. </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2023-12-07/celpax-1Lf5Adh9SCg-unsplash.jpg" alt="person holding white card near green plant"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/coding-test-review-culture-amp/" rel="permalink">Coding Test Review: Culture Amp </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2023-12-07T15:10:00+11:00">December 7, 2023</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 20 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Did I feel empowered to get the coding tests done for which I am responsible? </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2023-10-25/dot-matrix-printer.jpg" alt="Epson LX-300+ dot matrix printer with optional colour kit"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/same-page-hid-device/" rel="permalink">Get on the Same Page as your HID Device </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2023-10-25T16:25:00+11:00">October 25, 2023</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 14 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Does communicating with your HID device seem flaky? You may be looking at the wrong (usage) page. </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2023-04-28/obama-medal.jpg" alt="Obama gives medal to himself meme"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/thanks-past-me/" rel="permalink">Thanks, Past-Me </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2023-04-28T15:30:00+10:00">April 28, 2023</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 19 minute read </span> <span class="page__meta-sep"></span> <i class="fas fa-microphone" aria-hidden="true"></i> Audio Narration </p> <p class="archive__item-excerpt" itemprop="description">Past-me wrote stuff down that benefited future-me. Present-me needs to keep paying that forward. </p> </article> </div> </div> </div> </div> </div> <div class="search-content"> <div class="search-content__inner-wrap"> <form class="search-content__form" onkeydown="return event.key != 'Enter';"> <label class="sr-only" for="search"> Enter your search term... </label> <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..."> </form> <div id="results" class="results"></div> </div> </div> <div id="footer" class="page__footer"> <footer> <div class="page__footer-follow"> <ul class="social-icons"> <li><strong>Follow:</strong></li> <li> <a href="/privacy"> <i class="fas fa-user-shield"></i> Privacy Policy </a> </li> <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li> </ul> </div> <div class="page__footer-copyright">© 2024 Paul Fioravanti. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div> </footer> </div> <script src="/assets/js/main.min.js"></script> <script src="/assets/js/lunr/lunr.min.js"></script> <script src="/assets/js/lunr/lunr-store.js"></script> <script src="/assets/js/lunr/lunr-en.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-Q173829KF7"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-Q173829KF7",{anonymize_ip:!1});</script> <script>var disqus_config=function(){this.page.url="https://www.paulfioravanti.com/blog/graph-driven-refactoring-elm/",this.page.identifier="/blog/graph-driven-refactoring-elm"};!function(){var t=document,e=t.createElement("script");e.src="https://paulfioravanti.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}();</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript> </body> </html>