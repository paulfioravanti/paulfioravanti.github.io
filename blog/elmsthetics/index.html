<!doctype html> <html lang="en" class="no-js"> <head> <meta charset="utf-8"> <title>░▒▓ＥＬＭＳＴＨＥＴＩＣＳ▓▒░ | Floor and Varnish</title> <meta name="description" content="Tech moves pretty fast. If you don’t stop and do a side project once in a while, you could miss it."> <meta name="author" content="Paul Fioravanti"> <meta property="article:author" content="Paul Fioravanti"> <meta property="og:type" content="article"> <meta property="og:locale" content="en_US"> <meta property="og:site_name" content="Floor and Varnish"> <meta property="og:title" content="░▒▓ＥＬＭＳＴＨＥＴＩＣＳ▓▒░"> <meta property="og:url" content="https://www.paulfioravanti.com/blog/elmsthetics/"> <meta property="og:description" content="Tech moves pretty fast. If you don’t stop and do a side project once in a while, you could miss it."> <meta property="og:image" content="https://www.paulfioravanti.com/assets/images/2021-05-02/synthwave-3941721_1280_cropped.jpg"> <meta name="twitter:site" content="@paulfioravanti"> <meta name="twitter:title" content="░▒▓ＥＬＭＳＴＨＥＴＩＣＳ▓▒░"> <meta name="twitter:description" content="Tech moves pretty fast. If you don’t stop and do a side project once in a while, you could miss it."> <meta name="twitter:url" content="https://www.paulfioravanti.com/blog/elmsthetics/"> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:image" content="https://www.paulfioravanti.com/assets/images/2021-05-02/synthwave-3941721_1280_cropped.jpg"> <meta name="twitter:creator" content="@paulfioravanti"> <meta property="article:published_time" content="2021-05-02T13:40:00+10:00"> <meta property="article:modified_time" content="2021-05-02T13:40:00+10:00"> <link rel="canonical" href="https://www.paulfioravanti.com/blog/elmsthetics/"> <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Paul Fioravanti",
      "url": "https://www.paulfioravanti.com/",
      "sameAs": ["https://twitter.com/paulfioravanti","https://www.linkedin.com/in/paulfioravanti","https://github.com/paulfioravanti","https://stackoverflow.com/users/567863/paul-fioravanti"]
    
  }
</script> <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Floor and Varnish Feed"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <script>document.documentElement.className=document.documentElement.className.replace(/\bno-js\b/g,"")+" js ";</script> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"> <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript> </head> <body class="layout--single wide"> <nav class="skip-links"> <ul> <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li> <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li> <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li> </ul> </nav> <!--[if lt IE 9]><div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]--> <div class="masthead"> <div class="masthead__inner-wrap"> <div class="masthead__menu"> <nav id="site-nav" class="greedy-nav"> <a class="site-title" href="/"> Floor and Varnish </a> <ul class="visible-links"><li class="masthead__menu-item"> <a href="/about/">About</a> </li></ul> <button class="search__toggle" type="button"> <span class="visually-hidden">Toggle search</span> <i class="fas fa-search"></i> </button> <button class="greedy-nav__toggle hidden" type="button"> <span class="visually-hidden">Toggle menu</span> <div class="navicon"></div> </button> <ul class="hidden-links hidden"></ul> </nav> </div> </div> </div> <div class="initial-content"> <div class="page__hero--overlay" style=" background-image: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.1)), url('/assets/images/2021-05-02/synthwave-3941721_1280_cropped.jpg');"> <div class="wrapper"> <h1 id="page-title" class="page__title" itemprop="headline"> ░▒▓ＥＬＭＳＴＨＥＴＩＣＳ▓▒░ </h1> <p class="page__lead">Tech moves pretty fast. If you don’t stop and do a side project once in a while, you could miss it. </p> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-calendar-alt" aria-hidden="true"></i> <time datetime="2021-05-02T13:40:00+10:00">May 2, 2021</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-clock" aria-hidden="true"></i> 43 minute read </span> </p> <a href="http://www.elmweekly.nl/issues/elm-weekly-issue-159-582848" style="text-decoration: none;"> <img src="https://img.shields.io/badge/Elm%20Weekly-%23159-green.svg" alt="Elm Weekly #159"> </a> </div> <span class="page__hero-caption">Image by <a href="https://pixabay.com/users/iywbr-11282422/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3941721">iywbr</a> from <a href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3941721">Pixabay</a> </span> </div> <div id="main" role="main"> <div class="sidebar sticky"> <div itemscope itemtype="https://schema.org/Person"> <div class="author__avatar"> <a href="/"> <img src="https://s.gravatar.com/avatar/abda861707b1e78e0fce47ced55f84ee" alt="Paul Fioravanti" itemprop="image"> </a> </div> <div class="author__content"> <a href="/"><h3 class="author__name" itemprop="name">Paul Fioravanti</h3></a> <div class="author__bio" itemprop="description"> <p><img class="emoji" title=":heart:" alt=":heart:" src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png" height="20" width="20"> code / <img class="emoji" title=":heart:" alt=":heart:" src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png" height="20" width="20"> languages <img class="emoji" title=":it:" alt=":it:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f1ee-1f1f9.png" height="20" width="20"> <img class="emoji" title=":jp:" alt=":jp:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f1ef-1f1f5.png" height="20" width="20"> / <img class="emoji" title=":heart:" alt=":heart:" src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png" height="20" width="20"> mech <img class="emoji" title=":keyboard:" alt=":keyboard:" src="https://github.githubassets.com/images/icons/emoji/unicode/2328.png" height="20" width="20"> / Learning stenography</p> </div> </div> <div class="author__urls-wrapper"> <button class="btn btn--inverse">Follow</button> <ul class="author__urls social-icons"> <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place"> <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Sydney, Australia</span> </li> <li> <a href="https://www.paulfioravanti.com" itemprop="url"> <i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span> </a> </li> <li> <a href="mailto:paul@paulfioravanti.com"> <meta itemprop="email" content="paul@paulfioravanti.com"> <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span> </a> </li> <li> <a href="https://keybase.io/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fas fa-fw fa-key" aria-hidden="true"></i><span class="label">Keybase</span> </a> </li> <li> <a href="https://twitter.com/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span> </a> </li> <li> <a href="https://www.linkedin.com/in/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span> </a> </li> <li> <a href="https://github.com/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span> </a> </li> <li> <a href="https://stackoverflow.com/users/567863/paul-fioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-stack-overflow" aria-hidden="true"></i><span class="label">Stack Overflow</span> </a> </li> <li> <a href="https://www.youtube.com/channel/UC_ObnUGtIfRRq6vbxFYRpUg" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-youtube" aria-hidden="true"></i><span class="label">YouTube</span> </a> </li> <li> <a href="https://www.strava.com/athletes/paulfioravanti" itemprop="sameAs" rel="nofollow noopener noreferrer me"> <i class="fab fa-strava" aria-hidden="true"></i> Strava </a> </li> </ul> </div> </div> <div id="bd_embed_signup"> <form action="https://buttondown.email/api/emails/embed-subscribe/paulfioravanti" method="post" target="popupwindow" onsubmit="window.open('https://buttondown.email/paulfioravanti', 'popupwindow')" class="embeddable-buttondown-form"> <label for="bd-email">Get notified of new posts!</label> <input type="email" name="email" id="bd-email" class="email" placeholder="email address"> <input type="hidden" value="1" name="embed"> <div class="clear"> <input type="submit" value="Subscribe" id="bd-embedded-subscribe" class="button"> </div> <p> I send email when I have new content to share. No spam; unsubscribe at any time. <a href="/privacy">Privacy Policy</a> </p> </form> </div> </div> <article class="page" itemscope itemtype="https://schema.org/CreativeWork"> <meta itemprop="headline" content="░▒▓ＥＬＭＳＴＨＥＴＩＣＳ▓▒░"> <meta itemprop="description" content="Tech moves pretty fast. If you don’t stop and do a side project once in a while, you could miss it."> <meta itemprop="datePublished" content="2021-05-02T13:40:00+10:00"> <meta itemprop="dateModified" content="2021-05-02T13:40:00+10:00"> <div class="page__inner-wrap"> <section class="page__content" itemprop="text"> <p><a href="http://www.80sfy.com/">80sfy.com</a>, by <a href="http://www.digitalbloc.com/">Art Sangurai</a>, is a pretty cool site if you love <a href="https://en.wikipedia.org/wiki/Synthwave">synthwave</a> music or the 1980s in general.</p> <p>It uses a <a href="https://soundcloud.com/">SoundCloud</a> and <a href="https://giphy.com/">Giphy</a> combination for maximum <span style="color: #ff2975; font-weight: bold;">ＡＥＳＴＨＥＴＩＣ</span> effect to make you <span style="color: #42c6ff; font-weight: bold">ＦＥＥＬ </span> all the nostalgias, which got it <a href="https://www.reddit.com/r/outrun/comments/5rdvks/my_boyfriend_made_a_website_that_plays_synthwave/">a lot of love on Reddit</a>.</p> <div style="margin: auto; text-align: center; width: 90%;"> <figure style="display: block"> <img src="/assets/images/2021-05-02/80sfy-screenshot.png" alt="80sfy.com screenshot"> </figure> </div> <p>It is programmed primarily in <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript">Javascript</a> with the <a href="https://reactjs.org/">React</a> library. So, I decided to re-create it using <a href="https://elm-lang.org/">Elm</a> because why not, but also just because…</p> <div style="margin: auto; text-align: center; width: 80%;"> <figure style="display: block"> <img src="/assets/images/2021-05-02/programming-in-elm-is-rad.jpg" alt="Programming in Elm is pretty rad!"> <figcaption style="text-align: center;"> Retro Wave at <a href="https://photofunia.com/categories/all_effects/retro-wave">PhotoFunia</a> </figcaption> </figure> </div> <p>You can see the results of those efforts here:</p> <ul> <li><a href="https://www.paulfioravanti.com/80sfy/">Elm 80sfy Website</a></li> <li><a href="https://github.com/paulfioravanti/80sfy">Elm 80sfy Codebase</a></li> </ul> <p>If the technical details of coding with Elm aren’t your thing, you can stop reading here and just go and enjoy some <a href="https://www.paulfioravanti.com/80sfy/">ＯＵＴＲＵＮ beats</a>.</p> <p>Still here? Okay, man, let’s talk some Elm learnings. Open up the codebase and follow along.</p> <h2 id="first-you-gotta-do-the-random-shuffle">First, you gotta do the Random Shuffle</h2> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/chunk-glitched.png" alt="Chunk from the Goonies"> </figure> </div> <p>There are two scenarios in the 80sfy application where an element of randomness is required:</p> <ol> <li>Shuffling the order of tracks to be played in the SoundCloud playlist</li> <li>Getting a random animated <a href="https://en.wikipedia.org/wiki/GIF">GIF</a> URL from Giphy: the application supplies a random descriptive tag, and Giphy sends back a URL that is relevant to that tag</li> </ol> <p>Unlike many other programming languages, there is no <code class="language-plaintext highlighter-rouge">Math.random()</code> or equivalent function in Elm that allows you to summon random numbers and use them on the spot.</p> <p>Generating random numbers, or doing anything involving randomness like randomly shuffling or picking an item from a list, is the responsibility of the <a href="https://elmprogramming.com/elm-runtime.html">Elm Runtime</a>. In order get a random number, you need to:</p> <ul> <li>code up a <em>description</em> of the kind of random number you want to generate</li> <li>send that description off to the Elm Runtime as a <a href="https://package.elm-lang.org/packages/elm/core/latest/Platform.Cmd"><code class="language-plaintext highlighter-rouge">Cmd</code></a> to have the number generated for you</li> <li>handle the resulting message you get returned from Elm Runtime containing the random number</li> </ul> <h3 id="creating-a-random-list-of-numbers">Creating a Random List of Numbers</h3> <p>Let’s have a look at a simplified-down example of the first scenario for randomising the order of tracks in a playlist. First though, a bit of context around how the SoundCloud <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe">IFrame</a> widget interacts with the Elm application.</p> <p>The <a href="https://developers.soundcloud.com/docs/api/html5-widget">SoundCloud Widget API</a> has a <code class="language-plaintext highlighter-rouge">getSounds(callback)</code> method that returns the list of sound objects in its playlist. In the Elm application, though, we do not need all of that information: as long as we can get the <em>length</em> of the widget’s playlist, we can build up our own list of integer track indexes to determine the order that tracks should play.</p> <p>When the Elm application wants to tell the SoundCloud player to play a track, it sends over an index number <span style="font-family: serif; font-style: italic; font-size: larger;"> n</span>, and the SoundCloud player “skips” over to track <span style="font-family: serif; font-style: italic; font-size: larger;">n </span> in its playlist.</p> <div style="margin: auto; text-align: center; width: 100%;"> <figure style="display: block"> <img src="/assets/images/2021-05-02/andy-organ-glitched.png" alt="The Goonies on the bone piano"> </figure> </div> <p>So, let’s pick up our story at the point when an Elm <a href="https://package.elm-lang.org/packages/elm/core/latest/Platform.Sub"><code class="language-plaintext highlighter-rouge">Sub</code>scription</a> has:</p> <ul> <li>received the <code class="language-plaintext highlighter-rouge">playlistLength</code> via an incoming <a href="https://guide.elm-lang.org/interop/ports.html">Port</a> message from Javascript (much more to say about ports later…)</li> <li>wrapped it in a <code class="language-plaintext highlighter-rouge">PlaylistLengthFetched</code> message</li> <li>sent the message off to the Elm Runtime…</li> <li>…which is then handled in the <code class="language-plaintext highlighter-rouge">update</code> function for the <code class="language-plaintext highlighter-rouge">AudioPlayer</code> </li> </ul> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">update</span> <span class="p">:</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">AudioPlayer</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">AudioPlayer</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">msg</span> <span class="n">audioPlayer</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">of</span>
        <span class="c1">-- ...</span>
        <span class="kt">PlaylistLengthFetched</span> <span class="n">playlistLength</span> <span class="o">-&gt;</span>
            <span class="k">let</span>
                <span class="n">generatePlaylist</span> <span class="p">:</span> <span class="kt">Cmd</span> <span class="kt">Msg</span>
                <span class="n">generatePlaylist</span> <span class="o">=</span>
                    <span class="kt">Playlist</span><span class="o">.</span><span class="n">generate</span> <span class="n">playlistLength</span>
            <span class="k">in</span>
            <span class="p">(</span> <span class="p">{</span> <span class="n">audioPlayer</span> <span class="o">|</span> <span class="n">playlistLength</span> <span class="o">=</span> <span class="n">playlistLength</span> <span class="p">}</span>
            <span class="o">,</span> <span class="n">generatePlaylist</span>
            <span class="p">)</span>
</code></pre></div></div> <p>Here, the <code class="language-plaintext highlighter-rouge">playlistLength</code> value is passed off to a <code class="language-plaintext highlighter-rouge">Playlist.generate</code> function, which defines the generation of a shuffled list of track indexes, and returns a <code class="language-plaintext highlighter-rouge">Cmd</code> to get the Elm Runtime to do the work of actually generating the playlist. Let’s have a look at how that randomness is created:</p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Playlist</span> <span class="k">exposing</span>
    <span class="p">(</span> <span class="n">generate</span>
    <span class="o">,</span> <span class="c1">-- ...</span>
    <span class="p">)</span>

<span class="k">import</span> <span class="kt">Random</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Generator</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Random</span><span class="o">.</span><span class="kt">List</span>

<span class="c1">-- ...</span>

<span class="n">generate</span> <span class="p">:</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Cmd</span> <span class="kt">Msg</span>
<span class="n">generate</span> <span class="n">playlistLength</span> <span class="o">=</span>
    <span class="k">let</span>
        <span class="n">trackList</span> <span class="p">:</span> <span class="kt">List</span> <span class="kt">Int</span>
        <span class="n">trackList</span> <span class="o">=</span>
            <span class="kt">List</span><span class="o">.</span><span class="n">range</span> <span class="mi">0</span> <span class="p">(</span><span class="n">playlistLength</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">generator</span> <span class="p">:</span> <span class="kt">Generator</span> <span class="p">(</span><span class="kt">List</span> <span class="kt">Int</span><span class="p">)</span> 
        <span class="n">generator</span> <span class="o">=</span>
            <span class="kt">Random</span><span class="o">.</span><span class="kt">List</span><span class="o">.</span><span class="n">shuffle</span> <span class="n">trackList</span>
    <span class="k">in</span>
    <span class="kt">Random</span><span class="o">.</span><span class="n">generate</span> <span class="kt">PlaylistGenerated</span> <span class="n">generator</span>
</code></pre></div></div> <p>Here, we specify that:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">List.range</code> should build a simple list of integers</li> <li>the <a href="https://package.elm-lang.org/packages/elm-community/random-extra/latest/Random-List#shuffle"><code class="language-plaintext highlighter-rouge">Random.List.shuffle</code></a> function from the <a href="https://package.elm-lang.org/packages/elm-community/random-extra/latest"><code class="language-plaintext highlighter-rouge">Random.Extra</code></a> package, which returns a <a href="https://package.elm-lang.org/packages/elm/random/latest/Random#Generator"><code class="language-plaintext highlighter-rouge">Generator</code></a> from the <a href="https://package.elm-lang.org/packages/elm/random/latest/Random"><code class="language-plaintext highlighter-rouge">Random</code></a> package, should shuffle the list</li> </ul> <p>We now have our recipe defined for the <code class="language-plaintext highlighter-rouge">generator</code> (<em>how</em> we want a random number generated), so we:</p> <ul> <li>specify that we want to have the generated playlist sent back to us from the Elm Runtime wrapped in a <code class="language-plaintext highlighter-rouge">PlaylistGenerated</code> message (defined as <code class="language-plaintext highlighter-rouge">PlaylistGenerated (List Int)</code> so the message has a place to hold the playlist)</li> <li>send it off to the Elm Runtime with the <a href="https://package.elm-lang.org/packages/elm/random/latest/Random#generate"><code class="language-plaintext highlighter-rouge">Random.generate</code></a> function</li> <li>handle the <code class="language-plaintext highlighter-rouge">PlaylistGenerated</code> message from the Elm Runtime in the <code class="language-plaintext highlighter-rouge">update</code> function</li> </ul> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">update</span> <span class="p">:</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">AudioPlayer</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">AudioPlayer</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">msg</span> <span class="n">audioPlayer</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">of</span>
        <span class="c1">-- ...</span>
        <span class="kt">PlaylistGenerated</span> <span class="n">generatedPlaylist</span> <span class="o">-&gt;</span>
            <span class="k">let</span>
                <span class="p">(</span> <span class="n">playlist</span><span class="o">,</span> <span class="n">cmd</span> <span class="p">)</span> <span class="o">=</span>
                    <span class="kt">Playlist</span><span class="o">.</span><span class="n">handleNextTrackNumberRequest</span>
                        <span class="n">generatedPlaylist</span>
                        <span class="n">audioPlayer</span><span class="o">.</span><span class="n">playlistLength</span>
            <span class="k">in</span>
            <span class="p">(</span> <span class="p">{</span> <span class="n">audioPlayer</span> <span class="o">|</span> <span class="n">playlist</span> <span class="o">=</span> <span class="n">playlist</span> <span class="p">}</span><span class="o">,</span> <span class="n">cmd</span> <span class="p">)</span>
</code></pre></div></div> <p>The details of the <code class="language-plaintext highlighter-rouge">Playlist.handleNextTrackNumberRequest</code> function are not needed for this example, but it essentially pops off the first number in the randomised <code class="language-plaintext highlighter-rouge">generatedPlaylist</code>, tells the SoundCloud widget to play the track in its playlist located at that index, and stores the remaining <code class="language-plaintext highlighter-rouge">playlist</code> in the <code class="language-plaintext highlighter-rouge">audioPlayer</code> model.</p> <p>But, the main point here is that we have requested the Elm Runtime to generate a random list of integers for us, it has done so, and we have been able to store it in our model! If you want to dig deeper, check out <a href="https://github.com/paulfioravanti/80sfy/blob/master/src/AudioPlayer/Playlist.elm">the real <code class="language-plaintext highlighter-rouge">Playlist</code> code</a>.</p> <p>We have covered audio playlist generation, but in this application, you cannot have random tracks without random GIFs as well! This time though, rather than generate a list, we want to be able to randomly <em>pick</em> a tag from a static list and send it off to Giphy, so let’s see how to do that.</p> <h3 id="randomly-picking-from-a-list">Randomly Picking from a List</h3> <p>When the 80sfy application first starts, it goes and fetches a list of descriptive string tags from a local <code class="language-plaintext highlighter-rouge">tags.json</code> file, emitting a <code class="language-plaintext highlighter-rouge">TagsFetched</code> message once that has been attempted, which is then handled in the <code class="language-plaintext highlighter-rouge">update</code> function for the application’s <code class="language-plaintext highlighter-rouge">SecretConfig</code> model (have you found the application’s secret config yet…? <img class="emoji" title=":wink:" alt=":wink:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f609.png" height="20" width="20">) in a similar way to the following:</p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">update</span> <span class="p">:</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">SecretConfig</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">Config</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">msg</span> <span class="n">secretConfig</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">of</span>
        <span class="c1">-- ...</span>
        <span class="kt">TagsFetched</span> <span class="p">(</span><span class="kt">Ok</span> <span class="n">tags</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">let</span>
                <span class="n">generateRandomTagForVideoPlayer</span> <span class="p">:</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Cmd</span> <span class="kt">Msg</span>
                <span class="n">generateRandomTagForVideoPlayer</span> <span class="n">videoPlayerId</span> <span class="o">=</span>
                    <span class="kt">Tag</span><span class="o">.</span><span class="n">generateRandomTag</span> <span class="n">videoPlayerId</span> <span class="n">tags</span>

                <span class="c1">-- ...</span>
            <span class="k">in</span>
            <span class="p">(</span> <span class="p">{</span> <span class="n">secretConfig</span> <span class="o">|</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span> <span class="p">}</span>
            <span class="o">,</span> <span class="kt">Cmd</span><span class="o">.</span><span class="n">batch</span>
                <span class="p">[</span> <span class="n">generateRandomTagForVideoPlayer</span> <span class="s">"</span><span class="s2">1"</span>
                <span class="o">,</span> <span class="n">generateRandomTagForVideoPlayer</span> <span class="s">"</span><span class="s2">2"</span>
                <span class="o">,</span> <span class="c1">-- ...</span>
                <span class="p">]</span>
            <span class="p">)</span>

        <span class="kt">TagsFetched</span> <span class="p">(</span><span class="kt">Err</span> <span class="n">error</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="c1">-- ...</span>
</code></pre></div></div> <p>Once the tags have been read in, we store them in the <code class="language-plaintext highlighter-rouge">secretConfig</code> model, and then send out two <code class="language-plaintext highlighter-rouge">Cmd</code>s to generate random tags, one for each <code class="language-plaintext highlighter-rouge">videoPlayer</code> in the application (yes, there are two, which <a href="https://en.wikipedia.org/wiki/Dissolve_(filmmaking)">crossfade</a> between each other).</p> <p>Let’s take a closer look at the <code class="language-plaintext highlighter-rouge">Tag.generateRandomTag</code> function, that, like the <code class="language-plaintext highlighter-rouge">Playlist.generate</code> function earlier, is responsible for creating a random generator:</p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Tag</span> <span class="k">exposing</span>
    <span class="p">(</span> <span class="n">generateRandomTag</span>
    <span class="o">,</span> <span class="c1">-- ...</span>
    <span class="p">)</span>

<span class="k">import</span> <span class="kt">Random</span>
<span class="c1">-- ...</span>


<span class="n">generateRandomTag</span> <span class="p">:</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">List</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Cmd</span> <span class="kt">Msg</span>
<span class="n">generateRandomTag</span> <span class="n">videoPlayerId</span> <span class="n">tags</span> <span class="o">=</span>
    <span class="k">let</span>
        <span class="n">tagsLength</span> <span class="p">:</span> <span class="kt">Int</span>
        <span class="n">tagsLength</span> <span class="o">=</span>
            <span class="kt">List</span><span class="o">.</span><span class="n">length</span> <span class="n">tags</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">randomTagIndex</span> <span class="p">:</span> <span class="kt">Generator</span> <span class="kt">Int</span>
        <span class="n">randomTagIndex</span> <span class="o">=</span>
            <span class="kt">Random</span><span class="o">.</span><span class="n">int</span> <span class="mi">0</span> <span class="n">tagsLength</span>

        <span class="n">generator</span> <span class="p">:</span> <span class="kt">Generator</span> <span class="kt">String</span>
        <span class="n">generator</span> <span class="o">=</span>
            <span class="kt">Random</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">atIndex</span> <span class="n">tags</span><span class="p">)</span> <span class="n">randomTagIndex</span>

        <span class="n">randomTagGeneratedMsg</span> <span class="p">:</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
        <span class="n">randomTagGeneratedMsg</span> <span class="o">=</span>
            <span class="p">(</span><span class="kt">RandomTagGenerated</span> <span class="n">videoPlayerId</span><span class="p">)</span>
    <span class="k">in</span>
    <span class="kt">Random</span><span class="o">.</span><span class="n">generate</span> <span class="n">randomTagGeneratedMsg</span> <span class="n">generator</span>


<span class="n">atIndex</span> <span class="p">:</span> <span class="kt">List</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">atIndex</span> <span class="n">tags</span> <span class="n">index</span> <span class="o">=</span>
    <span class="k">let</span>
        <span class="n">defaultTag</span> <span class="p">:</span> <span class="kt">String</span>
        <span class="n">defaultTag</span> <span class="o">=</span>
            <span class="s">"</span><span class="s2">80s"</span>
    <span class="k">in</span>
    <span class="n">tags</span>
        <span class="o">|&gt;</span> <span class="kt">List</span><span class="o">.</span><span class="n">drop</span> <span class="n">index</span>
        <span class="o">|&gt;</span> <span class="kt">List</span><span class="o">.</span><span class="n">head</span>
        <span class="o">|&gt;</span> <span class="kt">Maybe</span><span class="o">.</span><span class="n">withDefault</span> <span class="n">defaultTag</span>
</code></pre></div></div> <p>It looks like randomly picking from a static list is a little bit more involved than generating a new random list. So, what’s going on?</p> <ul> <li>We specify that <a href="https://package.elm-lang.org/packages/elm/random/latest/Random#int"><code class="language-plaintext highlighter-rouge">Random.int</code></a> should generate a random index number between zero and the length of the <code class="language-plaintext highlighter-rouge">tags</code> list</li> <li>We then use <a href="https://package.elm-lang.org/packages/elm/random/latest/Random#map"><code class="language-plaintext highlighter-rouge">Random.map</code></a> to create the generator that transforms that random index into the tag at the <code class="language-plaintext highlighter-rouge">randomTagIndex</code> of the <code class="language-plaintext highlighter-rouge">tags</code> list. (All lists in Elm are <a href="https://en.wikipedia.org/wiki/Linked_list">linked lists</a>, with the potential to contain <code class="language-plaintext highlighter-rouge">Nothing</code> when we interrogate their contents, which explains the ceremony contained in the <code class="language-plaintext highlighter-rouge">atIndex</code> function, and why we cannot just write something like <code class="language-plaintext highlighter-rouge">tags[index]</code>)</li> <li>We then specify that we want to have the tag sent back to us wrapped in a <code class="language-plaintext highlighter-rouge">RandomTagGenerated</code> message (defined as <code class="language-plaintext highlighter-rouge">RandomTagGenerated String String</code> so the message has a place to hold both the <code class="language-plaintext highlighter-rouge">videoPlayerId</code> the tag is for, as well as the generated tag itself)</li> <li>Finally, like in the previous example, we call <a href="https://package.elm-lang.org/packages/elm/random/latest/Random#generate"><code class="language-plaintext highlighter-rouge">Random.generate</code></a> with the message to be handled in the <code class="language-plaintext highlighter-rouge">update</code> function, and the <code class="language-plaintext highlighter-rouge">generator</code> itself</li> </ul> <p>The <code class="language-plaintext highlighter-rouge">RandomTagGenerated</code> message is then handled in the <code class="language-plaintext highlighter-rouge">update</code> function as follows:</p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">update</span> <span class="p">:</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Config</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">Config</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">msg</span> <span class="n">config</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">of</span>
        <span class="c1">-- ...</span>
        <span class="kt">RandomTagGenerated</span> <span class="n">videoPlayerId</span> <span class="n">tag</span> <span class="o">-&gt;</span>
            <span class="k">let</span>
                <span class="n">randomGifUrlFetchedMsg</span> <span class="p">:</span> <span class="kt">Result</span> <span class="kt">Error</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
                <span class="n">randomGifUrlFetchedMsg</span> <span class="o">=</span>
                    <span class="kt">RandomGifUrlFetched</span> <span class="n">videoPlayerId</span>

                <span class="n">fetchRandomGifUrl</span> <span class="p">:</span> <span class="kt">Cmd</span> <span class="kt">Msg</span>
                <span class="n">fetchRandomGifUrl</span> <span class="o">=</span>
                    <span class="kt">Gif</span><span class="o">.</span><span class="n">fetchRandomGifUrl</span>
                        <span class="n">randomGifUrlFetchedMsg</span>
                        <span class="n">config</span><span class="o">.</span><span class="n">giphyApiKey</span>
                        <span class="n">tag</span>
            <span class="k">in</span>
            <span class="p">(</span> <span class="n">config</span><span class="o">,</span> <span class="n">fetchRandomGifUrl</span> <span class="p">)</span>
</code></pre></div></div> <p>Once the Elm Runtime returns the randomly generated <code class="language-plaintext highlighter-rouge">tag</code> in the <code class="language-plaintext highlighter-rouge">RandomTagGenerated</code> message, along with the <code class="language-plaintext highlighter-rouge">videoPlayerId</code> we specified ourselves in the <code class="language-plaintext highlighter-rouge">generateRandomTag</code> function, we use a <code class="language-plaintext highlighter-rouge">Gif.fetchRandomGifUrl</code> function to make a HTTP call out to Giphy to request a GIF URL (details of which are available in <a href="https://github.com/paulfioravanti/80sfy">the codebase</a>, but check out the <a href="https://github.com/paulfioravanti/80sfy/blob/master/src/Tag.elm">the real <code class="language-plaintext highlighter-rouge">Tag</code> code</a> for the details on picking random tags).</p> <div style="margin: auto; text-align: center; width: 100%;"> <figure style="display: block"> <img src="/assets/images/2021-05-02/goonies-end-scene-glitched.png" alt="The Goonies looking out at the Inferno"> </figure> </div> <p>For more information on random generators, see the <a href="https://guide.elm-lang.org/">The Elm Guide</a>’s <a href="https://guide.elm-lang.org/effects/random.html">Random section</a>. If these two examples were too scoff-inducing-ly simple and you want some Hard Mode in your randomness, go check out <a href="https://github.com/ckoster22">Charlie Koster</a>’s article <em><a href="https://ckoster22.medium.com/randomness-in-elm-8e977457bf1b">Randomness in Elm</a></em>, and let him bend your mind a bit.</p> <h2 id="i-am-a-msg-like-my-father-before-me">I am a Msg, like my Father before me</h2> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/luke-skywalker-glitched.png" alt="I am a Jedi, like my father before me."> </figure> </div> <p><a href="https://guide.elm-lang.org/">The Elm guide</a> is <a href="https://guide.elm-lang.org/webapps/structure.html">quite opinionated about Elm application structuring</a>. While it advocates less structure and longer files, I find that as an application grows, I definitely prefer more structure and smaller files.</p> <p>I like to have <em>thematically-related</em> functions grouped together, just to aid in my own understanding of the code at a glance, which seems to push me towards what would seem to be considered a React-style(?) “components” way of thinking, so I will often use that word when referring to what are essentially the different “parts” of the application.</p> <p>In my mind, the 80sfy application has a few “main” components in it:</p> <ul> <li><code class="language-plaintext highlighter-rouge">AudioPlayer</code></li> <li><code class="language-plaintext highlighter-rouge">VideoPlayer</code></li> <li><code class="language-plaintext highlighter-rouge">ControlPanel</code></li> <li><code class="language-plaintext highlighter-rouge">SecretConfig</code></li> </ul> <p>When you press the “Play” button on the control panel, you start playing the audio <em>and</em> start playing the GIF videos, so these different parts of the application need to be able to communicate with each other.</p> <p>Of course all of these messages can live at the “top level” of the application, and the handling for every one of those messages can live inside one big <code class="language-plaintext highlighter-rouge">update</code> function. However, there are times where I would rather have a separate <code class="language-plaintext highlighter-rouge">AudioPlayer.Update</code> “child” file, with its own <code class="language-plaintext highlighter-rouge">update</code> function, to handle thematically-similar messages specifically targeted at the <code class="language-plaintext highlighter-rouge">AudioPlayer</code> from the “parent” <code class="language-plaintext highlighter-rouge">update</code> function, and a similar structure for the other components.</p> <p>The main <code class="language-plaintext highlighter-rouge">update</code> function can be the “trunk” of the application tree, which can handle its own top level messages, and each named component can have its own separate <code class="language-plaintext highlighter-rouge">update</code> function that “branches off” that trunk. Each component branch can emit messages that communicate back up to the parent trunk itself, or to other sibling branch components via the parent trunk.</p> <p>This kind of concept is explained in a way that resonated with me in <em><a href="https://medium.com/@alex.lew/the-translator-pattern-a-model-for-child-to-parent-communication-in-elm-f4bfaa1d3f98">The Translator Pattern: a model for Child-to-Parent Communication in Elm</a></em> by <a href="http://alexlew.net">Alex Lew</a>. The “translator”, in this context, refers to a function that uses a dictionary of parent-level message types to “translate” child-level messages into parent-level messages. The burden of performing a message “translation” lies with the parent <code class="language-plaintext highlighter-rouge">update</code> function, before it is able to send any <code class="language-plaintext highlighter-rouge">Cmd</code>s off to the Elm Runtime.</p> <p>I really liked the idea of some sort of parent-level message dictionary that child components could leverage when they generate <code class="language-plaintext highlighter-rouge">Cmd</code>s, but I found I needed to slightly tweak the way that parent-child <code class="language-plaintext highlighter-rouge">Msg</code>/<code class="language-plaintext highlighter-rouge">Cmd</code> communication occurred, compared to Alex’s blog post, to get it all making sense in my own head.</p> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/anakin-redeemed-glitched.png" alt="Anakin redeemed"> </figure> </div> <p>So, let’s see how this way of thinking works in practice in the 80sfy application. I have adopted a naming convention of <code class="language-plaintext highlighter-rouge">Msgs</code> for the <code class="language-plaintext highlighter-rouge">type alias</code> that defines a record containing a list of all the top-level <code class="language-plaintext highlighter-rouge">Msg</code>s in the application, and <code class="language-plaintext highlighter-rouge">dictionary</code> for the function that returns the <code class="language-plaintext highlighter-rouge">Msgs</code> dictionary itself:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/Msg.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Msg</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">(</span><span class="o">..</span><span class="p">)</span><span class="o">,</span> <span class="kt">Msgs</span><span class="o">,</span> <span class="n">dictionary</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">AudioPlayer</span>
<span class="k">import</span> <span class="kt">ControlPanel</span>
<span class="k">import</span> <span class="kt">Key</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Key</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Ports</span>
<span class="k">import</span> <span class="kt">SecretConfig</span>
<span class="k">import</span> <span class="kt">Time</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Posix</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">VideoPlayer</span>


<span class="k">type</span> <span class="kt">Msg</span>
    <span class="o">=</span> <span class="kt">AudioPlayer</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Msg</span>
    <span class="o">|</span> <span class="kt">ControlPanel</span> <span class="kt">ControlPanel</span><span class="o">.</span><span class="kt">Msg</span>
    <span class="o">|</span> <span class="kt">CrossFadePlayers</span> <span class="kt">Posix</span>
    <span class="o">|</span> <span class="kt">KeyPressed</span> <span class="kt">Key</span>
    <span class="o">|</span> <span class="kt">NoOp</span>
    <span class="o">|</span> <span class="kt">Pause</span>
    <span class="o">|</span> <span class="kt">Ports</span> <span class="kt">Ports</span><span class="o">.</span><span class="kt">Msg</span>
    <span class="o">|</span> <span class="kt">SecretConfig</span> <span class="kt">SecretConfig</span><span class="o">.</span><span class="kt">Msg</span>
    <span class="o">|</span> <span class="kt">ShowApplicationState</span>
    <span class="o">|</span> <span class="kt">VideoPlayer</span> <span class="kt">VideoPlayer</span><span class="o">.</span><span class="kt">Msg</span>


<span class="k">type</span> <span class="k">alias</span> <span class="kt">Msgs</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">audioPlayerMsg</span> <span class="p">:</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
    <span class="o">,</span> <span class="n">controlPanelMsg</span> <span class="p">:</span> <span class="kt">ControlPanel</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
    <span class="o">,</span> <span class="n">crossFadePlayersMsg</span> <span class="p">:</span> <span class="kt">Posix</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
    <span class="o">,</span> <span class="n">keyPressedMsg</span> <span class="p">:</span> <span class="kt">Key</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
    <span class="o">,</span> <span class="n">noOpMsg</span> <span class="p">:</span> <span class="kt">Msg</span>
    <span class="o">,</span> <span class="n">pauseMsg</span> <span class="p">:</span> <span class="kt">Msg</span>
    <span class="o">,</span> <span class="n">portsMsg</span> <span class="p">:</span> <span class="kt">Ports</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
    <span class="o">,</span> <span class="n">secretConfigMsg</span> <span class="p">:</span> <span class="kt">SecretConfig</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
    <span class="o">,</span> <span class="n">showApplicationStateMsg</span> <span class="p">:</span> <span class="kt">Msg</span>
    <span class="o">,</span> <span class="n">videoPlayerMsg</span> <span class="p">:</span> <span class="kt">VideoPlayer</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
    <span class="p">}</span>


<span class="n">dictionary</span> <span class="p">:</span> <span class="kt">Msgs</span>
<span class="n">dictionary</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">audioPlayerMsg</span> <span class="o">=</span> <span class="kt">AudioPlayer</span>
    <span class="o">,</span> <span class="n">controlPanelMsg</span> <span class="o">=</span> <span class="kt">ControlPanel</span>
    <span class="o">,</span> <span class="n">crossFadePlayersMsg</span> <span class="o">=</span> <span class="kt">CrossFadePlayers</span>
    <span class="o">,</span> <span class="n">keyPressedMsg</span> <span class="o">=</span> <span class="kt">KeyPressed</span>
    <span class="o">,</span> <span class="n">noOpMsg</span> <span class="o">=</span> <span class="kt">NoOp</span>
    <span class="o">,</span> <span class="n">pauseMsg</span> <span class="o">=</span> <span class="kt">Pause</span>
    <span class="o">,</span> <span class="n">portsMsg</span> <span class="o">=</span> <span class="kt">Ports</span>
    <span class="o">,</span> <span class="n">secretConfigMsg</span> <span class="o">=</span> <span class="kt">SecretConfig</span>
    <span class="o">,</span> <span class="n">showApplicationStateMsg</span> <span class="o">=</span> <span class="kt">ShowApplicationState</span>
    <span class="o">,</span> <span class="n">videoPlayerMsg</span> <span class="o">=</span> <span class="kt">VideoPlayer</span>
    <span class="p">}</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">Msgs</code> in the <code class="language-plaintext highlighter-rouge">dictionary</code> are a mix of “top-level”-only messages, like <code class="language-plaintext highlighter-rouge">CrossFadePlayers Posix</code> or <code class="language-plaintext highlighter-rouge">NoOp</code>, and messages like <code class="language-plaintext highlighter-rouge">AudioPlayer AudioPlayer.Msg</code>, where the “top-level” or “parent” part of the message is meant to indicate which component’s <code class="language-plaintext highlighter-rouge">update</code> function the message should be sent to (<code class="language-plaintext highlighter-rouge">AudioPlayer</code>), and the constructor parameter (<code class="language-plaintext highlighter-rouge">AudioPlayer.Msg</code>) is the specific message to be handled by the child component’s <code class="language-plaintext highlighter-rouge">update</code> function.</p> <p>The dictionary is initialised as soon as the application starts, in the <code class="language-plaintext highlighter-rouge">main</code> function, and is passed into every function that needs to send top-level messages (ie all of them):</p> <p><strong><code class="language-plaintext highlighter-rouge">src/Main.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Main</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">main</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Browser</span>
<span class="k">import</span> <span class="kt">Flags</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Flags</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Model</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Model</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Msg</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="o">,</span> <span class="kt">Msgs</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Subscriptions</span>
<span class="k">import</span> <span class="kt">Update</span>
<span class="k">import</span> <span class="kt">View</span>
<span class="c1">-- ...</span>


<span class="n">main</span> <span class="p">:</span> <span class="kt">Program</span> <span class="kt">Flags</span> <span class="kt">Model</span> <span class="kt">Msg</span>
<span class="n">main</span> <span class="o">=</span>
    <span class="k">let</span>
        <span class="n">msgs</span> <span class="p">:</span> <span class="kt">Msgs</span>
        <span class="n">msgs</span> <span class="o">=</span>
            <span class="kt">Msg</span><span class="o">.</span><span class="n">dictionary</span>
    <span class="k">in</span>
    <span class="kt">Browser</span><span class="o">.</span><span class="n">document</span>
        <span class="p">{</span> <span class="n">init</span> <span class="o">=</span> <span class="n">init</span>
        <span class="o">,</span> <span class="n">update</span> <span class="o">=</span> <span class="kt">Update</span><span class="o">.</span><span class="n">update</span> <span class="n">msgs</span>
        <span class="o">,</span> <span class="n">view</span> <span class="o">=</span> <span class="kt">View</span><span class="o">.</span><span class="n">view</span> <span class="n">msgs</span>
        <span class="o">,</span> <span class="n">subscriptions</span> <span class="o">=</span> <span class="kt">Subscriptions</span><span class="o">.</span><span class="n">subscriptions</span> <span class="n">msgs</span>
        <span class="p">}</span>

<span class="c1">-- ...</span>
</code></pre></div></div> <p>At this point, your <a href="https://en.wiktionary.org/wiki/Spidey-sense">spidey-sense</a> may be tingling regarding passing in a record of global context this large (I do not consider it “global state” as-such since the dictionary content will never be transformed or “changed”) to the three main sections of the application.</p> <p>Surely all ten <code class="language-plaintext highlighter-rouge">Msg</code> types in the dictionary are not needed in <em>every</em> section of the application, right…? Correct, and that’s why we are going to lean on Elm’s <a href="https://ckoster22.medium.com/advanced-types-in-elm-extensible-records-67e9d804030d">Extensible Records</a> types to help “filter” this dictionary down to the bare minimum of top-level messages that each part of the application needs to use.</p> <p>Let’s see what this looks like in the top-level <code class="language-plaintext highlighter-rouge">Update</code> function:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/Update.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Update</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">update</span><span class="p">)</span>

<span class="c1">-- ...</span>

<span class="k">type</span> <span class="k">alias</span> <span class="kt">Msgs</span> <span class="n">msgs</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">msgs</span>
        <span class="o">|</span> <span class="n">audioPlayerMsg</span> <span class="p">:</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">pauseMsg</span> <span class="p">:</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">portsMsg</span> <span class="p">:</span> <span class="kt">Ports</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">secretConfigMsg</span> <span class="p">:</span> <span class="kt">SecretConfig</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">videoPlayerMsg</span> <span class="p">:</span> <span class="kt">VideoPlayer</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
    <span class="p">}</span>


<span class="n">update</span> <span class="p">:</span> <span class="kt">Msgs</span> <span class="n">msgs</span> <span class="o">-&gt;</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">parentMsgs</span> <span class="n">msg</span> <span class="n">model</span> <span class="o">=</span>
    <span class="c1">-- ...</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">Update</code> module essentially <em>re-defines</em> the type of the <code class="language-plaintext highlighter-rouge">Msgs</code> record that is passed to it, restricting its entries down to only those top-level messages that it needs to care about. This helps to keep the record content more focused, and feel a bit less heavy than the record with ten entries that was originally passed in.</p> <p>We got a 50% reduction in entries from the original record in the <code class="language-plaintext highlighter-rouge">Update</code> module, so let’s see how much of one we get in the <code class="language-plaintext highlighter-rouge">View</code> and <code class="language-plaintext highlighter-rouge">Subscriptions</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/View.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">View</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">view</span><span class="p">)</span>

<span class="c1">-- ...</span>

<span class="k">type</span> <span class="k">alias</span> <span class="kt">Msgs</span> <span class="n">msgs</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">msgs</span>
        <span class="o">|</span> <span class="n">audioPlayerMsg</span> <span class="p">:</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">controlPanelMsg</span> <span class="p">:</span> <span class="kt">ControlPanel</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">noOpMsg</span> <span class="p">:</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">pauseMsg</span> <span class="p">:</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">portsMsg</span> <span class="p">:</span> <span class="kt">Ports</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">secretConfigMsg</span> <span class="p">:</span> <span class="kt">SecretConfig</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">showApplicationStateMsg</span> <span class="p">:</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">videoPlayerMsg</span> <span class="p">:</span> <span class="kt">VideoPlayer</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
    <span class="p">}</span>


<span class="n">view</span> <span class="p">:</span> <span class="kt">Msgs</span> <span class="n">msgs</span> <span class="o">-&gt;</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="kt">Document</span> <span class="kt">Msg</span>
<span class="n">view</span> <span class="n">msgs</span> <span class="n">model</span> <span class="o">=</span>
    <span class="c1">-- ...</span>
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">src/Subscriptions.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Subscriptions</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="c1">-- ...</span>

<span class="k">type</span> <span class="k">alias</span> <span class="kt">Msgs</span> <span class="n">msgs</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">msgs</span>
        <span class="o">|</span> <span class="n">audioPlayerMsg</span> <span class="p">:</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">controlPanelMsg</span> <span class="p">:</span> <span class="kt">ControlPanel</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">crossFadePlayersMsg</span> <span class="p">:</span> <span class="kt">Posix</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">keyPressedMsg</span> <span class="p">:</span> <span class="kt">Key</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">noOpMsg</span> <span class="p">:</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">portsMsg</span> <span class="p">:</span> <span class="kt">Ports</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="n">videoPlayerMsg</span> <span class="p">:</span> <span class="kt">VideoPlayer</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
    <span class="p">}</span>


<span class="n">subscriptions</span> <span class="p">:</span> <span class="kt">Msgs</span> <span class="n">msgs</span> <span class="o">-&gt;</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="kt">Sub</span> <span class="kt">Msg</span>
<span class="n">subscriptions</span> <span class="n">msgs</span> <span class="n">model</span> <span class="o">=</span>
    <span class="c1">-- ...</span>
</code></pre></div></div> <p>The reduction in entries is not quite as great for these two modules, but at least there <em>is</em> a reduction, and the record can only get smaller as it gets passed down further into child components.</p> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/chewbacca-ewoks-glitched.png" alt="Chewbacca and Ewoks"> </figure> </div> <p>As an example, let’s follow the journey of the <code class="language-plaintext highlighter-rouge">Msgs</code> record as it gets passed down into the <code class="language-plaintext highlighter-rouge">AudioPlayer</code> child component from the <code class="language-plaintext highlighter-rouge">Update</code> module:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/Update.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Update</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">update</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">AudioPlayer</span>
<span class="c1">-- ...</span>

<span class="k">type</span> <span class="k">alias</span> <span class="kt">Msgs</span> <span class="n">msgs</span> <span class="o">=</span>
    <span class="c1">-- ...</span>

<span class="n">update</span> <span class="p">:</span> <span class="kt">Msgs</span> <span class="n">msgs</span> <span class="o">-&gt;</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">parentMsgs</span> <span class="n">msg</span> <span class="n">model</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">of</span>
        <span class="kt">Msg</span><span class="o">.</span><span class="kt">AudioPlayer</span> <span class="n">msgForAudioPlayer</span> <span class="o">-&gt;</span>
            <span class="k">let</span>
                <span class="p">(</span> <span class="n">audioPlayer</span><span class="o">,</span> <span class="n">cmd</span> <span class="p">)</span> <span class="o">=</span>
                    <span class="kt">AudioPlayer</span><span class="o">.</span><span class="n">update</span>
                        <span class="n">parentMsgs</span>
                        <span class="n">msgForAudioPlayer</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">audioPlayer</span>
            <span class="k">in</span>
            <span class="p">(</span> <span class="p">{</span> <span class="n">model</span> <span class="o">|</span> <span class="n">audioPlayer</span> <span class="o">=</span> <span class="n">audioPlayer</span> <span class="p">}</span><span class="o">,</span> <span class="n">cmd</span> <span class="p">)</span>
        <span class="c1">-- ...</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">parentMsgs</code> are passed into the <code class="language-plaintext highlighter-rouge">AudioPlayer.update</code> function, along with whatever <code class="language-plaintext highlighter-rouge">msgForAudioPlayer</code> needs to be handled there, as well as the <code class="language-plaintext highlighter-rouge">model.audioPlayer</code>, which for all intents and purposes becomes the “model” for the <code class="language-plaintext highlighter-rouge">AudioPlayer</code> component.</p> <p>Let’s see how the type definition has changed for the <code class="language-plaintext highlighter-rouge">Msgs</code> in the <code class="language-plaintext highlighter-rouge">AudioPlayer</code> component. The <code class="language-plaintext highlighter-rouge">AudioPlayer.elm</code> file acts as the gateway to all audio player-related functionality, with implementation details all hidden away in sub-modules (which we will talk about in more detail later on):</p> <p><strong><code class="language-plaintext highlighter-rouge">src/AudioPlayer.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">AudioPlayer</span> <span class="k">exposing</span>
    <span class="p">(</span> <span class="kt">AudioPlayer</span>
    <span class="o">,</span> <span class="kt">Msg</span>
    <span class="o">,</span> <span class="n">update</span>
    <span class="c1">-- ...</span>
    <span class="p">)</span>

<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Model</span> <span class="k">as</span> <span class="kt">Model</span>
<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Msg</span> <span class="k">as</span> <span class="kt">Msg</span>
<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Update</span> <span class="k">as</span> <span class="kt">Update</span>
<span class="c1">-- ...</span>

<span class="k">type</span> <span class="k">alias</span> <span class="kt">AudioPlayer</span> <span class="o">=</span>
    <span class="kt">Model</span><span class="o">.</span><span class="kt">AudioPlayer</span>

<span class="k">type</span> <span class="k">alias</span> <span class="kt">Msg</span> <span class="o">=</span>
    <span class="kt">Msg</span><span class="o">.</span><span class="kt">Msg</span>

<span class="c1">-- ...</span>

<span class="n">update</span> <span class="p">:</span> <span class="kt">Update</span><span class="o">.</span><span class="kt">ParentMsgs</span> <span class="n">msgs</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">AudioPlayer</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">AudioPlayer</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="n">msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">parentMsgs</span> <span class="n">msg</span> <span class="n">audioPlayer</span> <span class="o">=</span>
    <span class="kt">Update</span><span class="o">.</span><span class="n">update</span> <span class="n">parentMsgs</span> <span class="n">msg</span> <span class="n">audioPlayer</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">update</code> function simply calls the <code class="language-plaintext highlighter-rouge">AudioPlayer</code>’s own internal <code class="language-plaintext highlighter-rouge">Update.update</code> function, but the thing to notice here, is that <code class="language-plaintext highlighter-rouge">parentMsgs</code> is now defined in terms of a <code class="language-plaintext highlighter-rouge">Update.ParentMsgs msgs msg</code> type: a further-filtered, child-component-defined record type that only contains the <code class="language-plaintext highlighter-rouge">parentMsgs</code> that the <code class="language-plaintext highlighter-rouge">AudioPlayer</code>’s <code class="language-plaintext highlighter-rouge">update</code> function needs to use.</p> <p>Notice also that the <code class="language-plaintext highlighter-rouge">AudioPlayer.update</code> is returning a lower-cased <code class="language-plaintext highlighter-rouge">Cmd msg</code>, as apposed to the <code class="language-plaintext highlighter-rouge">Cmd Msg</code> in <code class="language-plaintext highlighter-rouge">Update.update</code>. The <code class="language-plaintext highlighter-rouge">msg</code> here is a <a href="https://guide.elm-lang.org/types/reading_types.html#type-variables">type variable</a> that can technically match any type, but in this case it <em>must</em> match one of the types contained in <code class="language-plaintext highlighter-rouge">parentMsgs</code>, hence the <code class="language-plaintext highlighter-rouge">msg</code> in the <code class="language-plaintext highlighter-rouge">Update.ParentMsgs msgs msg</code> declaration. The child component does not know the specifics about the parent messages: it just knows that it needs to return the type of message that the parent is expecting to get back.</p> <p>Let’s see what the <code class="language-plaintext highlighter-rouge">Update.ParentMsgs msgs msg</code> look like now:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/AudioPlayer/Update.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Update</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">ParentMsgs</span><span class="o">,</span> <span class="n">update</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Model</span> <span class="k">as</span> <span class="kt">Model</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">AudioPlayer</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Msg</span> <span class="k">as</span> <span class="kt">Msg</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">)</span>
<span class="c1">-- ...</span>


<span class="k">type</span> <span class="k">alias</span> <span class="kt">ParentMsgs</span> <span class="n">msgs</span> <span class="n">msg</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">msgs</span>
        <span class="o">|</span> <span class="n">audioPlayerMsg</span> <span class="p">:</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="n">msg</span>
    <span class="p">}</span>


<span class="n">update</span> <span class="p">:</span> <span class="kt">ParentMsgs</span> <span class="n">msgs</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">AudioPlayer</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">AudioPlayer</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="n">msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="p">{</span> <span class="n">audioPlayerMsg</span> <span class="p">}</span> <span class="n">msg</span> <span class="n">audioPlayer</span> <span class="o">=</span>
    <span class="c1">-- ...</span>
</code></pre></div></div> <p>The record has been reduced down to a single entry, the <code class="language-plaintext highlighter-rouge">audioPlayerMsg</code>, which is defined from the child component’s perspective as being as a function that takes one of the <code class="language-plaintext highlighter-rouge">AudioPlayer</code>’s own <code class="language-plaintext highlighter-rouge">Msg</code> types, and returns some kind of <code class="language-plaintext highlighter-rouge">msg</code> type from its parent that it does not know the details of.</p> <p>This declaration mirrors the same function from the parent <code class="language-plaintext highlighter-rouge">Update</code> module’s perspective, <code class="language-plaintext highlighter-rouge">AudioPlayer.Msg -&gt; Msg</code>, a function that takes in some message internal-to-<code class="language-plaintext highlighter-rouge">AudioPlayer</code>, returning a concrete <code class="language-plaintext highlighter-rouge">Msg</code> type.</p> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/leia-truth-glitched.png" alt="Leia learns the truth"> </figure> </div> <p>The existence of the <code class="language-plaintext highlighter-rouge">Update.ParentMsgs</code> alias belies the existence of similar aliases for a child component’s <code class="language-plaintext highlighter-rouge">View</code> and <code class="language-plaintext highlighter-rouge">Subscriptions</code> functions. For example, staying with the <code class="language-plaintext highlighter-rouge">AudioPlayer</code>, we find this definition for the <code class="language-plaintext highlighter-rouge">subscriptions</code> function:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/AudioPlayer.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">AudioPlayer</span> <span class="k">exposing</span>
    <span class="p">(</span> <span class="kt">AudioPlayer</span>
    <span class="o">,</span> <span class="kt">Msg</span>
    <span class="o">,</span> <span class="n">subscriptions</span>
    <span class="c1">-- ...</span>
    <span class="p">)</span>

<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Model</span> <span class="k">as</span> <span class="kt">Model</span>
<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Subscriptions</span> <span class="k">as</span> <span class="kt">Subscriptions</span>
<span class="c1">-- ...</span>

<span class="k">type</span> <span class="k">alias</span> <span class="kt">AudioPlayer</span> <span class="o">=</span>
    <span class="kt">Model</span><span class="o">.</span><span class="kt">AudioPlayer</span>

<span class="c1">-- ...</span>

<span class="n">subscriptions</span> <span class="p">:</span> <span class="kt">Subscriptions</span><span class="o">.</span><span class="kt">ParentMsgs</span> <span class="n">msgs</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="kt">AudioPlayer</span> <span class="o">-&gt;</span> <span class="kt">Sub</span> <span class="n">msg</span>
<span class="n">subscriptions</span> <span class="n">parentMsgs</span> <span class="n">audioPlayer</span> <span class="o">=</span>
    <span class="kt">Subscriptions</span><span class="o">.</span><span class="n">subscriptions</span> <span class="n">parentMsgs</span> <span class="n">audioPlayer</span>
</code></pre></div></div> <p>And the <code class="language-plaintext highlighter-rouge">Subscriptions.ParentMsgs msgs msg</code> is defined as:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/AudioPlayer/Subscriptions.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Subscriptions</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">ParentMsgs</span><span class="o">,</span> <span class="n">subscriptions</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Model</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">AudioPlayer</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Msg</span> <span class="k">as</span> <span class="kt">Msg</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">)</span>
<span class="c1">-- ...</span>


<span class="k">type</span> <span class="k">alias</span> <span class="kt">ParentMsgs</span> <span class="n">msgs</span> <span class="n">msg</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">msgs</span>
        <span class="o">|</span> <span class="n">audioPlayerMsg</span> <span class="p">:</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="n">msg</span>
        <span class="o">,</span> <span class="n">noOpMsg</span> <span class="p">:</span> <span class="n">msg</span>
    <span class="p">}</span>


<span class="n">subscriptions</span> <span class="p">:</span> <span class="kt">ParentMsgs</span> <span class="n">msgs</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="kt">AudioPlayer</span> <span class="o">-&gt;</span> <span class="kt">Sub</span> <span class="n">msg</span>
<span class="n">subscriptions</span> <span class="n">parentMsgs</span> <span class="n">audioPlayer</span> <span class="o">=</span>
    <span class="c1">-- ...</span>
</code></pre></div></div> <p>Similar to <code class="language-plaintext highlighter-rouge">Update.ParentMsgs</code>, <code class="language-plaintext highlighter-rouge">Subscriptions.ParentMsgs</code> restricts the passed in <code class="language-plaintext highlighter-rouge">parentMsgs</code> record to only a small subset of entries, including the <code class="language-plaintext highlighter-rouge">noOpMsg</code>, which it only knows as some <code class="language-plaintext highlighter-rouge">msg</code> type variable, without knowing its specific details.</p> <p>All of the other child components in the 80sfy application handle the <code class="language-plaintext highlighter-rouge">Msgs</code> record in a similar way, concerning themselves only with the parent messages that they themselves use.</p> <p>With regards to how these parent messages are used inside of views, and how they wrap their child messages, let’s have a look at an example in the user interface code for the play/pause button in the <code class="language-plaintext highlighter-rouge">ControlPanel</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/ControlPanel/View/Controls.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">ControlPanel</span><span class="o">.</span><span class="kt">View</span><span class="o">.</span><span class="kt">Controls</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">view</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">AudioPlayer</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">AudioPlayer</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">ControlPanel</span><span class="o">.</span><span class="kt">View</span><span class="o">.</span><span class="kt">Styles</span> <span class="k">as</span> <span class="kt">Styles</span>
<span class="k">import</span> <span class="kt">Html</span><span class="o">.</span><span class="kt">Styled</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Html</span><span class="o">,</span> <span class="n">div</span><span class="o">,</span> <span class="n">i</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Html</span><span class="o">.</span><span class="kt">Styled</span><span class="o">.</span><span class="kt">Attributes</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">attribute</span><span class="o">,</span> <span class="n">class</span><span class="o">,</span> <span class="n">css</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Html</span><span class="o">.</span><span class="kt">Styled</span><span class="o">.</span><span class="kt">Events</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">onClick</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Ports</span>


<span class="k">type</span> <span class="k">alias</span> <span class="kt">ParentMsgs</span> <span class="n">msgs</span> <span class="n">msg</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">msgs</span>
        <span class="o">|</span> <span class="n">audioPlayerMsg</span> <span class="p">:</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="n">msg</span>
        <span class="o">,</span> <span class="n">pauseMsg</span> <span class="p">:</span> <span class="n">msg</span>
        <span class="o">,</span> <span class="n">portsMsg</span> <span class="p">:</span> <span class="kt">Ports</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="n">msg</span>
    <span class="p">}</span>


<span class="k">type</span> <span class="k">alias</span> <span class="kt">Context</span> <span class="n">a</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">a</span> <span class="o">|</span> <span class="n">audioPlayer</span> <span class="p">:</span> <span class="kt">AudioPlayer</span> <span class="p">}</span>


<span class="n">view</span> <span class="p">:</span> <span class="kt">ParentMsgs</span> <span class="n">msgs</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="kt">Context</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Html</span> <span class="n">msg</span>
<span class="n">view</span> <span class="n">parentMsgs</span> <span class="p">{</span> <span class="n">audioPlayer</span> <span class="p">}</span> <span class="o">=</span>
    <span class="k">let</span>
        <span class="c1">-- ...</span>

        <span class="n">playing</span> <span class="p">:</span> <span class="kt">Bool</span>
        <span class="n">playing</span> <span class="o">=</span>
            <span class="kt">AudioPlayer</span><span class="o">.</span><span class="n">isPlaying</span> <span class="n">audioPlayer</span>
    <span class="k">in</span>
    <span class="n">div</span>
        <span class="p">[</span> <span class="n">css</span> <span class="p">[</span> <span class="kt">Styles</span><span class="o">.</span><span class="n">controls</span> <span class="p">]</span>
        <span class="o">,</span> <span class="n">attribute</span> <span class="s">"</span><span class="s2">data-name"</span> <span class="s">"</span><span class="s2">controls"</span>
        <span class="p">]</span>
        <span class="p">[</span> <span class="n">playPauseButton</span> <span class="n">parentMsgs</span> <span class="n">playing</span>
        <span class="c1">-- ...</span>
        <span class="p">]</span>

<span class="c1">-- ...</span>

<span class="n">playPauseButton</span> <span class="p">:</span> <span class="kt">ParentMsgs</span> <span class="n">msgs</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="o">-&gt;</span> <span class="kt">Html</span> <span class="n">msg</span>
<span class="n">playPauseButton</span> <span class="p">{</span> <span class="n">pauseMsg</span><span class="o">,</span> <span class="n">portsMsg</span> <span class="p">}</span> <span class="n">playing</span> <span class="o">=</span>
    <span class="k">let</span>
        <span class="p">(</span> <span class="n">iconClass</span><span class="o">,</span> <span class="n">playPauseMsg</span> <span class="p">)</span> <span class="o">=</span>
            <span class="k">if</span> <span class="n">playing</span> <span class="k">then</span>
                <span class="p">(</span> <span class="s">"</span><span class="s2">fas fa-pause"</span><span class="o">,</span> <span class="n">pauseMsg</span> <span class="p">)</span>

            <span class="k">else</span>
                <span class="p">(</span> <span class="s">"</span><span class="s2">fas fa-play"</span><span class="o">,</span> <span class="n">portsMsg</span> <span class="kt">Ports</span><span class="o">.</span><span class="n">playMsg</span> <span class="p">)</span>
    <span class="k">in</span>
    <span class="n">div</span>
        <span class="p">[</span> <span class="n">css</span> <span class="p">[</span> <span class="kt">Styles</span><span class="o">.</span><span class="n">button</span> <span class="p">]</span>
        <span class="o">,</span> <span class="n">attribute</span> <span class="s">"</span><span class="s2">data-name"</span> <span class="s">"</span><span class="s2">play-pause"</span>
        <span class="o">,</span> <span class="n">onClick</span> <span class="n">playPauseMsg</span>
        <span class="p">]</span>
        <span class="p">[</span> <span class="n">div</span> <span class="p">[</span> <span class="n">css</span> <span class="p">[</span> <span class="kt">Styles</span><span class="o">.</span><span class="n">iconBackground</span> <span class="p">]</span> <span class="p">]</span> <span class="p">[]</span>
        <span class="o">,</span> <span class="n">i</span> <span class="p">[</span> <span class="n">css</span> <span class="p">[</span> <span class="kt">Styles</span><span class="o">.</span><span class="n">icon</span> <span class="p">]</span><span class="o">,</span> <span class="n">class</span> <span class="n">iconClass</span> <span class="p">]</span> <span class="p">[]</span>
        <span class="p">]</span>
</code></pre></div></div> <p>Looking specifically at the <code class="language-plaintext highlighter-rouge">playPauseButton</code> function, and the value that is supplied to the <code class="language-plaintext highlighter-rouge">onClick</code> function, we can see that:</p> <ul> <li>if the player is currently <code class="language-plaintext highlighter-rouge">playing</code>, the parameter-less parent message <code class="language-plaintext highlighter-rouge">pauseMsg</code> (read: <code class="language-plaintext highlighter-rouge">Pause</code>) gets sent as-is to be handled in the top-level <code class="language-plaintext highlighter-rouge">Update.update</code> function</li> <li>otherwise, if the player is stopped, we fetch the <code class="language-plaintext highlighter-rouge">Play</code> <code class="language-plaintext highlighter-rouge">Msg</code> from the <code class="language-plaintext highlighter-rouge">Ports</code> module (<code class="language-plaintext highlighter-rouge">Ports.playMsg</code>), give that as a parameter to the <code class="language-plaintext highlighter-rouge">portsMsg</code> message (read: <code class="language-plaintext highlighter-rouge">Ports Play</code>), and send that off to be handled in <code class="language-plaintext highlighter-rouge">Update.update</code> as a message to be forwarded off to the <code class="language-plaintext highlighter-rouge">Ports</code> “child component” for further handling (much more will be written about the <code class="language-plaintext highlighter-rouge">Ports</code> component later on…)</li> </ul> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/battle-of-endor-glitched.png" alt="Battle of Endor"> </figure> </div> <p>As you can see, if you want to split your Elm application out into discrete parts/components, there is a potential complexity/maintenance cost associated with doing so.</p> <p>I am prepared to pay this cost since this way of doing things makes sense to me as an application grows. Given this subjective viewpoint, and the fact that the Elm Guide would seem to consider this way of doing things to be off the “golden path”, definitely consider whether this approach is right for you, your team, and your application.</p> <h2 id="say-hello-to-my-little-façade">Say “hello” to my little façade</h2> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/say-hello-to-my-little-friend-glitched.png" alt="Say hello to my little friend"> </figure> </div> <p>The <a href="https://en.wikipedia.org/wiki/Facade_pattern">façade pattern</a> is probably my favourite software-design pattern, and I try and use it wherever it makes sense to make interfaces to different parts of a system more straightforward.</p> <p>One of my software pet peeves is seeing one part of a system be able to break boundaries and reach down with impunity into the internals of another part of a system it has no business knowing about.</p> <blockquote> <p>There are no natural barriers to handing out this kind of impunity in Elm, but at least the <a href="https://package.elm-lang.org/packages/kress95/elm-review-indirect-internal/latest">elm-review-indirect-internal</a> rule, for use with the fantastic <a href="https://package.elm-lang.org/packages/jfmengels/elm-review/latest/">elm-review</a> tool, can slap you on the wrist if you attempt to try.</p> </blockquote> <p>In the previous section, you saw part of how I tried to put a “hard” interface in the <code class="language-plaintext highlighter-rouge">AudioPlayer</code> module. Let’s go back and re-open up that file, but instead have a scan of its entire content. For our purposes here, what the functions do is not important.</p> <p>The main points are that there is no implementation code, all functions are simply one-line delegations out to sub-modules, and any other module in the application only needs to <code class="language-plaintext highlighter-rouge">import</code> the <code class="language-plaintext highlighter-rouge">AudioPlayer</code> module to interface with its functionality:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/AudioPlayer.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">AudioPlayer</span> <span class="k">exposing</span>
    <span class="p">(</span> <span class="kt">AudioPlayer</span>
    <span class="o">,</span> <span class="kt">AudioPlayerId</span>
    <span class="o">,</span> <span class="kt">AudioPlayerVolume</span>
    <span class="o">,</span> <span class="kt">Msg</span>
    <span class="o">,</span> <span class="c1">-- ...</span>
    <span class="p">)</span>

<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Model</span> <span class="k">as</span> <span class="kt">Model</span>
<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Msg</span> <span class="k">as</span> <span class="kt">Msg</span>
<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Playlist</span> <span class="k">as</span> <span class="kt">Playlist</span>
<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Status</span> <span class="k">as</span> <span class="kt">Status</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Status</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Subscriptions</span> <span class="k">as</span> <span class="kt">Subscriptions</span>
<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Task</span> <span class="k">as</span> <span class="kt">Task</span>
<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Update</span> <span class="k">as</span> <span class="kt">Update</span>
<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Volume</span> <span class="k">as</span> <span class="kt">Volume</span>
<span class="k">import</span> <span class="kt">Ports</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">SoundCloudWidgetPayload</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">SoundCloud</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">SoundCloudPlaylistUrl</span><span class="p">)</span>


<span class="k">type</span> <span class="k">alias</span> <span class="kt">AudioPlayer</span> <span class="o">=</span>
    <span class="kt">Model</span><span class="o">.</span><span class="kt">AudioPlayer</span>


<span class="k">type</span> <span class="k">alias</span> <span class="kt">AudioPlayerId</span> <span class="o">=</span>
    <span class="kt">Model</span><span class="o">.</span><span class="kt">AudioPlayerId</span>


<span class="k">type</span> <span class="k">alias</span> <span class="kt">AudioPlayerVolume</span> <span class="o">=</span>
    <span class="kt">Volume</span><span class="o">.</span><span class="kt">AudioPlayerVolume</span>


<span class="k">type</span> <span class="k">alias</span> <span class="kt">Msg</span> <span class="o">=</span>
    <span class="kt">Msg</span><span class="o">.</span><span class="kt">Msg</span>


<span class="k">type</span> <span class="k">alias</span> <span class="kt">TrackIndex</span> <span class="o">=</span>
    <span class="kt">Playlist</span><span class="o">.</span><span class="kt">TrackIndex</span>


<span class="n">init</span> <span class="p">:</span> <span class="kt">SoundCloudPlaylistUrl</span> <span class="o">-&gt;</span> <span class="kt">AudioPlayer</span>
<span class="n">init</span> <span class="n">soundCloudPlaylistUrl</span> <span class="o">=</span>
    <span class="kt">Model</span><span class="o">.</span><span class="n">init</span> <span class="n">soundCloudPlaylistUrl</span>


<span class="n">adjustVolumeMsg</span> <span class="p">:</span> <span class="p">(</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="n">msg</span>
<span class="n">adjustVolumeMsg</span> <span class="n">audioPlayerMsg</span> <span class="n">sliderVolume</span> <span class="o">=</span>
    <span class="kt">Msg</span><span class="o">.</span><span class="n">adjustVolume</span> <span class="n">audioPlayerMsg</span> <span class="n">sliderVolume</span>


<span class="n">isMuted</span> <span class="p">:</span> <span class="kt">AudioPlayer</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
<span class="n">isMuted</span> <span class="n">audioPlayer</span> <span class="o">=</span>
    <span class="kt">Status</span><span class="o">.</span><span class="n">isMuted</span> <span class="n">audioPlayer</span><span class="o">.</span><span class="n">status</span>


<span class="n">isPlaying</span> <span class="p">:</span> <span class="kt">AudioPlayer</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
<span class="n">isPlaying</span> <span class="n">audioPlayer</span> <span class="o">=</span>
    <span class="kt">Status</span><span class="o">.</span><span class="n">isPlaying</span> <span class="n">audioPlayer</span><span class="o">.</span><span class="n">status</span>


<span class="n">nextTrackMsg</span> <span class="p">:</span> <span class="kt">Msg</span>
<span class="n">nextTrackMsg</span> <span class="o">=</span>
    <span class="kt">Msg</span><span class="o">.</span><span class="kt">NextTrack</span>


<span class="n">performAudioPlayerReset</span> <span class="p">:</span> <span class="p">(</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">SoundCloudPlaylistUrl</span> <span class="o">-&gt;</span> <span class="kt">Cmd</span> <span class="n">msg</span>
<span class="n">performAudioPlayerReset</span> <span class="n">audioPlayerMsg</span> <span class="n">soundCloudPlaylistUrl</span> <span class="o">=</span>
    <span class="kt">Task</span><span class="o">.</span><span class="n">performAudioPlayerReset</span> <span class="n">audioPlayerMsg</span> <span class="n">soundCloudPlaylistUrl</span>


<span class="n">performNextTrackSelection</span> <span class="p">:</span> <span class="p">(</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Cmd</span> <span class="n">msg</span>
<span class="n">performNextTrackSelection</span> <span class="n">audioPlayerMsg</span> <span class="o">=</span>
    <span class="kt">Task</span><span class="o">.</span><span class="n">performNextTrackSelection</span> <span class="n">audioPlayerMsg</span>


<span class="n">performVolumeAdjustment</span> <span class="p">:</span> <span class="p">(</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Cmd</span> <span class="n">msg</span>
<span class="n">performVolumeAdjustment</span> <span class="n">audioPlayerMsg</span> <span class="n">sliderVolume</span> <span class="o">=</span>
    <span class="kt">Task</span><span class="o">.</span><span class="n">performVolumeAdjustment</span> <span class="n">audioPlayerMsg</span> <span class="n">sliderVolume</span>


<span class="n">rawId</span> <span class="p">:</span> <span class="kt">AudioPlayerId</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">rawId</span> <span class="n">audioPlayerId</span> <span class="o">=</span>
    <span class="kt">Model</span><span class="o">.</span><span class="n">rawId</span> <span class="n">audioPlayerId</span>


<span class="n">rawTrackIndex</span> <span class="p">:</span> <span class="kt">TrackIndex</span> <span class="o">-&gt;</span> <span class="kt">Int</span>
<span class="n">rawTrackIndex</span> <span class="n">trackIndex</span> <span class="o">=</span>
    <span class="kt">Playlist</span><span class="o">.</span><span class="n">rawTrackIndex</span> <span class="n">trackIndex</span>


<span class="n">rawVolume</span> <span class="p">:</span> <span class="kt">AudioPlayerVolume</span> <span class="o">-&gt;</span> <span class="kt">Int</span>
<span class="n">rawVolume</span> <span class="n">audioPlayerVolume</span> <span class="o">=</span>
    <span class="kt">Volume</span><span class="o">.</span><span class="n">rawVolume</span> <span class="n">audioPlayerVolume</span>


<span class="n">soundCloudWidgetPayload</span> <span class="p">:</span> <span class="kt">AudioPlayer</span> <span class="o">-&gt;</span> <span class="kt">SoundCloudWidgetPayload</span>
<span class="n">soundCloudWidgetPayload</span> <span class="n">audioPlayer</span> <span class="o">=</span>
    <span class="kt">Model</span><span class="o">.</span><span class="n">soundCloudWidgetPayload</span> <span class="n">audioPlayer</span>


<span class="n">statusToString</span> <span class="p">:</span> <span class="kt">Status</span> <span class="o">-&gt;</span> <span class="kt">String</span>
<span class="n">statusToString</span> <span class="n">status</span> <span class="o">=</span>
    <span class="kt">Status</span><span class="o">.</span><span class="n">toString</span> <span class="n">status</span>


<span class="n">subscriptions</span> <span class="p">:</span> <span class="kt">Subscriptions</span><span class="o">.</span><span class="kt">ParentMsgs</span> <span class="n">msgs</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="kt">AudioPlayer</span> <span class="o">-&gt;</span> <span class="kt">Sub</span> <span class="n">msg</span>
<span class="n">subscriptions</span> <span class="n">parentMsgs</span> <span class="n">audioPlayer</span> <span class="o">=</span>
    <span class="kt">Subscriptions</span><span class="o">.</span><span class="n">subscriptions</span> <span class="n">parentMsgs</span> <span class="n">audioPlayer</span>


<span class="n">toggleMuteMsg</span> <span class="p">:</span> <span class="kt">Msg</span>
<span class="n">toggleMuteMsg</span> <span class="o">=</span>
    <span class="kt">Msg</span><span class="o">.</span><span class="kt">ToggleMute</span>


<span class="n">update</span> <span class="p">:</span> <span class="kt">Update</span><span class="o">.</span><span class="kt">ParentMsgs</span> <span class="n">msgs</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">AudioPlayer</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">AudioPlayer</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="n">msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">parentMsgs</span> <span class="n">msg</span> <span class="n">audioPlayer</span> <span class="o">=</span>
    <span class="kt">Update</span><span class="o">.</span><span class="n">update</span> <span class="n">parentMsgs</span> <span class="n">msg</span> <span class="n">audioPlayer</span>
</code></pre></div></div> <p>It would be nice if Elm had built-in <a href="https://en.wikipedia.org/wiki/Syntactic_sugar">syntactic sugar</a> similar to, say, <a href="https://elixir-lang.org/">Elixir</a>’s <a href="https://hexdocs.pm/elixir/Kernel.html#defdelegate/2"><code class="language-plaintext highlighter-rouge">defdelegate(funs, opts)</code></a> function, in order to prevent the need to write function delegations “longhand”. But, leaving that aside, here are a few points worth bringing up regarding this file, as well as the general architecture of the application:</p> <ul> <li>Within the <code class="language-plaintext highlighter-rouge">AudioPlayer</code> module, <code class="language-plaintext highlighter-rouge">import</code>ing sub-modules (<code class="language-plaintext highlighter-rouge">AudioPlayer.X</code> modules) is unrestricted, but content from any other named module is only accessible via its top-level module (eg no reaching into <code class="language-plaintext highlighter-rouge">Ports.Msg</code> from <code class="language-plaintext highlighter-rouge">AudioPlayer</code>)</li> <li>Types defined in sub-modules may be exposed via the top-level module as <code class="language-plaintext highlighter-rouge">type alias</code>es (eg <code class="language-plaintext highlighter-rouge">AudioPlayer</code>, <code class="language-plaintext highlighter-rouge">Msg</code> etc). So, as far as other top-level modules are concerned, if they import the <code class="language-plaintext highlighter-rouge">AudioPlayer</code> type, the fact that the type is actually defined in <code class="language-plaintext highlighter-rouge">AudioPlayer.Model</code> is unknowable implementation detail behind the <a href="https://en.wikipedia.org/wiki/API">API</a> wall: they just see the <code class="language-plaintext highlighter-rouge">AudioPlayer</code> type coming in from the <code class="language-plaintext highlighter-rouge">AudioPlayer</code> module</li> <li>Wherever possible, I have tried to make <code class="language-plaintext highlighter-rouge">types</code> be <a href="https://ckoster22.medium.com/advanced-types-in-elm-opaque-types-ec5ec3b84ed2">Opaque Types</a> in order to hide their constructors, and further enforce boundaries on implementation details (even amongst sibling modules; see, for example, the <code class="language-plaintext highlighter-rouge">Status</code> type in <code class="language-plaintext highlighter-rouge">Audio.Status</code>).<br> The major exception to this would be the <code class="language-plaintext highlighter-rouge">Msg</code> type, which, similar to every other <code class="language-plaintext highlighter-rouge">Msg</code> in the application, needed to be exposed as <code class="language-plaintext highlighter-rouge">Msg(..)</code> from <code class="language-plaintext highlighter-rouge">AudioPlayer.Msg</code> so it could be used specifically for pattern matching in <code class="language-plaintext highlighter-rouge">AudioPlayer.Update</code> files, and consequently referenced directly as return values in functions like <code class="language-plaintext highlighter-rouge">nextTrackMsg</code> and <code class="language-plaintext highlighter-rouge">toggleMuteMsg</code>. But, just like any other type defined in a sub-module, if the <code class="language-plaintext highlighter-rouge">Msg</code> is to be exposed via the top-level module, it must only be via a <code class="language-plaintext highlighter-rouge">type alias</code> </li> </ul> <p>All of the other modules in the 80sfy application that have enough internal implementation details to split out into sub-modules follow these patterns.</p> <p>The Elm Guide would probably call all this façade-component application structuring a reflection of my programming “<a href="https://guide.elm-lang.org/webapps/structure.html#culture-shock">culture shock</a>”. I think the points made in that section of the guide are reasonable, but I honestly just cannot agree with its advice of big files and comment header delimiters. I just want my code to be legible (and hopefully not just to me), and I currently think that this kind of structure can help in that goal.</p> <h2 id="you-can-be-my-wrapped-type-anytime">You can be my wrapped type anytime</h2> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/you-can-be-my-wingman-glitched.png" alt="You can be my wingman anytime"> </figure> </div> <p>Writing this application got me to become a big fan of <a href="https://github.com/elm/compiler/blob/master/hints/comparing-custom-types.md#wrapped-types">Wrapped Custom Types</a>, not just for the extra type safety, but also for the clarity they help give record <code class="language-plaintext highlighter-rouge">type alias</code> and <code class="language-plaintext highlighter-rouge">Msg</code> constructor definitions.</p> <p>Before I knew about wrapped types, the <code class="language-plaintext highlighter-rouge">AudioPlayer</code> model looked like the following:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/AudioPlayer/Model.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="k">alias</span> <span class="kt">AudioPlayer</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">id</span> <span class="p">:</span> <span class="kt">String</span>
    <span class="o">,</span> <span class="n">playlist</span> <span class="p">:</span> <span class="kt">List</span> <span class="kt">Int</span>
    <span class="o">,</span> <span class="n">playlistLength</span> <span class="p">:</span> <span class="kt">Int</span>
    <span class="o">,</span> <span class="n">soundCloudIframeUrl</span> <span class="p">:</span> <span class="kt">String</span>
    <span class="o">,</span> <span class="n">status</span> <span class="p">:</span> <span class="kt">Status</span>
    <span class="o">,</span> <span class="n">volume</span> <span class="p">:</span> <span class="kt">Int</span>
    <span class="p">}</span>
</code></pre></div></div> <p>At face value, this could be considered reasonable, but is the <code class="language-plaintext highlighter-rouge">AudioPlayer</code>’s <code class="language-plaintext highlighter-rouge">id</code> really the same kind of thing as its <code class="language-plaintext highlighter-rouge">soundCloudIframeUrl</code>? Are the <code class="language-plaintext highlighter-rouge">Int</code>s in the <code class="language-plaintext highlighter-rouge">playlist</code> really the same kind of <code class="language-plaintext highlighter-rouge">Int</code>s as the <code class="language-plaintext highlighter-rouge">volume</code>? Should they be…?</p> <p>After trying out creating some types to wrap the basic types, the <code class="language-plaintext highlighter-rouge">AudioPlayer</code> model was transformed into:</p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="k">alias</span> <span class="kt">AudioPlayer</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">id</span> <span class="p">:</span> <span class="kt">AudioPlayerId</span>
    <span class="o">,</span> <span class="n">playlist</span> <span class="p">:</span> <span class="kt">List</span> <span class="kt">TrackIndex</span>
    <span class="o">,</span> <span class="n">playlistLength</span> <span class="p">:</span> <span class="kt">Int</span>
    <span class="o">,</span> <span class="n">soundCloudIframeUrl</span> <span class="p">:</span> <span class="kt">SoundCloudIframeUrl</span>
    <span class="o">,</span> <span class="n">status</span> <span class="p">:</span> <span class="kt">Status</span>
    <span class="o">,</span> <span class="n">volume</span> <span class="p">:</span> <span class="kt">AudioPlayerVolume</span>
    <span class="p">}</span>
</code></pre></div></div> <p>I think that this model with wrapped types conveys more <em>meaning</em> than the one with just basic types. So, I pretty much went all around the application codebase and wrapped every type I could that made sense, resulting in a total of 12 wrapped types created for 80sfy.</p> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/maverick-thumbs-up-glitched.png" alt="Maverick thumbs up."> </figure> </div> <p>In the land of wrapped types, though, conveying meaning does exert an overhead cost. For example, let’s have a look at the ceremony required to wrap and unwrap a <code class="language-plaintext highlighter-rouge">TrackIndex</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/AudioPlayer/Playlist.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Playlist</span> <span class="k">exposing</span>
    <span class="p">(</span> <span class="kt">TrackIndex</span>
    <span class="o">,</span> <span class="c1">-- ...</span>
    <span class="o">,</span> <span class="n">rawTrackIndex</span>
    <span class="o">,</span> <span class="n">trackIndex</span>
    <span class="p">)</span>


<span class="k">type</span> <span class="kt">TrackIndex</span>
    <span class="o">=</span> <span class="kt">TrackIndex</span> <span class="kt">Int</span>

<span class="c1">-- ...</span>

<span class="n">trackIndex</span> <span class="p">:</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">TrackIndex</span>
<span class="n">trackIndex</span> <span class="n">rawTrackIndexInt</span> <span class="o">=</span>
    <span class="kt">TrackIndex</span> <span class="n">rawTrackIndexInt</span>

<span class="n">rawTrackIndex</span> <span class="p">:</span> <span class="kt">TrackIndex</span> <span class="o">-&gt;</span> <span class="kt">Int</span>
<span class="n">rawTrackIndex</span> <span class="p">(</span><span class="kt">TrackIndex</span> <span class="n">rawTrackIndexInt</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">rawTrackIndexInt</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">AudioPlayer</code>’s <code class="language-plaintext highlighter-rouge">playlist</code> field must contain a <code class="language-plaintext highlighter-rouge">List TrackIndex</code>, therefore:</p> <ul> <li>every “raw” track index <code class="language-plaintext highlighter-rouge">Int</code> that goes into the list must first be wrapped by calling <code class="language-plaintext highlighter-rouge">Playlist.trackIndex rawTrackIndexInt</code>.</li> <li>if you ever want to do something with the “raw” <code class="language-plaintext highlighter-rouge">Int</code> value inside of a track index, then you have to unwrap it by calling <code class="language-plaintext highlighter-rouge">Playlist.rawTrackIndex trackIndex</code> </li> </ul> <p>So, wouldn’t it be easier to just…not have wrapped types here? Yes, it would! But, this is the cost of adding (admittedly subjective) clarity to model types, and it is up to you to decide whether doing this is meaningful and worth the cost of admission.</p> <p>Since the above example acts like some kind of wardrobe for an <code class="language-plaintext highlighter-rouge">Int</code>, putting on and taking off a <code class="language-plaintext highlighter-rouge">TrackIndex</code>-coloured coat without any change to the underlying raw value, let’s have a look at some other scenarios where constraints or validation for the raw value are being added to the wrapping process.</p> <p>The <code class="language-plaintext highlighter-rouge">SecretConfig</code> model contains the following values that can be populated by user input:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/SecretConfig/Model.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="k">alias</span> <span class="kt">SecretConfig</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">gifDisplayIntervalSeconds</span> <span class="p">:</span> <span class="kt">GifDisplayIntervalSeconds</span>
    <span class="o">,</span> <span class="n">soundCloudPlaylistUrl</span> <span class="p">:</span> <span class="kt">SoundCloudPlaylistUrl</span>
    <span class="c1">-- ...</span>
    <span class="p">}</span>
</code></pre></div></div> <p>These types wrap around a <code class="language-plaintext highlighter-rouge">Float</code> and a <code class="language-plaintext highlighter-rouge">String</code> respectively, but because we cannot trust anything given to us by our hostile, power-suit-toting users, we need conditions on the raw values that serve as barriers to the wrapped types being created:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/Gif.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Gif</span> <span class="k">exposing</span>
    <span class="p">(</span> <span class="kt">GifDisplayIntervalSeconds</span>
    <span class="o">,</span> <span class="n">displayIntervalSeconds</span>
    <span class="o">,</span> <span class="c1">-- ...</span>
    <span class="p">)</span>


<span class="k">type</span> <span class="kt">GifDisplayIntervalSeconds</span>
    <span class="o">=</span> <span class="kt">GifDisplayIntervalSeconds</span> <span class="kt">Float</span>

<span class="c1">-- ...</span>

<span class="n">displayIntervalSeconds</span> <span class="p">:</span> <span class="kt">Float</span> <span class="o">-&gt;</span> <span class="kt">Maybe</span> <span class="kt">GifDisplayIntervalSeconds</span>
<span class="n">displayIntervalSeconds</span> <span class="n">rawDisplayIntervalSecondsFloat</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">rawDisplayIntervalSecondsFloat</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
        <span class="kt">Just</span> <span class="p">(</span><span class="kt">GifDisplayIntervalSeconds</span> <span class="n">rawDisplayIntervalSecondsFloat</span><span class="p">)</span>

    <span class="k">else</span>
        <span class="kt">Nothing</span>
</code></pre></div></div> <p>A non-positive display interval between animated GIFs does not make sense, so we only wrap positive values, and give malicious users <code class="language-plaintext highlighter-rouge">Nothing</code>.</p> <p>Assuming that this is the only function we create to return new <code class="language-plaintext highlighter-rouge">GifDisplayIntervalSeconds</code> types, we build in some guarantees around the validity of raw values wrapped in a <code class="language-plaintext highlighter-rouge">GifDisplayIntervalSeconds</code> type that we could not get if it was a basic <code class="language-plaintext highlighter-rouge">Float</code> type.</p> <p>Similarly, a <code class="language-plaintext highlighter-rouge">SoundCloudPlaylistUrl</code> isn’t just any kind of <code class="language-plaintext highlighter-rouge">String</code>: it must have a correct prefix. If the raw value does, it gets wrapped; if not, <code class="language-plaintext highlighter-rouge">Nothing</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/SoundCloud/Url.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">SoundCloud</span><span class="o">.</span><span class="kt">Url</span> <span class="k">exposing</span>
    <span class="p">(</span> <span class="kt">SoundCloudPlaylistUrl</span>
    <span class="o">,</span> <span class="n">playlistUrl</span>
    <span class="o">,</span> <span class="c1">-- ...</span>
    <span class="p">)</span>


<span class="k">type</span> <span class="kt">SoundCloudPlaylistUrl</span>
    <span class="o">=</span> <span class="kt">SoundCloudPlaylistUrl</span> <span class="kt">String</span>

<span class="c1">-- ...</span>

<span class="n">playlistUrl</span> <span class="p">:</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Maybe</span> <span class="kt">SoundCloudPlaylistUrl</span>
<span class="n">playlistUrl</span> <span class="n">rawSoundCloudPlaylistUrlString</span> <span class="o">=</span>
    <span class="k">let</span>
        <span class="n">playlistUrlPrefix</span> <span class="p">:</span> <span class="kt">String</span>
        <span class="n">playlistUrlPrefix</span> <span class="o">=</span>
            <span class="s">"</span><span class="s2">https://api.soundcloud.com/"</span>

        <span class="n">isValidUrl</span> <span class="p">:</span> <span class="kt">Bool</span>
        <span class="n">isValidUrl</span> <span class="o">=</span>
            <span class="kt">String</span><span class="o">.</span><span class="n">startsWith</span> <span class="n">playlistUrlPrefix</span> <span class="n">rawSoundCloudPlaylistUrlString</span>
    <span class="k">in</span>
    <span class="k">if</span> <span class="n">isValidUrl</span> <span class="k">then</span>
        <span class="kt">Just</span> <span class="p">(</span><span class="kt">SoundCloudPlaylistUrl</span> <span class="n">rawSoundCloudPlaylistUrlString</span><span class="p">)</span>

    <span class="k">else</span>
        <span class="kt">Nothing</span>
</code></pre></div></div> <p>As you can see, Wrapped Types can provide more than just a fancy enclosure to a basic type. Aside from improvements in type readability, they can help assert the validity of the wrapped raw values, so I would highly recommend giving them a try in your own Elm codebases!</p> <h2 id="ports-where-were-going-we-dont-need-ports">Ports? Where we’re going we don’t need ports</h2> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/we-dont-need-roads-glitched.png" alt="Roads? Where we're going we don't need roads"> </figure> </div> <p>My usage of ports in Elm applications previous to 80sfy was essentially as remote function calls out to the impure badlands of Javascript.</p> <p>For every kind of operation I needed to leverage Javascript for, I would poke a port-shaped hole in the Elm application boundary, do the minimum amount of work in Javascript-land, and return control quickly to the pure, type-safe Elm application fortress.</p> <p>For example, previous iterations of port-related code for the <code class="language-plaintext highlighter-rouge">AudioPlayer</code>, where communications needed to be sent out to the SoundCloud widget iframe, looked like the following, with functions named in the <a href="https://en.wikipedia.org/wiki/Active_voice">active voice</a>:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/AudioPlayer/Ports.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">port</span> <span class="k">module</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Ports</span> <span class="k">exposing</span>
    <span class="p">(</span> <span class="n">pauseAudio</span>
    <span class="o">,</span> <span class="n">playAudio</span>
    <span class="o">,</span> <span class="n">skipToTrack</span>
    <span class="o">..</span> <span class="c1">---</span>
    <span class="p">)</span>


<span class="k">port</span> <span class="n">pauseAudio</span> <span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Cmd</span> <span class="n">msg</span>


<span class="k">port</span> <span class="n">playAudio</span> <span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Cmd</span> <span class="n">msg</span>


<span class="k">port</span> <span class="n">skipToTrack</span> <span class="p">:</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Cmd</span> <span class="n">msg</span>


<span class="c1">-- and a bunch of other port declarations...</span>
</code></pre></div></div> <p>The Elm application would also need to know when the SoundCloud widget controls were used directly so it could update its own internal state. This occurred via subscriptions named in the <a href="https://en.wikipedia.org/wiki/Passive_voice">passive voice</a>:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/AudioPlayer/Subscriptions.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">port</span> <span class="k">module</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Subscriptions</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msgs</span><span class="o">,</span> <span class="n">subscriptions</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Json</span><span class="o">.</span><span class="kt">Decode</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Value</span><span class="p">)</span>
<span class="c1">-- ...</span>


<span class="k">port</span> <span class="n">audioPaused</span> <span class="p">:</span> <span class="p">(</span><span class="kt">Value</span> <span class="o">-&gt;</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Sub</span> <span class="n">msg</span>


<span class="k">port</span> <span class="n">audioPlaying</span> <span class="p">:</span> <span class="p">(</span><span class="kt">Value</span> <span class="o">-&gt;</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Sub</span> <span class="n">msg</span>


<span class="k">port</span> <span class="n">nextTrackNumberRequested</span> <span class="p">:</span> <span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Sub</span> <span class="n">msg</span>


<span class="c1">-- ...</span>
</code></pre></div></div> <p>Soundcloud-specific details about the widget, and its events (and how to bind to them), can be found in the <a href="https://developers.soundcloud.com/docs/api/html5-widget">SoundCloud Widget API</a> documentation. However, the more pointed thing to note about the Javascript code below, is that there are six named Elm <code class="language-plaintext highlighter-rouge">app.ports</code> that are having <code class="language-plaintext highlighter-rouge">subscribe</code> and <code class="language-plaintext highlighter-rouge">send</code> called on them (and this is just a sample; I originally had <em>28</em>(!) named ports/subscriptions across the application):</p> <p><strong><code class="language-plaintext highlighter-rouge">src/soundCloudWidget.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>
<span class="kd">function</span> <span class="nx">init</span><span class="p">(</span><span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="kd">const</span> <span class="nx">scPlayer</span> <span class="o">=</span> <span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">(</span><span class="dl">"</span><span class="s2">track-player</span><span class="dl">"</span><span class="p">)</span> <span class="c1">// initialise SoundCloud player</span>
  <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">Events</span><span class="p">.</span><span class="nx">READY</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">initPlayAudio</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span>
    <span class="nx">initPauseAudio</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span>
    <span class="nx">initSkipToTrack</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span>
    <span class="nx">initTrackFinished</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span>
    <span class="c1">// other similar init functions...</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">initPlayAudio</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Elm tells the SoundCloud widget to play audio</span>
  <span class="nx">ports</span><span class="p">.</span><span class="nx">playAudio</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">play</span><span class="p">()</span>
  <span class="p">})</span>
  <span class="c1">// The SoundCloud widget tells Elm its been told to play (non-Elm request)</span>
  <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">Events</span><span class="p">.</span><span class="nx">PLAY</span><span class="p">,</span> <span class="nx">sound</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">ports</span><span class="p">.</span><span class="nx">audioPlaying</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">sound</span><span class="p">.</span><span class="nx">loadedProgress</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">initPauseAudio</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Elm tells the SoundCloud widget to play audio</span>
  <span class="nx">ports</span><span class="p">.</span><span class="nx">pauseAudio</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">pause</span><span class="p">()</span>
  <span class="p">})</span>
  <span class="c1">// The SoundCloud widget tells Elm its been told to pause (non-Elm request)</span>
  <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">Events</span><span class="p">.</span><span class="nx">PAUSE</span><span class="p">,</span> <span class="nx">sound</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">ports</span><span class="p">.</span><span class="nx">audioPaused</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">sound</span><span class="p">.</span><span class="nx">currentPosition</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">initSkipToTrack</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Elm tells the SoundCloud widget to skip over to a specific track number</span>
  <span class="nx">ports</span><span class="p">.</span><span class="nx">skipToTrack</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">trackNumber</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="nx">trackNumber</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">initTrackFinished</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// The SoundCloud widget tells Elm its finished playing an audio track</span>
  <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">Events</span><span class="p">.</span><span class="nx">FINISH</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">ports</span><span class="p">.</span><span class="nx">nextTrackNumberRequested</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1">// ...</span>
</code></pre></div></div> <p>I wrote the code like this because it was how I understood ports to work, and pretty much all the educational materials I read about ports implemented them essentially like remote function calls into Javascript.</p> <p>However, while re-reading the <a href="https://guide.elm-lang.org/interop/ports.html">Elm Guide’s Ports section</a>, I was greeted by this guidance buried down in the <a href="https://guide.elm-lang.org/interop/ports.html#notes">Notes section</a>:</p> <blockquote> <p>Definitely do not try to make a port for every JS function you need. You may really like Elm and want to do everything in Elm no matter the cost, but ports are not designed for that. Instead, focus on questions like “who owns the state?” and use one or two ports to send messages back and forth.</p> </blockquote> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/bttf2-newspaper-glitched.png" alt="Doc and Marty reading a newspaper"> </figure> </div> <p>Okay, the Elm Guide and I may currently have our differences with regards to application architecture, but I am open to the idea of being completely wrong about how I have written ports.</p> <p>The next question was “are there examples of how to have all messages running through one or two ports?”. These were not easy to find, but I was able to find two references that dealt with this question, and helped me get to the implementation I ended up running with:</p> <ul> <li>The <a href="https://package.elm-lang.org/packages/hendore/elm-port-message/latest/">elm-port-message</a> library</li> <li>The elm-conf 2017 talk <a href="https://www.youtube.com/watch?v=P3pL85n9_5s">The Importance of Ports</a> by <a href="https://github.com/mrmurphy">Murphy Randle</a> </li> </ul> <p>From elm-port-message, I stole the idea of a generic “tagged payload” to use for <em>all</em> the kinds of messages that would flow in and out of Javascript.</p> <p>From The Importance of Ports, I stole the idea of having all outbound port messages typed, and used in an <code class="language-plaintext highlighter-rouge">update</code>-style <code class="language-plaintext highlighter-rouge">case</code> statement that resulted in a <code class="language-plaintext highlighter-rouge">Cmd</code> being sent in a tagged payload through the single outbound application port.</p> <p>The concept of having a single inbound and a single outbound port for message payloads also made me re-consider where code dealing with ports (and, to a lesser extent, subscriptions), should live in the codebase.</p> <p>This resulted in a change of thinking about outbound ports themselves. From them just <em>belonging to</em> or being <em>a part of</em> a component (eg <code class="language-plaintext highlighter-rouge">AudioPlayer.Ports</code> above), to considering the Elm application boundary <em>itself</em>, where outbound port messages are sent to Javascript, being its own major component in the application, containing its own top-level module and <code class="language-plaintext highlighter-rouge">Msg</code> type:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/Update.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Update</span> <span class="k">exposing</span> <span class="p">(</span><span class="n">update</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Msg</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Ports</span>
<span class="c1">-- ...</span>


<span class="k">type</span> <span class="k">alias</span> <span class="kt">Msgs</span> <span class="n">msgs</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">msgs</span>
        <span class="o">|</span> <span class="n">portsMsg</span> <span class="p">:</span> <span class="kt">Ports</span><span class="o">.</span><span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Msg</span>
        <span class="o">,</span> <span class="c1">-- ...</span>
    <span class="p">}</span>


<span class="n">update</span> <span class="p">:</span> <span class="kt">Msgs</span> <span class="n">msgs</span> <span class="o">-&gt;</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Model</span> <span class="o">-&gt;</span> <span class="p">(</span> <span class="kt">Model</span><span class="o">,</span> <span class="kt">Cmd</span> <span class="kt">Msg</span> <span class="p">)</span>
<span class="n">update</span> <span class="n">parentMsgs</span> <span class="n">msg</span> <span class="n">model</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">of</span>
        <span class="c1">-- ...</span>
        <span class="kt">Msg</span><span class="o">.</span><span class="kt">Ports</span> <span class="n">msgForPorts</span> <span class="o">-&gt;</span>
            <span class="p">(</span> <span class="n">model</span><span class="o">,</span> <span class="kt">Ports</span><span class="o">.</span><span class="n">cmd</span> <span class="n">msgForPorts</span> <span class="p">)</span>
        <span class="c1">-- ...</span>
</code></pre></div></div> <p>You may have noticed that the view code for the <code class="language-plaintext highlighter-rouge">ControlPanel</code>’s play/pause button in a previous section sends a <code class="language-plaintext highlighter-rouge">portsMsg Ports.playMsg</code> message when it is clicked. The code above is where that message, and others like it, end up being handled.</p> <p>There is no model to <code class="language-plaintext highlighter-rouge">update</code> for these messages, nor parent message to keep track of: just a <code class="language-plaintext highlighter-rouge">Cmd</code> to be sent to the Elm Runtime, whose generation is delegated to the <code class="language-plaintext highlighter-rouge">Ports.Cmd</code> module:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/Ports/Cmd.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">port</span> <span class="k">module</span> <span class="kt">Ports</span><span class="o">.</span><span class="kt">Cmd</span> <span class="k">exposing</span>
    <span class="p">(</span> <span class="n">cmd</span>
    <span class="o">,</span> <span class="c1">-- ...</span>
    <span class="p">)</span>

<span class="k">import</span> <span class="kt">Json</span><span class="o">.</span><span class="kt">Encode</span> <span class="k">as</span> <span class="kt">Encode</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Value</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Ports</span><span class="o">.</span><span class="kt">Msg</span> <span class="k">as</span> <span class="kt">Msg</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Ports</span><span class="o">.</span><span class="kt">Payload</span> <span class="k">as</span> <span class="kt">Payload</span>
<span class="c1">-- ...</span>


<span class="k">port</span> <span class="n">outbound</span> <span class="p">:</span> <span class="kt">Value</span> <span class="o">-&gt;</span> <span class="kt">Cmd</span> <span class="n">msg</span>


<span class="n">cmd</span> <span class="p">:</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="kt">Cmd</span> <span class="n">msg</span>
<span class="n">cmd</span> <span class="n">msg</span> <span class="o">=</span>
    <span class="k">case</span> <span class="n">msg</span> <span class="k">of</span>
        <span class="c1">-- ...</span>
        <span class="kt">Msg</span><span class="o">.</span><span class="kt">PauseAudio</span> <span class="o">-&gt;</span>
            <span class="n">outbound</span> <span class="p">(</span><span class="kt">Payload</span><span class="o">.</span><span class="n">withTag</span> <span class="s">"</span><span class="s2">PAUSE_AUDIO"</span><span class="p">)</span>

        <span class="kt">Msg</span><span class="o">.</span><span class="kt">PlayAudio</span> <span class="o">-&gt;</span>
            <span class="n">outbound</span> <span class="p">(</span><span class="kt">Payload</span><span class="o">.</span><span class="n">withTag</span> <span class="s">"</span><span class="s2">PLAY_AUDIO"</span><span class="p">)</span>

        <span class="kt">Msg</span><span class="o">.</span><span class="kt">SkipToTrack</span> <span class="n">trackNumber</span> <span class="o">-&gt;</span>
            <span class="k">let</span>
                <span class="n">data</span> <span class="p">:</span> <span class="kt">Value</span>
                <span class="n">data</span> <span class="o">=</span>
                    <span class="kt">Encode</span><span class="o">.</span><span class="n">object</span> <span class="p">[</span> <span class="p">(</span> <span class="s">"</span><span class="s2">trackNumber"</span><span class="o">,</span> <span class="kt">Encode</span><span class="o">.</span><span class="n">int</span> <span class="n">trackNumber</span> <span class="p">)</span> <span class="p">]</span>

                <span class="n">payload</span> <span class="p">:</span> <span class="kt">Value</span>
                <span class="n">payload</span> <span class="o">=</span>
                    <span class="kt">Payload</span><span class="o">.</span><span class="n">withTaggedData</span> <span class="p">(</span> <span class="s">"</span><span class="s2">SKIP_TO_TRACK"</span><span class="o">,</span> <span class="n">data</span> <span class="p">)</span>
            <span class="k">in</span>
            <span class="n">outbound</span> <span class="n">payload</span>
</code></pre></div></div> <p>Every typed <code class="language-plaintext highlighter-rouge">Ports.Msg</code> sends a tagged <code class="language-plaintext highlighter-rouge">Payload</code>, with or without some <code class="language-plaintext highlighter-rouge">data</code>, through a single <code class="language-plaintext highlighter-rouge">outbound</code> port. For the tag name convention, I decided to use <a href="https://redux.js.org/">Redux</a>’s original <a href="https://redux.js.org/style-guide/style-guide#priority-c-rules-recommended">action type naming convention of <code class="language-plaintext highlighter-rouge">"SCREAMING_SNAKE_CASE"</code></a> (Elm is <a href="https://redux.js.org/understanding/history-and-design/prior-art#elm">one of Redux’s inspirations</a>, after all).</p> <p>Code for the payload itself lives under <code class="language-plaintext highlighter-rouge">Ports.Payload</code>, and specifies a unified way of encoding and decoding a JSON <code class="language-plaintext highlighter-rouge">Value</code> for this purpose. Rather than send any raw Elm types as parameters to ports (eg the <code class="language-plaintext highlighter-rouge">Int</code> in <code class="language-plaintext highlighter-rouge">port skipToTrack : Int -&gt; Cmd msg</code>), we specify that <em>only</em> <code class="language-plaintext highlighter-rouge">Value</code>s can be sent and received via ports (which can also be enforced by the <a href="https://package.elm-lang.org/packages/sparksp/elm-review-ports/1.3.0/NoUnsafePorts"><code class="language-plaintext highlighter-rouge">NoUnsafePorts</code></a> rule in <a href="https://package.elm-lang.org/packages/sparksp/elm-review-ports/latest">elm-review-ports</a>):</p> <p><strong><code class="language-plaintext highlighter-rouge">src/Ports/Payload.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">Ports</span><span class="o">.</span><span class="kt">Payload</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Payload</span><span class="o">,</span> <span class="n">decode</span><span class="o">,</span> <span class="n">withTag</span><span class="o">,</span> <span class="n">withTaggedData</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">Json</span><span class="o">.</span><span class="kt">Decode</span> <span class="k">as</span> <span class="kt">Decode</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Decoder</span><span class="o">,</span> <span class="kt">Value</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Json</span><span class="o">.</span><span class="kt">Decode</span><span class="o">.</span><span class="kt">Pipeline</span> <span class="k">as</span> <span class="kt">Pipeline</span>
<span class="k">import</span> <span class="kt">Json</span><span class="o">.</span><span class="kt">Encode</span> <span class="k">as</span> <span class="kt">Encode</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Value</span><span class="p">)</span>


<span class="k">type</span> <span class="k">alias</span> <span class="kt">Payload</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">tag</span> <span class="p">:</span> <span class="kt">String</span>
    <span class="o">,</span> <span class="n">data</span> <span class="p">:</span> <span class="kt">Value</span>
    <span class="p">}</span>


<span class="n">decode</span> <span class="p">:</span> <span class="kt">Value</span> <span class="o">-&gt;</span> <span class="kt">Payload</span>
<span class="n">decode</span> <span class="n">value</span> <span class="o">=</span>
    <span class="n">value</span>
        <span class="o">|&gt;</span> <span class="kt">Decode</span><span class="o">.</span><span class="n">decodeValue</span> <span class="n">decoder</span>
        <span class="o">|&gt;</span> <span class="kt">Result</span><span class="o">.</span><span class="n">withDefault</span> <span class="p">(</span><span class="kt">Payload</span> <span class="s">"</span><span class="s2">"</span> <span class="kt">Encode</span><span class="o">.</span><span class="n">null</span><span class="p">)</span>


<span class="n">withTag</span> <span class="p">:</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="kt">Value</span>
<span class="n">withTag</span> <span class="n">tag</span> <span class="o">=</span>
    <span class="n">withTaggedData</span> <span class="p">(</span> <span class="n">tag</span><span class="o">,</span> <span class="kt">Encode</span><span class="o">.</span><span class="n">null</span> <span class="p">)</span>


<span class="n">withTaggedData</span> <span class="p">:</span> <span class="p">(</span> <span class="kt">String</span><span class="o">,</span> <span class="kt">Value</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Value</span>
<span class="n">withTaggedData</span> <span class="p">(</span> <span class="n">tag</span><span class="o">,</span> <span class="n">data</span> <span class="p">)</span> <span class="o">=</span>
    <span class="kt">Encode</span><span class="o">.</span><span class="n">object</span>
        <span class="p">[</span> <span class="p">(</span> <span class="s">"</span><span class="s2">tag"</span><span class="o">,</span> <span class="kt">Encode</span><span class="o">.</span><span class="n">string</span> <span class="n">tag</span> <span class="p">)</span>
        <span class="o">,</span> <span class="p">(</span> <span class="s">"</span><span class="s2">data"</span><span class="o">,</span> <span class="n">data</span> <span class="p">)</span>
        <span class="p">]</span>



<span class="c1">-- PRIVATE</span>


<span class="n">decoder</span> <span class="p">:</span> <span class="kt">Decoder</span> <span class="kt">Payload</span>
<span class="n">decoder</span> <span class="o">=</span>
    <span class="kt">Decode</span><span class="o">.</span><span class="n">succeed</span> <span class="kt">Payload</span>
        <span class="o">|&gt;</span> <span class="kt">Pipeline</span><span class="o">.</span><span class="n">required</span> <span class="s">"</span><span class="s2">tag"</span> <span class="kt">Decode</span><span class="o">.</span><span class="n">string</span>
        <span class="o">|&gt;</span> <span class="kt">Pipeline</span><span class="o">.</span><span class="n">optional</span> <span class="s">"</span><span class="s2">data"</span> <span class="kt">Decode</span><span class="o">.</span><span class="n">value</span> <span class="kt">Encode</span><span class="o">.</span><span class="n">null</span>
</code></pre></div></div> <p>Now that we have outbound messages going out to Javascript via a single port, the Javascript code needs to change so that it can deal with these different types of tagged payloads, which is where we lean on our old friend <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/switch"><code class="language-plaintext highlighter-rouge">switch</code></a>:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/js/soundCloudWidget.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>
<span class="kd">function</span> <span class="nx">init</span><span class="p">(</span><span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">scPlayer</span> <span class="o">=</span> <span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">(</span><span class="dl">"</span><span class="s2">track-player</span><span class="dl">"</span><span class="p">)</span>
  <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">Events</span><span class="p">.</span><span class="nx">READY</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">initOutboundPortMessageHandling</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">initOutboundPortMessageHandling</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ports</span><span class="p">.</span><span class="nx">outbound</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(({</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">data</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="dl">"</span><span class="s2">PLAY_AUDIO</span><span class="dl">"</span><span class="p">:</span>
      <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">play</span><span class="p">()</span>
      <span class="k">break</span>
    <span class="k">case</span> <span class="dl">"</span><span class="s2">PAUSE_AUDIO</span><span class="dl">"</span><span class="p">:</span>
      <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">pause</span><span class="p">()</span>
      <span class="k">break</span>
    <span class="k">case</span> <span class="dl">"</span><span class="s2">SKIP_TO_TRACK</span><span class="dl">"</span><span class="p">:</span>
      <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">trackNumber</span><span class="p">)</span>
      <span class="k">break</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/biffs-gang-glitched.png" alt="Biff's gang"> </figure> </div> <p>So, that’s the first half of the story: Elm to Javascript. What about messages going from Javascript to Elm? Let’s follow the journey, starting from Javascript, focusing on the events generated from the SoundCloud widget:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/js/soundCloudWidget.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ...</span>
<span class="kd">function</span> <span class="nx">init</span><span class="p">(</span><span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">scPlayer</span> <span class="o">=</span> <span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">(</span><span class="dl">"</span><span class="s2">track-player</span><span class="dl">"</span><span class="p">)</span>
  <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">Events</span><span class="p">.</span><span class="nx">READY</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">bindSoundCloudWidgetEvents</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">bindSoundCloudWidgetEvents</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">Events</span><span class="p">.</span><span class="nx">PLAY</span><span class="p">,</span> <span class="nx">sound</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">ports</span><span class="p">.</span><span class="nx">inbound</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
      <span class="na">tag</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AUDIO_PLAYING</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="nx">sound</span><span class="p">.</span><span class="nx">loadedProgress</span>
    <span class="p">})</span>
  <span class="p">})</span>
  <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">Events</span><span class="p">.</span><span class="nx">PAUSE</span><span class="p">,</span> <span class="nx">sound</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="nx">ports</span><span class="p">.</span><span class="nx">inbound</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
      <span class="na">tag</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AUDIO_PAUSED</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="nx">sound</span><span class="p">.</span><span class="nx">currentPosition</span>
    <span class="p">})</span>
  <span class="p">})</span>
  <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">Events</span><span class="p">.</span><span class="nx">FINISH</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">ports</span><span class="p">.</span><span class="nx">inbound</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
      <span class="na">tag</span><span class="p">:</span> <span class="dl">"</span><span class="s2">NEXT_TRACK_NUMBER_REQUESTED</span><span class="dl">"</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div> <p>There’s not too much difference in the code here compared to the previous implementation, aside from:</p> <ul> <li>minor code re-structuring to put all the SoundCloud widget bindings together</li> <li>all messages now being sent via a single <code class="language-plaintext highlighter-rouge">inbound</code> port</li> <li>like the <code class="language-plaintext highlighter-rouge">outbound</code> messages, all <code class="language-plaintext highlighter-rouge">inbound</code> messages are <code class="language-plaintext highlighter-rouge">Payload</code>-shaped objects, rather than raw values</li> </ul> <p>Of particular note, at least for me, is the <code class="language-plaintext highlighter-rouge">"NEXT_TRACK_NUMBER_REQUESTED"</code> payload, which can contain only a <code class="language-plaintext highlighter-rouge">tag</code> and no <code class="language-plaintext highlighter-rouge">data</code> information, and still be valid: essentially just a message telling Elm that “the next track number has been requested”.</p> <blockquote> <p>I think that sending this <code class="language-plaintext highlighter-rouge">data</code>-less payload object is a preferable option to the original implementation, which explicitly required needing to <code class="language-plaintext highlighter-rouge">send</code> a <code class="language-plaintext highlighter-rouge">null</code> back to Elm, when the objective was really to call <code class="language-plaintext highlighter-rouge">send</code> <em>without</em> any parameters:</p> <p><strong>What I wanted to do in the original code:</strong></p> <p><em>JS</em>:</p> <div class="language-js highlighter-rouge"> <div class="highlight"><pre class="highlight"><code> <span class="kd">function</span> <span class="nx">initTrackFinished</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">Events</span><span class="p">.</span><span class="nx">FINISH</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="c1">// Calling `send` on a port with no parameters is invalid, apparently...</span>
     <span class="nx">ports</span><span class="p">.</span><span class="nx">nextTrackNumberRequested</span><span class="p">.</span><span class="nx">send</span><span class="p">()</span>
   <span class="p">})</span>
 <span class="p">}</span>
</code></pre></div> </div> <p><em>Elm</em>:</p> <div class="language-elm highlighter-rouge"> <div class="highlight"><pre class="highlight"><code> <span class="k">port</span> <span class="n">nextTrackNumberRequested</span> <span class="p">:</span> <span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Sub</span> <span class="n">msg</span>
</code></pre></div> </div> <p>The port receives no parameters, so having <code class="language-plaintext highlighter-rouge">()</code> as the parameter is correct, right…? (Spoiler: Nope.)</p> <p><strong>What I ended up needing to do to make it go:</strong></p> <p><em>JS</em>:</p> <div class="language-js highlighter-rouge"> <div class="highlight"><pre class="highlight"><code> <span class="kd">function</span> <span class="nx">initTrackFinished</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">Events</span><span class="p">.</span><span class="nx">FINISH</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="c1">// Needing to send an explicit `null` seems a bit strange to me...</span>
     <span class="nx">ports</span><span class="p">.</span><span class="nx">nextTrackNumberRequested</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
   <span class="p">})</span>
 <span class="p">}</span>
</code></pre></div> </div> <p>The only documentation I could find regarding needing to do this was <a href="https://stackoverflow.com/questions/41679386/elm-define-subscription-port-with-no-parameters">this Stack Overflow answer</a>, so this information would be a nice addition to the Elm Guide.</p> <p>Anyway, using <code class="language-plaintext highlighter-rouge">Payload</code>s means this issue is now irrelevant, so let’s get back to Elm-land to see how messages coming through on the single <code class="language-plaintext highlighter-rouge">inbound</code> port are being handled.</p> </blockquote> <p>The <code class="language-plaintext highlighter-rouge">inbound</code> port definition lives in the top-level <code class="language-plaintext highlighter-rouge">Ports</code> module, making sure that knowledge about <code class="language-plaintext highlighter-rouge">port module</code>s (and hence the world outside of the Elm) are kept solely to the <code class="language-plaintext highlighter-rouge">Ports</code> and <code class="language-plaintext highlighter-rouge">Ports.Cmd</code> family of modules:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/Ports.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">port</span> <span class="k">module</span> <span class="kt">Ports</span> <span class="k">exposing</span>
    <span class="p">(</span> <span class="n">inbound</span>
    <span class="o">,</span> <span class="c1">-- ...</span>
    <span class="p">)</span>

<span class="k">import</span> <span class="kt">Json</span><span class="o">.</span><span class="kt">Encode</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Value</span><span class="p">)</span>
<span class="c1">-- ...</span>


<span class="k">port</span> <span class="n">inbound</span> <span class="p">:</span> <span class="p">(</span><span class="kt">Value</span> <span class="o">-&gt;</span> <span class="n">msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Sub</span> <span class="n">msg</span>
</code></pre></div></div> <p>Since the different <code class="language-plaintext highlighter-rouge">inbound</code> messages will only be relevant for specific parts of the application, code to handle subscriptions still lives as sub-modules of the components the messages are relevant to.</p> <p>For example, <code class="language-plaintext highlighter-rouge">AudioPlayer</code>-specific messages sent in the <code class="language-plaintext highlighter-rouge">bindSoundCloudWidgetEvents</code> function are handled in <code class="language-plaintext highlighter-rouge">AudioPlayer.Subscriptions</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/AudioPlayer/Subscriptions.elm</code></strong></p> <div class="language-elm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Subscriptions</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">ParentMsgs</span><span class="o">,</span> <span class="n">subscriptions</span><span class="p">)</span>

<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Model</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">AudioPlayer</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">AudioPlayer</span><span class="o">.</span><span class="kt">Msg</span> <span class="k">as</span> <span class="kt">Msg</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Msg</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Json</span><span class="o">.</span><span class="kt">Decode</span> <span class="k">exposing</span> <span class="p">(</span><span class="kt">Value</span><span class="p">)</span>
<span class="k">import</span> <span class="kt">Ports</span>
<span class="c1">-- ...</span>


<span class="k">type</span> <span class="k">alias</span> <span class="kt">ParentMsgs</span> <span class="n">msgs</span> <span class="n">msg</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">msgs</span>
        <span class="o">|</span> <span class="n">audioPlayerMsg</span> <span class="p">:</span> <span class="kt">Msg</span> <span class="o">-&gt;</span> <span class="n">msg</span>
        <span class="o">,</span> <span class="n">noOpMsg</span> <span class="p">:</span> <span class="n">msg</span>
    <span class="p">}</span>


<span class="n">subscriptions</span> <span class="p">:</span> <span class="kt">ParentMsgs</span> <span class="n">msgs</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="kt">AudioPlayer</span> <span class="o">-&gt;</span> <span class="kt">Sub</span> <span class="n">msg</span>
<span class="n">subscriptions</span> <span class="n">parentMsgs</span> <span class="n">audioPlayer</span> <span class="o">=</span>
    <span class="kt">Ports</span><span class="o">.</span><span class="n">inbound</span> <span class="p">(</span><span class="n">handlePortMessage</span> <span class="n">parentMsgs</span> <span class="n">audioPlayer</span><span class="p">)</span>



<span class="c1">-- PRIVATE</span>


<span class="n">handlePortMessage</span> <span class="p">:</span> <span class="kt">ParentMsgs</span> <span class="n">msgs</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="kt">AudioPlayer</span> <span class="o">-&gt;</span> <span class="kt">Value</span> <span class="o">-&gt;</span> <span class="n">msg</span>
<span class="n">handlePortMessage</span> <span class="p">{</span> <span class="n">audioPlayerMsg</span><span class="o">,</span> <span class="n">noOpMsg</span> <span class="p">}</span> <span class="n">audioPlayer</span> <span class="n">payload</span> <span class="o">=</span>
    <span class="k">let</span>
        <span class="p">{</span> <span class="n">tag</span><span class="o">,</span> <span class="n">data</span> <span class="p">}</span> <span class="o">=</span>
            <span class="kt">Ports</span><span class="o">.</span><span class="n">decodePayload</span> <span class="n">payload</span>
    <span class="k">in</span>
    <span class="k">case</span> <span class="n">tag</span> <span class="k">of</span>
        <span class="s">"</span><span class="s2">AUDIO_PAUSED"</span> <span class="o">-&gt;</span>
            <span class="c1">-- Handle "AUDIO_PAUSED" messages</span>

        <span class="s">"</span><span class="s2">AUDIO_PLAYING"</span> <span class="o">-&gt;</span>
            <span class="c1">-- Handle "AUDIO_PLAYING" messages</span>

        <span class="s">"</span><span class="s2">NEXT_TRACK_NUMBER_REQUESTED"</span> <span class="o">-&gt;</span>
            <span class="c1">-- Handle "NEXT_TRACK_NUMBER_REQUESTED" messages</span>

        <span class="n">_</span> <span class="o">-&gt;</span>
            <span class="n">noOpMsg</span>
</code></pre></div></div> <p>Some notes about this module:</p> <ul> <li>Although stating this might be obvious for some, the <code class="language-plaintext highlighter-rouge">handlePortMessage</code> function is the <code class="language-plaintext highlighter-rouge">(Value -&gt; msg)</code> function in <code class="language-plaintext highlighter-rouge">port inbound (Value -&gt; msg) -&gt; Sub msg</code> </li> <li> <code class="language-plaintext highlighter-rouge">handlePortMessage</code> receives the <code class="language-plaintext highlighter-rouge">payload</code> from Javascript-land, and performs some action depending on the <code class="language-plaintext highlighter-rouge">tag</code> value, details of which are not important here, but they are, of course, available in the codebase</li> <li>Once it is known <em>how</em> the inbound message is to be handled, the work to generate the subscription is delegated off to the centralised <code class="language-plaintext highlighter-rouge">Ports.inbound</code> function</li> </ul> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/flying-delorean-glitched.png" alt="Flying DeLorean"> </figure> </div> <p>So, while “where we’re going we did actually need ports”, I think that cutting down the number of those ports from 28 to 2 can be considered a win. I hope that the example above, and the 80sfy codebase, can at least serve as an example of how to do centralised port message sending if that is a path you are looking at going down for your own Elm application.</p> <h2 id="when-you-code-js-your-heart-dies">When you code JS your heart dies</h2> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/your-heart-dies-glitched.png" alt="When you grow up your heart dies"> </figure> </div> <p>My developer helmet got many dents on it as I repeatedly ran into walls while coding up the Javascript side of the 80sfy application.</p> <p>Some of these issues were due to browser peculiarities, or undocumented quirks of the <a href="https://developers.soundcloud.com/docs/api/html5-widget">SoundCloud Widget API</a>, which I am wagering has probably not received much love in a while. But, since all these issues occurred in Javascript-land, it did, however unfairly, became the target of my frustration.</p> <p>So, without further adieu, here is a random list of JS-land issues I came across and how they needed to be fixed, which will hopefully save you some time if you ever encounter similar issues.</p> <h3 id="soundcloud-iframe-loading-delays">SoundCloud iframe loading delays</h3> <p>In the 80sfy application, the first request that ends up being made to the SoundCloud widget is to return the list of its sound objects, so that list’s length can be sent back to Elm to form the basis of the shuffled playlist.</p> <p>However, the SoundCloud iframe seems to require a little bit of time to initialise before it can get its sounds, so in order to avoid any <code class="language-plaintext highlighter-rouge">"Uncaught Error: mediaPayload required."</code> errors displaying in the browser JS console, I needed to introduce a one-time delay using <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout"><code class="language-plaintext highlighter-rouge">setTimeout()</code></a> before calling <code class="language-plaintext highlighter-rouge">scPlayer.getSounds()</code>:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/js/soundCloudWidget.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">initAudioPlayer</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">volume</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">getSounds</span><span class="p">(</span><span class="nx">sounds</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">ports</span><span class="p">.</span><span class="nx">inbound</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
        <span class="na">tag</span><span class="p">:</span> <span class="dl">"</span><span class="s2">PLAYLIST_LENGTH_FETCHED</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">data</span><span class="p">:</span> <span class="nx">sounds</span><span class="p">.</span><span class="nx">length</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">},</span> <span class="mi">3000</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">3000</code> millisecond delay was the value gleaned from trial and error: values less than this did not seem to be long enough to make the error go away.</p> <h3 id="firefox-blur-event-issues">Firefox blur event issues</h3> <p><code class="language-plaintext highlighter-rouge">setTimeout()</code> ended up (bafflingly) being the solution to another completely different issue: this time related to <a href="https://www.mozilla.org/en-US/firefox/">Firefox</a> <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/blur_event"><code class="language-plaintext highlighter-rouge">blur</code> events</a>.</p> <p>In the 80sfy application, if you switch to another browser tab or window, which fires off a <code class="language-plaintext highlighter-rouge">blur</code> event, the GIFs stop playing, saving unneeded Giphy API calls when the application is not the centre of attention.</p> <p>The issue is that, for Firefox <em>only</em>, if you click the SoundCloud widget iframe, it looks like Firefox considers it a different browser window, and fires off a blur event, stopping the GIFs unexpectedly. Scouring the internet for the cause of this issue led to <a href="https://gist.github.com/jaydson/1780598#gistcomment-2609301">this Gist comment</a>, where:</p> <blockquote> <p>For me, adding a 0 second timeout…made it work in Firefox. The problem seems to be that, at the time Firefox fires the blur event, it has not yet updated the <code class="language-plaintext highlighter-rouge">document.activeElement</code> [the iframe], so it evaluates to <code class="language-plaintext highlighter-rouge">false</code>.</p> </blockquote> <p>Trying that led to this code:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/js/videoPlayer.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">initWindowEventListeners</span><span class="p">(</span><span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">blur</span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">activeElementId</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">activeElement</span><span class="p">.</span><span class="nx">id</span>
      <span class="nx">ports</span><span class="p">.</span><span class="nx">inbound</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
        <span class="na">tag</span><span class="p">:</span> <span class="dl">"</span><span class="s2">WINDOW_BLURRED</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">data</span><span class="p">:</span> <span class="nx">activeElementId</span>
      <span class="p">})</span>
    <span class="p">},</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div> <p>And…it worked. Same behaviour across browsers now. Go figure ¯\<em>(ツ)</em>/¯</p> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/breakfast-club-group-glitched.png" alt="The Breakfast Club"> </figure> </div> <h3 id="skipping-tracks-un-pauses-soundcloud-player">Skipping tracks un-pauses SoundCloud player</h3> <p>Regardless of whether the SoundCloud iframe widget is paused or not, if you choose to skip to the next track in the playlist, it starts playing.</p> <p>This may be intended behaviour for the widget, but it was undesired behaviour for me: I wanted to be able to skip tracks while continuing to be in a paused state.</p> <p>So, since the call to <code class="language-plaintext highlighter-rouge">scPlayer.skip</code> forcably <em>un-pauses</em> the player, we need to check if the player was originally paused before the <code class="language-plaintext highlighter-rouge">skip</code> command was issued, and if so, keep the SoundCloud widget player paused by <em>re-pausing</em> it:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/js/soundCloudWidget.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">initOutboundPortMessageHandling</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ports</span><span class="p">.</span><span class="nx">outbound</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(({</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">data</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">case</span> <span class="dl">"</span><span class="s2">SKIP_TO_TRACK</span><span class="dl">"</span><span class="p">:</span>
      <span class="c1">// Get player's original paused state</span>
      <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">isPaused</span><span class="p">(</span><span class="nx">paused</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">skip</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">trackNumber</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">paused</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// *re-pause* player if it was originally paused but got *un-paused*</span>
          <span class="c1">// by the above call to `scPlayer.skip`.</span>
          <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">pause</span><span class="p">()</span>
        <span class="p">}</span>
      <span class="p">})</span>
      <span class="k">break</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="only-tell-elm-about-real-pause-events">Only tell Elm about “real” pause events</h3> <p>The “re-pausing” problem above caused a bit of a cascade of issues back into Elm-land.</p> <p>There is code that binds to the <code class="language-plaintext highlighter-rouge">SC.Widget.Events.PAUSE</code> event, which sends a message to an <code class="language-plaintext highlighter-rouge">inbound</code> port to let Elm know that the SoundCloud player has been paused. The problem is that any “forced re-pausing” should not be considered a “real” pause event for Elm notification purposes.</p> <p>So, the issue now is how can we intercept and interrogate a SoundCloud <code class="language-plaintext highlighter-rouge">sound</code> object in the <code class="language-plaintext highlighter-rouge">PAUSE</code> event callback to make sure that Elm only gets a <code class="language-plaintext highlighter-rouge">"AUDIO_PAUSED"</code> message when a “real” pause occurs?</p> <p>The first thing we can do is something similar to the handling in the <code class="language-plaintext highlighter-rouge">"SKIP_TO_TRACK"</code> message, and only send the <code class="language-plaintext highlighter-rouge">"AUDIO_PAUSED"</code> message when the player has been <em>actively</em> paused:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/js/soundCloudWidget.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">bindSoundCloudWidgetEvents</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">Events</span><span class="p">.</span><span class="nx">PAUSE</span><span class="p">,</span> <span class="nx">sound</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">isPaused</span><span class="p">(</span><span class="nx">paused</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">paused</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ports</span><span class="p">.</span><span class="nx">inbound</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
          <span class="na">tag</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AUDIO_PAUSED</span><span class="dl">"</span><span class="p">,</span>
          <span class="na">data</span><span class="p">:</span> <span class="nx">sound</span><span class="p">.</span><span class="nx">currentPosition</span>
        <span class="p">})</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">})</span>
</code></pre></div></div> <p>This code works as expected for track skips that happen while a track is playing (the <code class="language-plaintext highlighter-rouge">paused</code> value above will be <code class="language-plaintext highlighter-rouge">false</code> when you ask if <code class="language-plaintext highlighter-rouge">scPlayer.isPaused</code> while it is playing), but not when the player is in a paused state and a track is skipped (resulting in the forced re-pause), since that will still count as a “pause”! Argh!</p> <p>So, what needs to be done here is add a guard clause to check the state of the <code class="language-plaintext highlighter-rouge">sound.loadedProgress</code>. If it is <code class="language-plaintext highlighter-rouge">0</code>, that means that a “forced re-pause” has occurred after a track skip has happened to a new track, which has not started playing yet, and hence has not recorded any progression:</p> <p><strong><code class="language-plaintext highlighter-rouge">src/js/soundCloudWidget.js</code></strong></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">bindSoundCloudWidgetEvents</span><span class="p">(</span><span class="nx">scPlayer</span><span class="p">,</span> <span class="nx">ports</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">SC</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">Events</span><span class="p">.</span><span class="nx">PAUSE</span><span class="p">,</span> <span class="nx">sound</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sound</span><span class="p">.</span><span class="nx">loadedProgress</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">scPlayer</span><span class="p">.</span><span class="nx">isPaused</span><span class="p">(</span><span class="nx">paused</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">paused</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ports</span><span class="p">.</span><span class="nx">inbound</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
          <span class="na">tag</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AUDIO_PAUSED</span><span class="dl">"</span><span class="p">,</span>
          <span class="na">data</span><span class="p">:</span> <span class="nx">sound</span><span class="p">.</span><span class="nx">currentPosition</span>
        <span class="p">})</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">})</span>
</code></pre></div></div> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/breakfast-club-fist-pump-glitched.png" alt="Breakfast Club fist pump"> </figure> </div> <p>Does all this sound confusing? It was! Please learn from my trial and error, and I hope you save yourself some time if you encounter similar issues!</p> <h2 id="all-this-code-will-be-lost-in-time-like-tears-in-rain">All this code will be lost in time, like tears in rain</h2> <div style="margin: auto; width: 95%;"> <figure style="display: block;"> <img src="/assets/images/2021-05-02/tears-in-rain-glitched.png" alt="All these moments will be lost in time. Like tears in rain."> </figure> </div> <p>I spent more time than I intended on architecting, refactoring, re-writing, and polishing this application, but I feel like during this journey I learned significantly more about Elm than I had known before.</p> <p>It represents a conscientiously-written codebase to me now, but in the future, who knows? Maybe I will come around to the Elm Guide’s way of thinking and abandon my stubborn ideas about application structure, or maybe there is some food for thought in here for other Elm developers (reach out and let me know!).</p> <p>Anyway, it’s just an application that plays synthwave sounds to animated GIFs, man. Grab an <a href="https://drinkarizona.com/collections/drinks">ice tea</a>, don’t think about it too hard, and just <a href="https://www.paulfioravanti.com/80sfy/">ｒｅｌａｘ</a>.</p> <blockquote> <p>For anyone who is curious about the glitched images, I used <a href="https://photomosh.com/">Photo Mosh</a> to initially add scanlines and some other effects, and then <a href="https://snorpey.github.io/jpg-glitch/">Image Glitch Tool</a> for the glitching.</p> </blockquote> </section> <footer class="page__meta"> <p class="page__taxonomy"> <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong> <span itemprop="keywords"> <a href="/tags/80s" class="page__taxonomy-item" rel="tag">80s</a><span class="sep">, </span> <a href="/tags/elm" class="page__taxonomy-item" rel="tag">elm</a><span class="sep">, </span> <a href="/tags/functional-programming" class="page__taxonomy-item" rel="tag">functional-programming</a><span class="sep">, </span> <a href="/tags/giphy" class="page__taxonomy-item" rel="tag">giphy</a><span class="sep">, </span> <a href="/tags/retrowave" class="page__taxonomy-item" rel="tag">retrowave</a><span class="sep">, </span> <a href="/tags/soundcloud" class="page__taxonomy-item" rel="tag">soundcloud</a><span class="sep">, </span> <a href="/tags/synthwave" class="page__taxonomy-item" rel="tag">synthwave</a> </span> </p> <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-05-02">May 2, 2021</time></p> </footer> <section class="page__share"> <a href="https://twitter.com/intent/tweet?via=paulfioravanti&amp;text=%E2%96%91%E2%96%92%E2%96%93%EF%BC%A5%EF%BC%AC%EF%BC%AD%EF%BC%B3%EF%BC%B4%EF%BC%A8%EF%BC%A5%EF%BC%B4%EF%BC%A9%EF%BC%A3%EF%BC%B3%E2%96%93%E2%96%92%E2%96%91%20https%3A%2F%2Fwww.paulfioravanti.com%2Fblog%2Felmsthetics%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.paulfioravanti.com%2Fblog%2Felmsthetics%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.paulfioravanti.com%2Fblog%2Felmsthetics%2F&amp;title=%E2%96%91%E2%96%92%E2%96%93%EF%BC%A5%EF%BC%AC%EF%BC%AD%EF%BC%B3%EF%BC%B4%EF%BC%A8%EF%BC%A5%EF%BC%B4%EF%BC%A9%EF%BC%A3%EF%BC%B3%E2%96%93%E2%96%92%E2%96%91" class="btn btn--reddit" title=" Reddit"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i><span> Reddit</span></a> <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fwww.paulfioravanti.com%2Fblog%2Felmsthetics%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a> </section> <nav class="pagination"> <a href="/blog/test-driven-fairy-tale/" class="pagination--pager" title="Test-Driven Fairy Tale ">Previous</a> <a href="/blog/coding-test-review-sentia/" class="pagination--pager" title="Coding Test Review: Sentia ">Next</a> </nav> </div> <div class="page__comments"> <h4 class="page__comments-title">Comments</h4> <section id="disqus_thread"></section> </div> </article> <div class="page__related"> <h4 class="page__related-title">You May Also Enjoy</h4> <div class="grid__wrapper"> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2021-11-17/daniel-kuberek-ijL9kGvjO-E-unsplash.jpg" alt="bottle near water"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/mums-meetup/" rel="permalink">Mum’s Meetup </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2021-11-17T13:05:00+11:00">November 17, 2021</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 4 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">Organising a meetup gave my Mum a new lease on life. </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2021-10-17/kinpachi-sensei.jpg" alt="Kinpachi-sensei teaches the meaning of the character for 'person'."> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/persons-character/" rel="permalink">A Person’s Character (人という字は) </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2021-10-17T16:14:00+11:00">October 17, 2021</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 6 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">“人” may be the kanji for person, but its simplicity masks a deeper meaning. </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2021-10-10/denny-muller-W3wd-rmLP7I-unsplash.jpg" alt="pipe organ"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/pipe-codebase-into-ruby/" rel="permalink">Pipe a Codebase into Ruby </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2021-10-10T20:50:00+11:00">October 10, 2021</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 6 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">“Pipes! Well done! I feel like Leonardo da Vinci! It’s a masterpiece!” </p> </article> </div> <div class="grid__item"> <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"> <div class="archive__item-teaser"> <img src="/assets/images/2021-10-06/van-gogh-wheatfield-with-cypresses-june-1889.jpg" alt="Van Gogh: A Wheatfield with Cypresses, June 1889"> </div> <h2 class="archive__item-title no_toc" itemprop="headline"> <a href="/blog/canvas-of-cypress-tests/" rel="permalink">A Canvas of Cypress Tests </a> </h2> <p class="page__meta"> <span class="page__meta-date"> <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> <time datetime="2021-10-06T22:50:00+11:00">October 6, 2021</time> </span> <span class="page__meta-sep"></span> <span class="page__meta-readtime"> <i class="far fa-fw fa-clock" aria-hidden="true"></i> 20 minute read </span> </p> <p class="archive__item-excerpt" itemprop="description">“I have a canvas of Cypress tests with apps of Elm, some Elixir, a browser like a preview of executed commands” </p> </article> </div> </div> </div> </div> </div> <div class="search-content"> <div class="search-content__inner-wrap"> <form class="search-content__form" onkeydown="return event.key != 'Enter';"> <label class="sr-only" for="search"> Enter your search term... </label> <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..."> </form> <div id="results" class="results"></div> </div> </div> <div id="footer" class="page__footer"> <footer> <div class="page__footer-follow"> <ul class="social-icons"> <li> <a href="/privacy"> <i class="fas fa-user-shield"></i> Privacy Policy </a> </li> <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li> </ul> </div> <div class="page__footer-copyright">© 2021 Paul Fioravanti. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div> </footer> </div> <script src="/assets/js/main.min.js"></script> <script src="/assets/js/lunr/lunr.min.js"></script> <script src="/assets/js/lunr/lunr-store.js"></script> <script src="/assets/js/lunr/lunr-en.js"></script> <script>var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-109270947-1"]),_gaq.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}();</script> <script>var disqus_config=function(){this.page.url="https://www.paulfioravanti.com/blog/elmsthetics/",this.page.identifier="/blog/elmsthetics"};!function(){var t=document,e=t.createElement("script");e.src="https://paulfioravanti.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}();</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a> </noscript> </body> </html>